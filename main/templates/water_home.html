{% extends "base.html" %}
{% load static %}

{% block title %}Home | Water & Sanitation{% endblock %}

{% block head_extras %}
  <!-- Only the home page needs to preload videos (Hero high priority). -->
  <link rel="preload" href="{% static 'file4.mp4' %}" as="video" fetchpriority="high">
  <link rel="preload" href="{% static 'file5.mp4' %}" as="video">
  <style>
    /* ===================== THEME PALETTE ===================== */
    :root{
      --card-radius: 18px;

      /* hero glass + text */
      --hero-glass-bg: rgba(8,18,38,.30);
      --hero-glass-border: rgba(173,216,255,.20);
      --hero-head-gradient: linear-gradient(92deg,#79c9ff 0%,#37b5ff 45%,#1f9fff 90%);
      --hero-sub: #d8edff;
      --hero-shine: rgba(130,200,255,.28);
      --hero-text-shadow: 0 2px 16px rgba(0,45,120,.35);

      /* hero sizing (compact, centered) */
      --hero-min-h: 40svh;
      --hero-card-maxw: 600px;
      --hero-head-max: 44px;
      --hero-sub-max: 16px;

      /* panel glass */
      --panel-glass-bg: rgba(8,18,38,.28);
      --panel-glass-border: rgba(160,210,255,.20);
      --panel-title: #eaf6ff;
      --panel-shadow: 0 10px 28px rgba(0,20,60,.28);
      --panel-shadow-hover: 0 14px 36px rgba(0,20,60,.34);
      --panel-chip-ring: rgba(140,205,255,.6);
    }
    [data-theme="light"]{
      --hero-glass-bg: rgba(255,255,255,.36);
      --hero-glass-border: rgba(18,86,170,.18);
      --hero-head-gradient: linear-gradient(92deg,#0077ff 0%,#18b8ff 55%,#5ad1ff 100%);
      --hero-sub: #0f3b66;
      --hero-shine: rgba(0,140,255,.22);
      --hero-text-shadow: 0 2px 12px rgba(0,85,170,.18);

      --panel-glass-bg: rgba(255,255,255,.42);
      --panel-glass-border: rgba(18,86,170,.16);
      --panel-title: #0f355f;
      --panel-shadow: 0 10px 26px rgba(10,60,140,.18);
      --panel-shadow-hover: 0 14px 34px rgba(10,60,140,.24);
      --panel-chip-ring: rgba(60,165,255,.55);
    }

    /* ---- Video skeleton (avoid black blocks) ---- */
    .video-skel{
      position:absolute; inset:0; z-index:2; pointer-events:none;
      border-radius:var(--card-radius);
      background:
        radial-gradient(120% 90% at 80% 10%, rgba(0,0,0,.25), transparent 60%),
        linear-gradient(135deg, rgba(26,92,255,.30), rgba(0,178,255,.12));
      overflow:hidden; opacity:1; transition:opacity .24s ease .05s;
    }
    .video-skel::after{
      content:""; position:absolute; inset:0; transform:translateX(-100%);
      background:linear-gradient(90deg, transparent, rgba(255,255,255,.16), transparent);
      animation: sk-shine 1.2s linear infinite;
    }
    @keyframes sk-shine{ to { transform:translateX(100%); } }
    .video-skel.out{ opacity:0; }

    /* Keep video background transparent so skeleton can show through */
    .panel video{ background:transparent !important; }

    /* ===================== HERO (JS-driven show/hide) ===================== */
    .panel-hero{
      position:relative; overflow:hidden; border-radius:var(--card-radius);
      min-height: var(--hero-min-h);
    }
    .panel-hero video{
      position:absolute; inset:0; width:100%; height:100%;
      object-fit:cover; z-index:1;
    }
    .panel-hero .tint{
      position:absolute; inset:0; z-index:2; pointer-events:none;
      background:
        radial-gradient(120% 90% at 55% 60%, rgba(0,0,0,.18) 0%, transparent 60%),
        linear-gradient(180deg, rgba(0,0,0,.12), rgba(0,0,0,.04) 40%, rgba(0,0,0,.18));
      mix-blend-multiply;
    }
    [data-theme="light"] .panel-hero .tint{
      background:
        radial-gradient(120% 90% at 55% 60%, rgba(255,255,255,.16) 0%, transparent 62%),
        linear-gradient(180deg, rgba(255,255,255,.40), rgba(255,255,255,.10) 36%, rgba(0,0,0,.05));
      mix-blend-normal;
    }

    /* Centered glass card for hero headline (hidden by default) */
    .hero-copy{
      position:absolute; inset:0; z-index:3;
      display:grid; place-items:center;
      pointer-events:none;
      padding: 8px;
    }
    .hero-copy-inner{
      max-width: min(var(--hero-card-maxw), 86vw);
      width: fit-content;
      padding: clamp(10px, 1.2vw, 14px) clamp(16px, 2.2vw, 22px);
      border-radius: 16px;
      background: var(--hero-glass-bg);
      backdrop-filter: blur(10px) saturate(120%);
      -webkit-backdrop-filter: blur(10px) saturate(120%);
      border: 1px solid var(--hero-glass-border);
      box-shadow: 0 10px 30px rgba(0,20,60,.22);
      display:flex; flex-direction:column; align-items:center; gap:8px;
      text-align:center;

      /* initial hidden */
      opacity: 0;
      transform: translateY(8px) scale(.98);
      transition:
        opacity .55s cubic-bezier(.2,.6,.2,1) .10s,
        transform .55s cubic-bezier(.2,.6,.2,1) .10s,
        box-shadow .55s ease;
    }
    /* shown state controlled by JS */
    .hero-copy-inner.shown{
      opacity: 1;
      transform: translateY(0) scale(1);
      box-shadow: 0 14px 40px rgba(0,20,60,.28);
    }

    .hero-eyebrow{
      font-weight:800; letter-spacing:.12em;
      font-size: clamp(10px, .8vw, 12px);
      text-transform: uppercase;
      color: var(--hero-sub);
      filter: drop-shadow(0 0 6px var(--hero-shine));
    }
    .hero-head{
      line-height: 1.02;
      font-weight: 900;
      font-size: clamp(26px, 4.4vw, var(--hero-head-max));
      letter-spacing: -0.01em;
      background: var(--hero-head-gradient);
      -webkit-background-clip:text; background-clip:text; color: transparent;
      text-shadow: var(--hero-text-shadow);
      margin: 0;
    }
    .hero-sub{
      margin: 0;
      font-weight: 600;
      font-size: clamp(13px, 1.5vw, var(--hero-sub-max));
      color: var(--hero-sub);
      text-wrap: balance;
      text-shadow: 0 1px 8px rgba(0,0,0,.20);
    }

    /* ===================== GRID PANELS (single-layer glass pill) ===================== */

    #videoGrid .panel{
      position: relative;
      overflow: hidden;
      border-radius: var(--card-radius);
    }
    #videoGrid .panel video{
      position:absolute; inset:0; width:100%; height:100%;
      object-fit:cover; z-index:1;
    }
    #videoGrid .panel .tint{
      position:absolute; inset:0; z-index:2; pointer-events:none;
      background: linear-gradient(180deg, rgba(0,0,0,.10), rgba(0,0,0,.18));
      mix-blend-multiply;
    }
    [data-theme="light"] #videoGrid .panel .tint{
      background: linear-gradient(180deg, rgba(255,255,255,.40), rgba(0,0,0,.06));
      mix-blend-normal;
    }

    .panel .overlay{
      position:absolute; inset:0; z-index:3;
      display:grid; place-items:center;
      padding: clamp(6px, 2vw, 16px);
      pointer-events:none;
    }
    .panel .centerline{
      pointer-events:auto;
      max-width: min(720px, 88%);
      width: fit-content;
      background: var(--panel-glass-bg);
      backdrop-filter: blur(10px) saturate(120%);
      -webkit-backdrop-filter: blur(10px) saturate(120%);
      border: 1px solid var(--panel-glass-border);
      box-shadow: var(--panel-shadow);
      border-radius: 16px;
      padding: clamp(10px, 1.4vw, 14px) clamp(14px, 2.2vw, 22px);
      transition: box-shadow .35s ease, transform .35s ease;
    }
    .panel-link:hover .centerline,
    .panel:hover .centerline{
      box-shadow: var(--panel-shadow-hover);
      transform: translateY(-1px);
    }

    .panel .title-row{
      display:flex; align-items:center; gap:10px;
      font-weight:900; letter-spacing:.02em;
      font-size: clamp(16px, 2.2vw, 22px);
      color: var(--panel-title);
      text-shadow: 0 2px 10px rgba(0,0,0,.20);
      white-space: normal;
      overflow-wrap: anywhere;
      text-wrap: balance;
    }

    .water-chip{
      display:inline-flex; align-items:center; justify-content:center;
      width: 38px; height: 38px; border-radius: 999px;
      background: rgba(255,255,255,.10);
      border: 1px solid rgba(255,255,255,.22);
      box-shadow: inset 0 0 12px rgba(255,255,255,.12),
                  0 0 0 6px var(--panel-chip-ring);
      backdrop-filter: blur(6px);
    }
    .water-chip svg{ width:22px; height:22px; color: currentColor; }

    .why-section{
      position: relative;
      margin: clamp(8px, 2.5vw, 12px) 2px;
      border-radius: 22px;          /* The corners become rounded */
      overflow: hidden;             /* The child layers (video/background) are clipped by the border radius */
      box-shadow: var(--panel-shadow);
      isolation: isolate;           /* Creates a new stacking context, preventing outer layers from affecting it */
    }
  </style>
{% endblock %}

{% block content %}
  <!-- Hero (only on the homepage) -->
  <section class="hero">
    <article class="panel panel-hero" id="bannerHero">
      <video id="heroVid"
             src="{% static 'file4.mp4' %}"
             playsinline muted loop preload="auto" autoplay
             fetchpriority="high"></video>
      <div class="video-skel" aria-hidden="true"></div>
      <div class="tint"></div>

      <!-- Compact glass headline: JS toggles .shown and auto-hides after delay -->
      <div class="hero-copy" role="region" aria-label="Welcome section">
        <div class="hero-copy-inner" id="heroCopyInner">
          <div class="hero-eyebrow">WATER • HEALTH • COMMUNITY</div>
          <h1 class="hero-head">Welcome to Water &amp; Sanitation</h1>
          <p class="hero-sub">Plan safe, fun family days with clean‑water insights.</p>
        </div>
      </div>
    </article>
  </section>

  <!-- Three panels (single-layer glass over video; only GSAP chips + text inside) -->
  <section class="grid" id="videoGrid">

    <!-- Pollution Sources -->
    <a href="{% url 'pollution_sources' %}" class="panel-link">
      <article class="panel">
        <video src="{% static 'file1.mp4' %}" playsinline muted loop preload="metadata" autoplay></video>
        <div class="video-skel" aria-hidden="true"></div>
        <div class="tint"></div>
        <div class="overlay">
          <div class="centerline">
            <span class="title-row">
              <span class="water-chip" id="chip-access" aria-label="Safe Water">
                <svg viewBox="0 0 24 24">
                  <g class="rings">
                    <circle class="ring r1" cx="12" cy="12" r="8.2"/>
                    <circle class="ring r2" cx="12" cy="12" r="10"/>
                  </g>
                  <path class="drop" d="M12 4 C9 8,7 10.5,7 13a5 5 0 0 0 10 0c0-2.5-2-5-5-9z"/>
                </svg>
              </span>
              <span>POLLUTION SOURCES</span>
            </span>
          </div>
        </div>
      </article>
    </a>

    <!-- Explore Water Quality -->
    <a href="{% url 'explore_water_quality' %}" class="panel-link">
      <article class="panel">
        <video src="{% static 'file2.mp4' %}" playsinline muted loop preload="metadata" autoplay></video>
        <div class="video-skel" aria-hidden="true"></div>
        <div class="tint"></div>
        <div class="overlay">
          <div class="centerline">
            <span class="title-row">
              <span class="water-chip" id="chip-hygiene" aria-label="Hygiene">
                <svg viewBox="0 0 24 24">
                  <circle class="bubble b1" cx="8"  cy="18" r="2.3"/>
                  <circle class="bubble b2" cx="13" cy="18" r="1.5"/>
                  <circle class="bubble b3" cx="16.5" cy="18" r="1.1"/>
                </svg>
              </span>
              <span>EXPLORE WATER QUALITY</span>
            </span>
          </div>
        </div>
      </article>
    </a>

    <!-- Future & Family Safety -->
    <a href="{% url 'future_family_safety' %}" class="panel-link">
      <article class="panel">
        <video src="{% static 'file3.mp4' %}" playsinline muted loop preload="metadata" autoplay></video>
        <div class="video-skel" aria-hidden="true"></div>
        <div class="tint"></div>
        <div class="overlay">
          <div class="centerline">
            <span class="title-row">
              <span class="water-chip" id="chip-report" aria-label="Reporting">
                <svg viewBox="0 0 24 24">
                  <g class="ping"><circle class="ring r1" cx="12" cy="12" r="8.5"/></g>
                  <path class="drop" d="M12 4 C9 8,7 10.5,7 13a5 5 0 0 0 10 0c0-2.5-2-5-5-9z"/>
                </svg>
              </span>
              <span>COMMUNITY REPORTING &amp; FAMILY SAFETY</span>
            </span>
          </div>
        </div>
      </article>
    </a>

  </section>

  <!-- WHY section -->
  <section class="why-section" id="why">
    <div class="lottie-bg" aria-hidden="true">
      <!-- NOTE: WHY videos do not autoplay and are not preloaded (viewport playback) -->
      <video id="whyBgVid" src="{% static 'icecub.mp4' %}"
             playsinline muted loop preload="none"></video>
      <div class="video-skel" aria-hidden="true"></div>
    </div>
    <div class="why-main-content">
      <h2 class="why-title">WHY CLEAN WATER & SAFE SANITATION?</h2>
      <ul class="why-list">
        <li class="why-list-item">
          <span class="why-icon-bullet" aria-hidden="true">
            <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round" role="img" aria-label="Water droplet">
              <path d="M12 2.7l5 6.1c.94 1.14 1.5 2.58 1.5 4.09A6.5 6.5 0 1 1 5.5 12.9c0-1.51.56-2.95 1.5-4.09l5-6.11z"/>
            </svg>
          </span>
          Family Safety Indicator — single score for quick water safety decisions.
        </li>
        <li class="why-list-item">
          <span class="why-icon-bullet" aria-hidden="true">
            <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round" role="img" aria-label="Water droplet">
              <path d="M12 2.7l5 6.1c.94 1.14 1.5 2.58 1.5 4.09A6.5 6.5 0 1 1 5.5 12.9c0-1.51.56-2.95 1.5-4.09l5-6.11z"/>
            </svg>
          </span>
          Check key water chemistry with clear thresholds for what’s safe or unsafe.
        </li>
        <li class="why-list-item">
          <span class="why-icon-bullet" aria-hidden="true">
            <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round" role="img" aria-label="Water droplet">
              <path d="M12 2.7l5 6.1c.94 1.14 1.5 2.58 1.5 4.09A6.5 6.5 0 1 1 5.5 12.9c0-1.51.56-2.95 1.5-4.09l5-6.11z"/>
            </svg>
          </span>
          Forecast — see how conditions may change if families keep using or avoid water.
        </li>
        <li class="why-list-item">
          <span class="why-icon-bullet" aria-hidden="true">
            <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round" role="img" aria-label="Water droplet">
              <path d="M12 2.7l5 6.1c.94 1.14 1.5 2.58 1.5 4.09A6.5 6.5 0 1 1 5.5 12.9c0-1.51.56-2.95 1.5-4.09l5-6.11z"/>
            </svg>
          </span>
          Simple health guidance — from avoiding high-risk areas to keeping children safe at play.
        </li>
        <li class="why-list-item">
          <span class="why-icon-bullet" aria-hidden="true">
            <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round" role="img" aria-label="Water droplet">
              <path d="M12 2.7l5 6.1c.94 1.14 1.5 2.58 1.5 4.09A6.5 6.5 0 1 1 5.5 12.9c0-1.51.56-2.95 1.5-4.09l5-6.11z"/>
            </svg>
          </span>
          Community issue reporting—get alerts during outages & contamination.
        </li>
      </ul>
      <div class="why-note">Clean water saves lives. Safe sanitation protects communities.</div>
    </div>
  </section>
{% endblock %}

{% block page_scripts %}
<script>
  /************ Homepage exclusive: Video control + chip/WHY interaction ************/
  const gridVideos = Array.from(document.querySelectorAll("#videoGrid video"));
  const heroVideo = document.getElementById('heroVid');
  const whyVideo  = document.getElementById('whyBgVid');

  /* Skeleton handling */
  function wireSkeleton(v){
    const sk = v && v.parentElement && v.parentElement.querySelector('.video-skel');
    if(!v || !sk) return;
    const done = ()=>{ sk.classList.add('out'); v.removeEventListener('loadeddata', done); v.removeEventListener('playing', done); };
    if (v.readyState >= 2) { done(); }
    v.addEventListener('loadeddata', done);
    v.addEventListener('playing', done);
    v.addEventListener('error', done);
  }
  [heroVideo, whyVideo, ...gridVideos].forEach(v=>v && wireSkeleton(v));

  /* Static video URLs */
  const HERO_DARK_URL  = "{% static 'file4.mp4' %}";
  const HERO_LIGHT_URL = "{% static 'file5.mp4' %}";

  const manualPaused = new WeakSet();
  const tryPlay = v => v && v.play && v.play().catch(()=>{});
  const pause   = v => v && v.pause && v.pause();

  /* Visibility flags */
  let heroInView = true, gridInView = false, whyInView = false;

  /* Exclusive playback zones */
  let activeZone = 'hero';
  function applyZone(){
    if (activeZone === 'why'){
      pause(heroVideo);
      gridVideos.forEach(v=>{ manualPaused.add(v); pause(v); });
      tryPlay(whyVideo);
      return;
    }
    if (activeZone === 'grid'){
      pause(whyVideo); pause(heroVideo);
      if (gridInView){
        if (hoveredVideo){
          gridVideos.forEach(v=>{ if(v!==hoveredVideo){ manualPaused.add(v); pause(v);} });
          manualPaused.delete(hoveredVideo); tryPlay(hoveredVideo);
        }else{
          gridVideos.forEach(v=>{ manualPaused.delete(v); tryPlay(v); });
        }
      }else{ gridVideos.forEach(v=>{ manualPaused.add(v); pause(v); }); }
      return;
    }
    pause(whyVideo);
    gridVideos.forEach(v=>{ manualPaused.add(v); pause(v); });
    if (heroInView) tryPlay(heroVideo); else pause(heroVideo);
  }
  function recomputeZone(){
    const next = whyInView ? 'why' : (gridInView ? 'grid' : 'hero');
    if (next !== activeZone){ activeZone = next; applyZone(); } else { applyZone(); }
  }

  /* Intersection observers */
  const heroObserver = new IntersectionObserver((entries)=>{
    const e = entries[0]; heroInView = e.isIntersecting && e.intersectionRatio > 0.15; recomputeZone();
  }, {threshold:[0,0.15,0.5,1], rootMargin: "0px 0px -10% 0px"});
  const bannerEl = document.getElementById('bannerHero'); if (bannerEl) heroObserver.observe(bannerEl);

  const gridObserver = new IntersectionObserver((entries)=>{
    gridInView = entries[0].isIntersecting && entries[0].intersectionRatio > 0.15; recomputeZone();
  }, {threshold:[0,0.15,0.6,1], rootMargin: "0px 0px -10% 0px"});
  const gridEl = document.getElementById("videoGrid"); if (gridEl) gridObserver.observe(gridEl);

  const whyObserver = new IntersectionObserver((entries)=>{
    const e = entries[0]; whyInView = e.isIntersecting && e.intersectionRatio > 0.15; recomputeZone();
  }, {threshold:[0,0.15,0.35,0.6,1], rootMargin: "0px 0px -10% 0px"});
  const whyEl = document.getElementById('why'); if (whyEl) whyObserver.observe(whyEl);

  /* Grid hover: unicast video */
  let hoveredVideo = null;
  const panels = Array.from(document.querySelectorAll('#videoGrid .panel'));
  panels.forEach(panel=>{
    const v = panel.querySelector('video');
    panel.addEventListener('pointerenter', ()=>{ hoveredVideo = v; if (activeZone!=='grid') return;
      gridVideos.forEach(ov=>{ if(ov!==v){ manualPaused.add(ov); pause(ov); } }); manualPaused.delete(v); if(gridInView) tryPlay(v); });
    panel.addEventListener('pointerleave', ()=>{ hoveredVideo = null; if (activeZone!=='grid') return;
      gridVideos.forEach(ov=>manualPaused.delete(ov)); if(gridInView) gridVideos.forEach(tryPlay); });
  });

  gridVideos.forEach(v=>{
    const shouldResume = ()=> activeZone==='grid' && gridInView && (!hoveredVideo || hoveredVideo===v);
    ['stalled','waiting','suspend','emptied'].forEach(evt=>v.addEventListener(evt, ()=>{
      if (manualPaused.has(v)) return; if (shouldResume() && v.paused) tryPlay(v);
    }));
  });

  /* Hero keep-playing */
  if (heroVideo){
    const shouldResumeHero = ()=> activeZone==='hero' && heroInView;
    if (heroVideo.readyState>=2) tryPlay(heroVideo);
    else heroVideo.addEventListener('canplay', ()=>tryPlay(heroVideo), {once:true});
    ['pause','stalled','waiting','suspend','emptied'].forEach(evt=>heroVideo.addEventListener(evt, ()=>{
      if (shouldResumeHero() && heroVideo.paused) tryPlay(heroVideo);
    }));
  }
  /* WHY keep-playing */
  if (whyVideo){
    const shouldResumeWhy = ()=> activeZone==='why' && whyInView;
    ['stalled','waiting','suspend','emptied'].forEach(evt=>whyVideo.addEventListener(evt, ()=>{
      if (shouldResumeWhy() && whyVideo.paused) tryPlay(whyVideo);
    }));
    pause(whyVideo);
  }

  document.addEventListener("visibilitychange", ()=>{ if(!document.hidden) applyZone(); });

  /* Switch hero source by theme (base.html should dispatch `themechange`) */
  function setHeroByTheme(isLight){
    if (!heroVideo) return;
    const newSrc = isLight ? HERO_LIGHT_URL : HERO_DARK_URL;
    if (heroVideo.getAttribute("src") !== newSrc){
      heroVideo.setAttribute("src", newSrc);
      heroVideo.load();
      if (activeZone === 'hero' && heroInView) heroVideo.play().catch(()=>{});
    }
  }
  setHeroByTheme(document.documentElement.getAttribute('data-theme') === 'light');
  window.addEventListener('themechange', (e) => setHeroByTheme(e.detail.isLight));

  /* ===== Hero glass: show on enter, hide ~5–6s after leave ===== */
  const heroCopyInner = document.getElementById('heroCopyInner');
  const HIDE_DELAY_MS = 5600; // ~5–6 seconds
  let heroHideTimer = null;

  function showHeroCopy(){
    if (!heroCopyInner) return;
    clearTimeout(heroHideTimer);
    heroCopyInner.classList.add('shown');
  }
  function scheduleHideHeroCopy(){
    if (!heroCopyInner) return;
    clearTimeout(heroHideTimer);
    heroHideTimer = setTimeout(()=> heroCopyInner.classList.remove('shown'), HIDE_DELAY_MS);
  }

  if (bannerEl){
    bannerEl.addEventListener('pointerenter', showHeroCopy);
    bannerEl.addEventListener('pointerleave', scheduleHideHeroCopy);
  }

  /* GSAP chip animations + WHY bullets */
  function initWaterChips(){
    const reduced = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;
    if (reduced || !window.gsap) return;
    const centerOrigin = el => el && gsap.set(el, { transformOrigin: '50% 50%' });

    const chipA = document.querySelector('#chip-access');
    if (chipA){
      const aDrop = chipA.querySelector('.drop'); const aR1 = chipA.querySelector('.r1'); const aR2 = chipA.querySelector('.r2');
      [aDrop,aR1,aR2].forEach(centerOrigin);
      gsap.to(aDrop,{ y:-2, duration:1.6, ease:'sine.inOut', yoyo:true, repeat:-1 });
      gsap.timeline({ repeat:-1 })
        .fromTo(aR1,{ scale:0.8, opacity:0.65 },{ scale:1.35, opacity:0, duration:1.4, ease:'sine.out' })
        .fromTo(aR2,{ scale:0.7, opacity:0.55 },{ scale:1.5,  opacity:0, duration:1.6, ease:'sine.out' }, 0.15);
    }

    const chipB = document.querySelector('#chip-hygiene');
    if (chipB){
      const b1 = chipB.querySelector('.b1'), b2 = chipB.querySelector('.b2'), b3 = chipB.querySelector('.b3');
      [b1,b2,b3].forEach(centerOrigin);
      const bubble = (el, delay, dist, dur)=>{
        gsap.set(el,{ opacity:0.0, y:0, scale:0.95 });
        gsap.timeline({ repeat:-1, repeatDelay:0.25, delay })
          .to(el, { opacity:1, duration:0.2 })
          .to(el, { y:-dist, scale:1.1, opacity:0, duration:dur, ease:'sine.out' });
      };
      bubble(b1, 0.0, 6, 1.2); bubble(b2, 0.25, 7, 1.4); bubble(b3, 0.5, 8, 1.6);
    }

    const chipC = document.querySelector('#chip-report');
    if (chipC){
      const cDrop = chipC.querySelector('.drop'); const cRing = chipC.querySelector('.ping .r1');
      [cDrop,cRing].forEach(centerOrigin);
      gsap.to(cDrop, { rotation:2, duration:1.4, yoyo:true, repeat:-1, ease:'sine.inOut' });
      gsap.timeline({ repeat:-1, repeatDelay:0.4 })
        .fromTo(cRing, { scale:0.85, opacity:0.65 }, { scale:1.55, opacity:0, duration:1.1, ease:'sine.out' });
    }
  }
  function initWhyBullets(){
    const reduced = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;
    if (reduced || !window.gsap) return;
    const items = Array.from(document.querySelectorAll('.why-list-item'));
    items.forEach(item=>{
      const bullet = item.querySelector('.why-icon-bullet');
      const icon = bullet && bullet.querySelector('svg');
      if (icon){
        gsap.set(icon, { transformOrigin:'50% 50%' });
        gsap.to(icon, { y:-1.2, duration:1.6, ease:'sine.inOut', yoyo:true, repeat:-1 });
      }
    });
  }

  window.pageInit = function(){
    initWaterChips();
    initWhyBullets();
    applyZone();
  };

  /************ NEW: show loading mask when clicking the three panels ************/
  (function wirePanelMask(){
    const links = Array.from(document.querySelectorAll('#videoGrid a.panel-link'));
    function hasModifier(e){ return e.ctrlKey || e.metaKey || e.shiftKey || e.altKey || e.button === 1; }
    function isInternal(href){
      try{ const u = new URL(href, location.href); return u.origin === location.origin; }
      catch(e){ return false; }
    }
    links.forEach(a=>{
      // mouse / touch click
      a.addEventListener('click', (e)=>{
        if (e.defaultPrevented) return;
        if (hasModifier(e)) return;               // let new-tab/window behaviors pass through
        if (!isInternal(a.href)) return;          // only mask same-origin
        e.preventDefault();
        if (typeof showLoadingMask === 'function') showLoadingMask();
        setTimeout(()=>{ window.location.href = a.href; }, 900);
      });

      // keyboard activation (Enter/Space)
      a.addEventListener('keydown', (e)=>{
        const k = e.key || e.code;
        if (k === 'Enter' || k === ' ' || k === 'Spacebar'){
          if (!isInternal(a.href)) return;
          e.preventDefault();
          if (typeof showLoadingMask === 'function') showLoadingMask();
          setTimeout(()=>{ window.location.href = a.href; }, 900);
        }
      });
    });
  })();
</script>
{% endblock %}
