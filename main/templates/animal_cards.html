{% extends "base.html" %}
{% load static %}

{% block title %}For Kids â€“ Learn & Play | Water & Sanitation{% endblock %}

{% block head_extras %}
<link rel="preload" href="{% static 'fish1.mp4' %}" as="video">
<link rel="preload" href="{% static 'fish2.mp4' %}" as="video">
<link rel="preload" href="{% static 'fish3.mp4' %}" as="video">
<link rel="preload" href="{% static 'platypus_dance.gif' %}" as="image">
<link rel="preload" href="{% static 'platypus_sleep.gif' %}" as="image">
<link rel="preload" href="{% static 'win.png' %}" as="image">
<link rel="preload" href="{% static 'submarine.gif' %}" as="image">
<link rel="preload" href="{% static 'boat.gif' %}" as="image">

<!-- Toastr (success toast) -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css" />

<style>
  :root{
    --card-radius: 18px;
    --hdrH: 80px;
    --card-text: #fff;
    --card-text-shadow: 0 2px 6px rgba(0,0,0,.65);
    --title-grad: linear-gradient(90deg,#98caff 0%, #58b2ff 50%, #1f8aff 100%);
  }
  [data-theme="light"]{
    --card-text:#fff;
    --card-text-shadow: 0 2px 8px rgba(0,0,0,.6);
  }

  #ripple-layer{ display:none !important; }

  /* ===== Stage ===== */
  .kids-stage{ position:relative; min-height: calc(100svh - var(--hdrH)); }
  .aquarium,.ripples{
    position: fixed; left:0; right:0; top: var(--hdrH); bottom:0; pointer-events:none;
  }
  .aquarium{ z-index:0; opacity:0; transition:opacity .6s ease; }
  .aquarium.bg-on{ opacity:1; }
  .aquarium video{ width:100%; height:100%; object-fit:cover; filter:saturate(1.05) contrast(1.02) brightness(1.05); }
  .ripples{
    z-index:1; opacity:.75;
    background:
      radial-gradient(1000px 500px at 12% 18%, rgba(91,200,255,.30), transparent 60%),
      radial-gradient(800px 400px at 85% 28%, rgba(40,150,255,.22), transparent 60%);
    animation:rippleMove 14s linear infinite;
  }
  @keyframes rippleMove{ 0%{transform:translateY(0)} 50%{transform:translateY(2px)} 100%{transform:translateY(0)} }

  /* ===== Right dock: the single active learn card ===== */
  .card-dock{
    position: fixed;
    right: clamp(12px, 3vw, 28px);
    top: calc(var(--hdrH) + clamp(12px, 1.5vw, 18px));
    bottom: clamp(12px, 2vw, 20px);
    width: min(560px, 44vw);
    z-index: 2;
    display: grid;
    align-items: center;
    justify-items: stretch;
  }

  .sleepy-wrap{
    position: absolute; right: 0;
    top: clamp(-120px, -8vw, -84px);
    width: min(560px, 44vw);
    display: grid; justify-items: end;
    pointer-events: none; z-index: 3;
  }
  .sleepy-platypus{ width: min(420px, 36vw); transform: scale(1.08); image-rendering: -webkit-optimize-contrast; filter: drop-shadow(0 8px 22px rgba(0,0,0,.38)); }
  @media (max-width: 980px){
    .sleepy-wrap{ top: clamp(-80px, -10vw, -60px); }
    .sleepy-platypus{ width: min(320px, 52vw); transform: scale(1.04); }
  }

  /* Only .cards > .card are learn cards */
  .cards{ display: contents; }
  .cards > .card{ display:none; }
  .cards > .card.active{ display:flex; flex-direction: column; }

  .cards > .card{
    background: linear-gradient(180deg, rgba(5,12,24,.80), rgba(8,18,36,.74)), rgba(8,18,38,.42);
    border:1px solid rgba(160,210,255,.30);
    border-radius:14px;
    padding: clamp(16px, 2vw, 22px);
    backdrop-filter: blur(12px) saturate(130%);
    color: var(--card-text);
    text-shadow: var(--card-text-shadow);
    min-height: 240px;
    box-shadow: 0 14px 34px rgba(0,20,60,.48);
    position:relative; overflow:hidden;
  }
  .cards > .card h3{
    font-weight: 900; font-size: clamp(20px, 2.4vw, 26px); margin: 0 0 10px; letter-spacing: .2px;
    background: var(--title-grad); -webkit-background-clip: text; background-clip:text; color: transparent; -webkit-text-fill-color: transparent;
    text-shadow: 0 1px 0 rgba(0,0,0,.45), 0 0 14px rgba(40,120,220,.35);
  }
  [data-theme="light"] .cards > .card h3{
    background: none !important; -webkit-background-clip: initial; background-clip: initial; -webkit-text-fill-color: initial; color: #fff !important; text-shadow: 0 2px 8px rgba(0,0,0,.6);
  }
  .cards > .card > *{ min-width:0; }
  .qa-wrap{ width:100%; display:grid; }
  .qa-wrap > p, .details p{ margin:0 0 12px; font-size: clamp(16px, 1.2vw, 18px); line-height:1.6; overflow-wrap:anywhere; }
  .details{ max-height: none !important; opacity: 0; transition: opacity .25s ease; width: 100%; }
  .cards > .card.revealed .details{ opacity: 1; }

  .hud{ position:absolute; top:12px; right:12px; z-index:3; display:grid; align-items:center; justify-items:end; pointer-events:none; }
  .hud > *{ grid-area: 1 / 1; }
  .read-timer{ height:28px; padding:0 10px; border-radius:999px; display:inline-flex; align-items:center; gap:6px; font-size:12px; font-weight:800; color:#0a2a6b;
    background:linear-gradient(180deg,#d7fbe8,#b5f1d4); border:1px solid rgba(24,192,109,.6); box-shadow: 0 2px 10px rgba(24,192,109,.25), inset 0 1px 0 #fff;
    opacity:0; transform:translateY(-6px); transition:opacity .2s ease, transform .2s ease; }
  .cards > .card.reading .read-timer{ opacity:1; transform:translateY(0); }
  .read-dot{ width:8px; height:8px; border-radius:50%; background:#18c06d; box-shadow:0 0 0 3px rgba(24,192,109,.25); }
  .check-badge{ width:28px; height:28px; border-radius:999px; display:grid; place-items:center; font-size:18px; line-height:1; background:#18c06d; color:#fff; border:none;
    box-shadow: 0 4px 16px rgba(24,192,109,.45), inset 0 -2px 0 rgba(0,0,0,.18); transform:scale(.82); opacity:0; transition:opacity .2s ease, transform .2s ease; }
  .cards > .card.done .check-badge{ opacity:1; transform:scale(1); }

  .hint{ position:absolute; right:12px; bottom:12px; background:rgba(255,255,255,.16); border:1px dashed rgb(255,255,255);
    font-size:12px; padding:4px 8px; border-radius:999px; color:#fff; text-shadow:0 1px 0 rgba(255,254,254,.45); pointer-events:none; }

  /* ===== Next / Finish ===== */
  .next-btn{
    position: fixed; right: calc(clamp(12px, 3vw, 28px) + min(560px, 44vw) + 10px);
    top: 50%; transform: translateY(-50%); z-index: 2; width: 54px; height: 54px; border-radius: 999px;
    display: grid; place-items: center; background: linear-gradient(180deg,#e8f5ff,#cfe9ff);
    border: 1px solid rgba(120,170,255,.6); box-shadow: 0 8px 26px rgba(30,90,200,.35);
    color:#0a2a6b; font-size: 22px; cursor: pointer; opacity: 0; pointer-events: none; transition: opacity .2s ease, transform .2s ease;
  }
  .next-btn.show{ opacity: 1; pointer-events: auto; }
  .next-btn:active{ transform: translateY(-50%) scale(.96); }
  @media (max-width:980px){
    .next-btn{ right: clamp(12px, 3vw, 28px); top:auto; bottom: calc(12px + env(safe-area-inset-bottom)); transform:none; }
    .next-btn:active{ transform: scale(.96); }
  }

  .finish-btn{
    position: fixed; right: calc(clamp(12px, 3vw, 28px) + min(560px, 44vw) + 10px); top: 50%; transform: translateY(-50%);
    z-index: 2; padding: 12px 18px; border-radius: 999px; font-weight: 900; letter-spacing: .02em; font-size: 14px; color: #6b4a00;
    background: linear-gradient(180deg,#fff3b0,#ffd069); border: 1px solid rgba(160,120,20,.6);
    box-shadow: 0 10px 26px rgba(180,140,30,.45), inset 0 1px 0 #fff; cursor: pointer; opacity: 0; pointer-events: none; transform-origin: center;
    transition: opacity .2s ease, transform .2s ease; overflow: hidden;
  }
  .finish-btn.show{ opacity:1; pointer-events:auto; }
  .finish-btn:hover{ transform: translateY(-50%) scale(1.03); }
  .finish-btn::after{
    content:""; position:absolute; top:-120%; left:-60%; width:45%; height:320%;
    background: linear-gradient(90deg, rgba(255,255,255,0), rgba(255,255,255,.65), rgba(255,255,255,0));
    transform: rotate(25deg); animation: sheen 2.2s linear infinite;
  }
  @keyframes sheen{ 0%{ left:-60%; } 100%{ left: 140%; } }

  @media (prefers-reduced-motion: reduce){
    .aquarium, .ripples{ transition:none; animation:none; }
    .aquarium video{ filter:none; }
    .finish-btn::after{ animation: none; }
  }

  .cards > .card.fixed{ height: var(--fixedH); }
  .cards > .card.locked{ pointer-events:none; }

  /* ===== Progress dock ===== */
  .progress-dock{
    position: fixed; left: clamp(12px, 3vw, 28px);
    top: calc(var(--hdrH) + clamp(12px, 1.5vw, 18px));
    z-index: 2; display: grid; gap: 14px; width: min(340px, 40vw); align-content: start;
  }
  .ring{
    --p: 0; --track: rgba(255,255,255,.14); --fillA: #40dd75; --fillB: #3ee6ff;
    width: 140px; height: 140px; border-radius: 50%; position: relative;
    background: conic-gradient(var(--fillA), var(--fillB)) 0/0 0 no-repeat,
                conic-gradient(var(--fillB) calc(var(--p)*1turn), var(--track) 0);
    box-shadow: 0 10px 30px rgba(30,140,255,.35), 0 0 0 1px rgba(160,210,255,.25) inset;
    transition: background .6s ease;
  }
  .ring::before{ content:""; position:absolute; inset:8px; border-radius:50%; background: rgba(7,15,30,.92); box-shadow: inset 0 0 0 1px rgba(160,210,255,.25); }
  .ring::after{ content:""; position:absolute; inset:-6px; border-radius:50%;
    background: radial-gradient(closest-side, rgba(64,221,117,.28), transparent),
                radial-gradient(closest-side, rgba(62,230,255,.25), transparent);
    filter: blur(8px); opacity:.7; pointer-events:none; }
  .ring-core{ position:absolute; inset:0; display:grid; place-items:center; text-align:center; }
  .ring-count{ font-weight:900; font-size: 28px; letter-spacing:.4px; color:#eaf7ff; }
  .ring-caption{ font-size:12px; opacity:.85; text-transform: uppercase; letter-spacing:.12em; color:#dff3ff; }

  .segbar{ display: grid; grid-auto-flow: column; gap: 6px; align-items: center;
    background: rgba(8,18,38,.42); border:1px solid rgba(160,210,255,.30); box-shadow: 0 8px 22px rgba(0,20,60,.28);
    padding: 10px 12px; border-radius: 12px; }
  .seg{ height: 8px; width: 100%; border-radius: 6px; background: rgba(255,255,255,.18); }
  .seg.on{ background: linear-gradient(90deg, #40dd75, #3ee6ff); box-shadow: 0 0 16px rgba(64,221,117,.55); }

  .progress-toast{ min-height: 22px; width: max-content; font-size: 12px; font-weight:800; color:#0a2a6b;
    background: linear-gradient(180deg,#fffbd1,#ffe27a); border:1px solid rgba(180,160,60,.6);
    border-radius: 999px; padding: 4px 10px; opacity: 0; transform: translateY(-6px);
    transition: opacity .25s ease, transform .25s ease; box-shadow: 0 8px 18px rgba(180,160,60,.35); }
  .progress-toast.show{ opacity:1; transform: translateY(0); }


/* Enlarge Toastr popups */
#toast-container > .toast {
  min-width: 250px;     /* prevent too narrow popups */
  border-radius: 10px;  /* rounded corners */
}

#toast-container > .toast-success {
  font-size: 15px;
}


  /* ===== Celebration overlay ===== */
  .celebration{ position: fixed; inset: var(--hdrH) 0 0 0; display: none; align-items: center; justify-content: center; z-index: 999;
    background: radial-gradient(1200px 600px at 20% 10%, rgba(140,200,255,.15), transparent 55%),
                radial-gradient(1000px 500px at 80% 20%, rgba(60,170,255,.12), transparent 60%),
                rgba(10,18,34,.35);
    backdrop-filter: blur(16px) saturate(140%); -webkit-backdrop-filter: blur(16px) saturate(140%); opacity: 0; }
  .celebration.show{ display:flex; }
  .celebration .glass-card{ position:relative; padding: 0; border-radius: 0; background: none; border: 0; box-shadow: none; transform: translateY(8px) scale(.985); opacity: 0; text-align: center; }
  .media{ position:relative; width: min(86vw, 1100px); aspect-ratio: 16 / 9; display: block; }
  .halo-behind{ position:absolute; left:50%; top:50%; transform: translate(-50%, -50%); width: min(60%, 700px); aspect-ratio: 1 / 1; border-radius: 50%;
    z-index: 1; pointer-events:none; mix-blend-mode: screen;
    background: radial-gradient(closest-side, rgba(255,240,170,.75) 0%, rgba(255,225,120,.45) 35%, rgba(255,210,100,.28) 55%, rgba(255,195,80,.18) 70%, rgba(255,180,60,0) 85%);
    filter: blur(18px) brightness(1.2) saturate(1.1); }
  .media .win-label{ position:absolute; inset:0; width:100%; height:100%; object-fit: contain; image-rendering: -webkit-optimize-contrast; filter: drop-shadow(0 10px 22px rgba(0,0,0,.5)); z-index: 3; pointer-events:none; }
  .media .platypus{ position:absolute; left:50%; top:50%; transform: translate(-50%, -50%); height: min(62%, 520px); width: auto; image-rendering: -webkit-optimize-contrast; filter: drop-shadow(0 12px 28px rgba(0,0,0,.45)); z-index: 2; }

  /* ===== Vessels ===== */
  .vessels-layer{ position: fixed; inset: var(--hdrH) 0 0 0; z-index: 2; pointer-events: none; overflow: visible; }
  .vessel{ position:absolute; top: calc(58%); transform: translateX(110vw) scale(1.08); opacity: 0; will-change: transform, opacity; image-rendering: -webkit-optimize-contrast; filter: drop-shadow(0 8px 18px rgba(0,0,0,.35)); }
  .vessel.sub{ width: min(34vw, 460px); } .vessel.boat{ width: min(30vw, 420px); }
  .vessel.run{ opacity: 1; animation: sail-left 9s linear forwards; }
  @keyframes sail-left{ 0%{ transform: translateX(110vw) scale(1.08); } 100%{ transform: translateX(-130vw) scale(1.08); } }

  @keyframes celebIn { from { opacity: 0; } to { opacity: 1; } }
  @keyframes cardIn  { 0%{ opacity:0; transform: translateY(12px) scale(.975); } 100%{ opacity:1; transform: translateY(0) scale(1);} }
  @keyframes celebOut{ from { opacity:  1; } to { opacity: 0; } }
  @keyframes cardOut { 0%{ opacity:1; transform: translateY(0) scale(1);} 100%{ opacity:0; transform: translateY(10px) scale(.985);} }
  .celebration.anim-in{ animation: celebIn 600ms ease forwards; }
  .celebration.anim-in .glass-card{ animation: cardIn 700ms cubic-bezier(.2,.9,.2,1.0) 80ms forwards; }
  .celebration.anim-out{ animation: celebOut 600ms ease forwards; }
  .celebration.anim-out .glass-card{ animation: cardOut 500ms ease forwards; }

  @media (max-width: 560px){
    .media{ width: min(94vw, 560px); }
    .media .platypus{ height: min(64%, 360px); }
    .finish-btn{ right: clamp(12px, 3vw, 28px); top:auto; bottom: calc(12px + env(safe-area-inset-bottom)); transform:none; }
    .vessel.sub{ width: min(56vw, 420px); }
    .vessel.boat{ width: min(52vw, 400px); }
  }

 /* ===== Kids Collection grid (Fallout-style mini cards) ===== */
.kids-collection{
  padding: clamp(18px,3vw,26px);
  position: relative;
  z-index: 3;
}

/* Frosted glass panel behind the entire collection section */
.kids-collection .glass-backdrop{
  position: absolute;
  inset: 0;
  border-radius: 16px;
  background:
    linear-gradient(180deg, rgba(8,18,38,.60), rgba(8,18,38,.38)),
    rgba(10,18,34,.35);
  border: 1px solid rgba(160,210,255,.28);
  box-shadow:
    inset 0 1px 0 rgba(255,255,255,.12),
    0 10px 30px rgba(0,20,60,.35);
  backdrop-filter: blur(12px) saturate(135%);
  -webkit-backdrop-filter: blur(12px) saturate(135%);
  pointer-events: none; /* do not block clicks */
  z-index: 0;
}
/* Bring content above the glass */
.kids-collection > .collect-title,
.kids-collection > .collect-grid{
  position: relative;
  z-index: 1;
}

.kids-collection .collect-title{
  margin: -10px 0 50px;
  font-weight: 900;
  font-size: clamp(18px,2.2vw,22px);
  color:#eaf7ff;
  text-shadow: 0 2px 10px rgba(0,0,0,.4);
}
.kids-collection .collect-grid{
  display:grid;
  grid-template-columns: repeat(3, minmax(0,1fr));
  gap: 16px;
}
.kids-collection .glass-backdrop {
  position: absolute;
  inset: 0;
  transform: scale(1.05, 1.1);
  transform-origin: center;
}

@media (max-width: 860px){
  .kids-collection .collect-grid{ grid-template-columns: repeat(2, minmax(0,1fr)); }
}
@media (max-width: 560px){
  .kids-collection .collect-grid{ grid-template-columns: 1fr; }
}

/* ===== Collection countdown banner (fixed above the right card dock) ===== */
.collection-countdown{
  position: fixed;
  right: clamp(12px, 3vw, 28px);
  top: calc(var(--hdrH) + 6px); /* slightly above the right card dock */
  width: min(560px, 44vw);
  z-index: 3;
  pointer-events: none; /* purely informational */
}
.collection-countdown .cd-wrap{
  display: grid;
  grid-template-columns: 1fr auto;
  align-items: center;
  gap: 8px 10px;
  padding: 8px 12px 10px;
  border-radius: 12px;
  background: linear-gradient(180deg, rgba(8,18,38,.68), rgba(8,18,38,.42));
  border: 1px solid rgba(160,210,255,.30);
  backdrop-filter: blur(10px) saturate(135%);
  -webkit-backdrop-filter: blur(10px) saturate(135%);
  box-shadow: 0 10px 24px rgba(0,20,60,.35), inset 0 1px 0 rgba(255,255,255,.12);
  color: #eaf7ff;
  text-shadow: 0 1px 0 rgba(0,0,0,.45);
}
.cd-label{
  font-size: 12px;
  font-weight: 900;
  text-transform: uppercase;
  letter-spacing: .14em;
  opacity: .92;
}
.cd-eta{
  font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
  font-weight: 900;
  font-size: 14px;
  background: linear-gradient(90deg, #aee6ff, #eaf6ff);
  -webkit-background-clip: text; background-clip:text;
  -webkit-text-fill-color: transparent; color: transparent;
  text-shadow: 0 0 10px rgba(80,160,255,.35);
}
.cd-date{
  grid-column: 1 / -1;
  font-size: 12px;
  opacity: .85;
}
.cd-track{
  grid-column: 1 / -1;
  height: 6px; border-radius: 999px;
  background: rgba(255,255,255,.14);
  box-shadow: inset 0 1px 0 rgba(255,255,255,.12);
  overflow: hidden;
}
.cd-fill{
  display: block; height: 100%; width: 0%;
  background: linear-gradient(90deg, #40dd75, #3ee6ff);
  box-shadow: 0 0 12px rgba(64,221,117,.45);
  transition: width .6s ease;
}

/* ===== Fallout-style mini cards (GIF-friendly + pale-blue theme) ===== */
.f76{
  /* Palette (as provided) */
  --color-yellow:#ddb724; --color-off-black:#352d2a; --color-white:#e3dfc6; --color-bone:#e7e4d5;
  --color-main:#8cd1b3; --color-main-lighten:#afdbbf; --color-main-lighten2:#b2efcd; --color-main-dark:#84a782;
  --color-backing-top:#4e79ad; --color-backing-light1:#b6cff3; --color-backing-light2:#c8dcf1; --color-backing-light3:#88b4ed; --color-backing-light4:#2f5c8c;

  /* Layout tokens */
  --meta-gap: 3.2rem;          /* reserved space above .desc for badges */

  /* Unified geometry */
  --card-radius: 9px;          /* keep corners in sync */
  --card-border: .5rem;        /* equals .card-face border thickness */
  --frame: var(--color-bone);  /* border color to unify front/back */

  /* Bump geometry */
  --bump-size:  6.8rem;
  --bump-offset: 1.6rem;       /* matches .bump { left/top:-1.6rem } */

  /* Sheen animation (contained, no overflow) */
  --sheen-speed: 4.6s;
}

.f76 .card-scene{ width:100%; aspect-ratio:36/46; perspective:900px; }
.f76 .card{
  height:100%; width:100%; position:relative;
  transform-style:preserve-3d; transform:rotateY(180deg);
  cursor:pointer;
}
.f76 .card.card--flipped{ animation:f76Flip .28s linear forwards; }
.f76 .card.card--unflip{ animation:f76Unflip .28s linear forwards; }
@keyframes f76Flip{
  0%{transform:rotateZ(0) rotateY(180deg);}
  50%{transform:rotateZ(-10deg) rotateY(90deg);}
  100%{transform:rotateZ(0) rotateY(0);}
}
@keyframes f76Unflip{
  0%{transform:rotateZ(0) rotateY(0);}
  50%{transform:rotateZ(-10deg) rotateY(90deg);}
  100%{transform:rotateZ(0) rotateY(180deg);}
}

/* === Unified card face rules === */
.f76 .card-face {
  position: absolute;
  inset: 0;                  /* front/back must cover the full card */
  backface-visibility: hidden;
  border-radius: var(--card-radius);
  border: var(--card-border) solid var(--frame);
  box-shadow: 0 0 3px 2px #4e4e4e;
  overflow: hidden;          /* clip inner content to rounded corners */
  height: 100%;
}

/* === Card back (fix white bottom) === */
.f76 .card-backing {
  transform: rotateY(180deg);
  display: flex;
  flex-direction: column;
  position: absolute; inset: 0;
  background: #90c6ff;
  border-radius: var(--card-radius);
}

/* top banner and back-main no longer control card height */
.f76 .card-backing .top-banner {
  height: 5.6rem;
  background: var(--color-backing-top);
}

.f76 .card-backing .back-main {
  flex: 1;
  display: flex; flex-direction: column;
  justify-content: center; align-items: center;
  padding: 10px;
  background: linear-gradient(
    135deg,
    var(--color-backing-light1) 0 25%,
    var(--color-backing-light2) 25% 50%,
    var(--color-backing-light3) 50% 75%,
    var(--color-backing-light4) 75% 100%
  );
}

.f76 .card-backing.theme-blue { background: #90c6ff; }
.f76 .flip-hint{ margin-top:12px; font-size:14px; color:#15365c; font-weight:800; }

.f76 .vault-tec{ position:relative; width:70%; height:80px; margin:8px auto; }
.f76 .vault-tec .center{ width:64px; height:64px; border-radius:50%; border:8px solid var(--color-bone); margin:auto; }
.f76 .vault-tec .lines{ position:absolute; inset:0; display:grid; grid-template-columns:40% 1fr 40%; }
.f76 .vault-tec .line{ display:flex; flex-direction:column; justify-content:center; gap:10px; }
.f76 .vault-tec .line-inner{ height:10px; width:60%; background:var(--color-bone); position:relative; }
.f76 .vault-tec .line--left .line-inner::before{ content:""; position:absolute; left:-5%; width:10%; height:100%; background:var(--color-bone); border-radius:50% 0 0 50%; }
.f76 .vault-tec .line--right{ grid-column:3; }
.f76 .vault-tec .line--right .line-inner::before{ content:""; position:absolute; right:-5%; width:10%; height:100%; background:var(--color-bone); border-radius:0 50% 50% 0; }

/* ---------- front (revealed) layout ---------- */
.f76 .card-front{
  display:flex; flex-direction:column;
  background:var(--color-bone); /* default; theme-blue overrides below */
  position: relative;           /* anchors sheen overlay */
  isolation: isolate;           /* keeps overlay blending contained */
}
.f76 .card-front h1{
  position:relative; margin:0;
  font-size:1.4rem; line-height: 4.6rem;
  color:#fff; background:var(--color-main-dark);
  text-align:center; padding-left:3.2rem; /* room for the bump */
  border-top-right-radius:1rem;
}

/* === Numeric bump: allowed to protrude beyond the card === */
.f76 .bump{
  position:absolute; left:-1.6rem; top:-1.6rem;
  height:var(--bump-size); width:var(--bump-size);
  border: var(--card-border) solid var(--frame);
  border-radius:.8rem;
  /* No all-around shadow, weâ€™ll add an outer-only shadow with ::after */
  box-shadow: none;
  z-index: 3; /* above sheen overlays */
}
.f76 .bump .outer{
  position:absolute; inset:0; padding:.3rem;
  background:var(--color-main-dark); border-radius:.3rem; display:block;
}
.f76 .bump .inner{
  display:block; height:100%; width:100%;
  background:#fff; border-radius:3px; text-align:center;
  font-weight:900; font-size:1.6rem; line-height:5.2rem; color:#4e4943;
}
/* Outer-only soft shadow so it doesn't fight the frame */
.f76 .bump::after{
  content:""; position:absolute; inset:0; border-radius: inherit; pointer-events:none;
  /* shadow only outside (no inner overlap with the frame) */
  box-shadow: 0 6px 14px rgba(0,0,0,.35), 0 0 6px rgba(0,0,0,.25);
  z-index: -1;
}

/* Image well: keep the GIF above decorative ring */
.f76 .main-pane{ 
  position:relative; 
  overflow:hidden; 
  padding:0 1.2rem; 
  display:flex;                
  flex: 1 1 auto;        
}
.f76 .main-pane::before{
  content:""; position:absolute; top:-42rem; left:-32rem; height:69.5rem; width:100rem; border-radius:50%;
  background:repeating-conic-gradient(from 90deg,
    var(--color-main-lighten2) 0 25deg, var(--color-bone) 0 35deg,
    var(--color-main) 0 40deg, var(--color-bone) 0 47deg,
    var(--color-main-lighten) 0 50deg, var(--color-bone) 0 55deg,
    var(--color-main) 0 127deg, var(--color-bone) 0 132deg,
    var(--color-main-lighten) 0 135deg, var(--color-bone) 0 140deg,
    var(--color-main) 0 145deg, var(--color-bone) 0 155deg,
    var(--color-main-lighten2) 0 360deg);
  z-index:0;
}
/* Whale GIF: bigger and perfectly centered */
.f76 img.slugger{
  display: block;
  position: relative;
  left: 50%;
  transform: translateX(-50%);  /* precise horizontal centering */
  margin-top: 5rem;
  width: clamp(260px, 110%, 560px);
  max-width: none;
  height: auto;
  image-rendering: -webkit-optimize-contrast;
  image-rendering: pixelated;
}

/* Description + badges (badges ABOVE this panel) */
.f76 .desc{
  align-self:end; min-height:28%;
  margin-top: var(--meta-gap);
  padding: 1.2rem 1.4rem 1.8rem;
  text-align:center; display:flex; align-items:center; justify-content:center;
  background:linear-gradient(to bottom, #b8cbad, #ede8d4 18% 70%, #a5bc9e);
  border:2px solid var(--color-off-black); border-radius:12px; position:relative;
}
.f76 .desc p{ margin:0; font-size:1.2rem; color:var(--color-off-black); }

.f76 .special{
  position:absolute;
  bottom: calc(100% + .4rem);  /* place above .desc */
  left: .6rem;
  height:3.2rem; padding:.25rem .55rem;
  background:var(--color-main); border:.2rem solid #fff; color:var(--color-off-black);
  font-size:2.8rem; line-height:130%; border-radius:.35rem; transform:skew(-7deg,-10deg);
  box-shadow:0 3px 10px rgba(0,0,0,.15);
  z-index:2;
  display: grid; place-items: center; line-height:1; isolation: isolate;
}
.f76 .level{
  position:absolute;
  bottom: calc(100% + .4rem);
  right: .2rem;
  height:2.6rem; display:inline-block; background:var(--color-main-dark); color:var(--color-off-black);
  font-size:1.8rem; padding:2px 6px 2px 0;
  border-top:2px solid var(--color-off-black); border-bottom:2px solid var(--color-off-black);
  border-left:2px solid var(--color-off-black); border-right:1px solid #6c6c6c; border-radius:6px;
  box-shadow:0 3px 10px rgba(0,0,0,.12);
  z-index:2;
}
.f76 .level .star, .f76 .level .star::before, .f76 .level .star::after{
  border-color:transparent var(--color-off-black) transparent transparent; border-width:1rem .5rem 1rem 0; border-style:solid;
}
.f76 .level .star{ display:inline-block; width:1.5rem; transform:rotate(270deg); margin-top:.4rem; margin-left:.8rem; position:relative; }
.f76 .level .star::before{ content:""; position:absolute; left:.9rem; top:-.9rem; transform:rotate(68deg); }
.f76 .level .star::after{ content:""; position:absolute; left:.9rem; top:-1.1rem; transform:rotate(-68deg); }
.f76 .level .star.current-level, .f76 .level .star.current-level::before, .f76 .level .star.current-level::after{ border-right-color:#fff; }

/* Allow 3D card and faces to paint outside for the bump.
   NOTE: the sheen itself is contained by its own animation rules below. */
.f76 .card, .f76 .card-face{ overflow: visible; }

/* ---------- Pale blue theme (apply .theme-blue on .card-front) ---------- */
.f76 .card-front.theme-blue{ background:#e8f3ff; }
.f76 .card-front.theme-blue h1{ background:#78aeea; color:#eaf6ff; }
.f76 .card-front.theme-blue .bump{ border-color:#cfe2ff; }
.f76 .card-front.theme-blue .bump .outer{ background:#78aeea; }
.f76 .card-front.theme-blue .bump .inner{ background:#eaf6ff; color:#2a3a4a; }
.f76 .card-front.theme-blue .main-pane::before{ display:none; } /* cleaner */
.f76 .card-front.theme-blue .desc{
  background:linear-gradient(to bottom, #d7eaff, #c2defd 18% 70%, #cfe3ff);
  border-color:#2a3a4a;
}
.f76 .card-front.theme-blue .special{ background:#a9c9ff; color:#243447; border-color:#fff; box-shadow:0 3px 10px rgba(111,166,230,.35); }
.f76 .card-front.theme-blue .level{ background:#6fa6e6; color:#243447; box-shadow:0 3px 10px rgba(111,166,230,.25); }
/* keep the face frame color unified */
.f76 .card-front.theme-blue.card-face{ border-color:var(--frame); }

/* ---------- Small-screen tweaks ---------- */
@media (max-width:960px){
  .f76{ --meta-gap: 2.6rem; }
  .f76 .card-front h1{ font-size:2.1rem; padding-left:3rem; }
  .f76 .bump{ height:6rem; width:6rem; border-width:3px; left:-1.2rem; top:-1.2rem; }
  .f76 .bump .inner{ font-size:3.2rem; line-height:5.4rem; }
  .f76 img.slugger{ max-width:95%; margin:1.4rem auto 0; }
  .f76 .desc{ padding:1rem 1.2rem 1.6rem; }
  .f76 .desc p{ font-size:1.5rem; }
  .f76 .special{ bottom: calc(100% + .35rem); height:2.8rem; font-size:2.4rem; }
  .f76 .level{   bottom: calc(100% + .35rem); height:2.4rem; font-size:1.6rem; }
}

/* --- Metallic gloss overlay (contained) ---
   IMPORTANT: We keep the overlay inside the card by:
   1) inset: 0 (no oversized box),
   2) animating background-position instead of moving the element,
   3) no blur filter (blur can render outside clip on some browsers),
   4) z-index lower than the bump so bump stays visually on top. */
.f76 .card-front.theme-blue{
  box-shadow:
    inset 0 1px 0 rgba(255,255,255,.38),
    inset 0 -1px 0 rgba(8,24,44,.12),
    inset 1px 0 0 rgba(255,255,255,.22),
    inset -1px 0 0 rgba(8,24,44,.10);
}
.f76 .card-front.theme-blue::before{
  content:"";
  position:absolute; inset:0; border-radius: inherit; pointer-events: none;
  background:
    linear-gradient(180deg,
      rgba(255,255,255,.35) 0%,
      rgba(255,255,255,.12) 14%,
      rgba(255,255,255,.05) 48%,
      rgba(255,255,255,.16) 64%,
      rgba(255,255,255,0) 100%),
    repeating-linear-gradient(-12deg,
      rgba(255,255,255,.10) 0 1px,
      rgba(255,255,255,0) 1px 6px);
  mix-blend-mode: screen;
  opacity: .8;
  z-index: 2; /* beneath the bump */
}
.f76 .card-front.theme-blue::after{
  content:"";
  position:absolute; inset:0; border-radius: inherit; pointer-events: none;
  /* A narrow moving highlight; fully contained within the rounded card */
  background-image: linear-gradient(
    100deg,
    rgba(255,255,255,0) 30%,
    rgba(255,255,255,.85) 50%,
    rgba(255,255,255,0) 70%
  );
  background-repeat: no-repeat;
  background-size: 220% 100%;     /* allow travel without oversizing the box */
  background-position: -120% 0%;   /* start off to the left */
  mix-blend-mode: screen;
  animation: f76SheenBG var(--sheen-speed) linear infinite;
  opacity:.65;
  z-index: 2; /* beneath the bump */
}
/* Move the gradient across the card without moving the element itself */
@keyframes f76SheenBG{
  0%   { background-position: -120% 0%; }
  100% { background-position: 120% 0%; }
}
@media (prefers-reduced-motion: reduce){
  .f76 .card-front.theme-blue::after{ animation: none; opacity:.4; }
}

/* ===== Star visuals (gold glow for current level) ===== */
.f76{ --gold: #ffd34d; --gold-strong: #ffbf26; --gold-soft: rgba(255,220,110,.95); --gold-halo: rgba(255, 255, 60, 0.279); }
.f76 .level .star, .f76 .level .star::before, .f76 .level .star::after{ border-right-color: #708199; }
.f76 .level .star.current-level, .f76 .level .star.current-level::before, .f76 .level .star.current-level::after{ border-right-color: var(--gold) !important; }
.f76 .level .star.current-level{
  filter:
    drop-shadow(0 0 2px  var(--gold-soft))
    drop-shadow(0 0 6px  var(--gold-halo))
    drop-shadow(0 0 14px rgba(255,150,0,.45));
  animation: goldTwinkle 1.6s ease-in-out infinite alternate;
}
@keyframes goldTwinkle{
  0%{ filter: drop-shadow(0 0 2px var(--gold-soft)) drop-shadow(0 0 6px var(--gold-halo)) drop-shadow(0 0 14px rgba(255,150,0,.45)); }
  100%{ filter: drop-shadow(0 0 3px var(--gold-soft)) drop-shadow(0 0 10px var(--gold-halo)) drop-shadow(0 0 22px rgba(255,150,0,.55)); }
}
@media (prefers-reduced-motion: reduce){
  .f76 .level .star.current-level{ animation: none; }
}

/* ===== Badge text only: thicker, stroke, clip gradients into text ===== */
.f76 .card-front .special .special__txt{
  font-weight: 1000;
  transform: translateY(-0.12rem);
  color: transparent; -webkit-text-fill-color: transparent;
  background-clip: text; -webkit-background-clip: text;
  -webkit-text-stroke: 1px rgba(0,0,0,.18);
  text-shadow: 0 1px 0 rgba(255,255,255,.45);
}

/* ===== Grade colorways (applied to .special__txt only) ===== */
.f76 .card-front .special[data-grade="SS"]{ overflow: visible; }
.f76 .card-front .special[data-grade="SS"] .special__txt{
  background-image: linear-gradient(270deg,#fff200,#f96c01,#f90101,#01f1f9,#2301f9,#c7a4ff,#00ff1a,#fff200);
  background-size: 600% 100%;
  animation: diamondShine 2s linear infinite;
  text-shadow: 0 0 12px rgba(255,255,255,.9), 0 0 26px rgba(160,210,255,.7), 0 0 40px rgba(120,200,255,.5);
}
.f76 .card-front .special[data-grade="SS"]::after{
  content: ""; position: absolute; inset: -3px; border-radius: .4rem; pointer-events: none;
  background: radial-gradient(closest-side, rgba(255,255,255,.65), transparent 70%), conic-gradient(from 0deg, rgba(255,255,255,.4), rgba(150,210,255,.28), rgba(255,255,255,.4));
  mix-blend-mode: screen; filter: blur(5px); opacity: .9; animation: ssPulse 1.6s ease-in-out infinite alternate; z-index: -1;
}
@keyframes diamondShine{ from{ background-position: 0% 50%; } to{ background-position: 100% 50%; } }
@keyframes ssPulse{ from{ opacity:.7; transform:scale(1);} to{ opacity:1; transform:scale(1.05);} }

/* S: gold */
.f76 .card-front .special[data-grade="S"] .special__txt{
  background-image: linear-gradient(135deg,#fff2b6,#ffd24d 40%,#b8870d 60%,#ffe07a);
}
/* A: deep red metallic */
.f76 .card-front .special[data-grade="A"] .special__txt{
  background-image: linear-gradient(135deg,#f2a5a5,#e05555 45%,#7c1212 70%,#f8b0b0);
}
/* B: deep blue */
.f76 .card-front .special[data-grade="B"] .special__txt{
  background-image: linear-gradient(135deg,#9fb7ff,#4a79d6 55%,#173262 85%,#c5d3ff);
}
/* C: deep green */
.f76 .card-front .special[data-grade="C"] .special__txt{
  background-image: linear-gradient(135deg,#9be2b8,#2d8f5c 55%,#0f4a2b 85%,#c3f1d7);
}

/* Fallback for browsers without background-clip:text */
@supports not ((-webkit-background-clip:text) or (background-clip:text)){
  .f76 .card-front .special .special__txt{ -webkit-text-stroke: 0; text-shadow:none; }
  .f76 .card-front .special[data-grade="SS"] .special__txt{ color:#6fb3ff; -webkit-text-fill-color:#6fb3ff; }
  .f76 .card-front .special[data-grade="S"]  .special__txt{ color:#d4a017; -webkit-text-fill-color:#d4a017; }
  .f76 .card-front .special[data-grade="A"]  .special__txt{ color:#7c1212; -webkit-text-fill-color:#7c1212; }
  .f76 .card-front .special[data-grade="B"]  .special__txt{ color:#173262; -webkit-text-fill-color:#173262; }
  .f76 .card-front .special[data-grade="C"]  .special__txt{ color:#0f4a2b; -webkit-text-fill-color:#0f4a2b; }
}

/* === Back-face corner bump (keeps protrusion, matches bone frame) === */
.f76 .card-backing{ position: absolute; inset: 0; border-radius: var(--card-radius); }
.f76 .card-backing::before{
  content:"";
  position:absolute;
  top:  calc(-1 * var(--card-border));
  right:calc(-1 * var(--card-border));
  width: var(--bump-size);
  height: var(--bump-size);
  background: var(--color-backing-top);
  border-radius: .6rem;
  /* Create a bone-colored frame around the bump so seams disappear */
  box-shadow:
    0 0 0 var(--card-border) var(--frame),
    0 3px 8px rgba(0,0,0,.35);
  z-index: 6;
  pointer-events: none;
}
/* Seam micro-fix */
.f76 .card-backing .top-banner{ position: relative; }
.f76 .card-backing .top-banner::after{
  content:"";
  position:absolute;
  top: .95rem;
  right: calc(var(--bump-size) - .2rem);
  width: 1.8rem; height: .42rem;
  background: var(--frame);
  border-radius: .21rem;
  z-index: 7;
  pointer-events:none;
}



/* === Force all frames (card + bump) to use light blue === */
.f76 {
  --frame: #cfe2ff; /* pick your light blue shade */
}

/* unify card face border */
.f76 .card-face,
.f76 .card-front.theme-blue.card-face {
  border-color: var(--frame) !important;
}

/* unify bump border */
.f76 .bump {
  border-color: var(--frame) !important;
}
.f76 .card-front.theme-blue .bump {
  border-color: var(--frame) !important;
}

/* unify back bump frame */
.f76 .card-backing::before {
  box-shadow:
    0 0 0 var(--card-border) var(--frame),
    0 3px 8px rgba(0,0,0,.35);
}


/* === Remove all shadows from numeric bump === */ 
.f76 .bump { box-shadow: none !important; /* remove border box shadow */ } 
.f76 .bump::after { box-shadow: none !important; /* remove custom outer shadow */ }


/* === Fix gap between Vault-Tec center circle and side lines === */
.f76 .vault-tec .line-inner {
  width: 100% !important;   /* make bar extend fully */
}

.f76 .vault-tec .line--left .line-inner::before,
.f76 .vault-tec .line--right .line-inner::before {
  display: none !important; /* remove rounded caps if causing space */
}

.f76 .vault-tec .center {
  border: 8px solid var(--color-bone);
  margin: 0 auto;
  position: relative;
  z-index: 2; /* keep on top */
}




</style>
{% endblock %}

{% block content %}
<section class="kids-stage">
  <div class="aquarium" id="aquarium" aria-hidden="true">
    <!-- Looping background video; â€œNextâ€ is gated by the read timer only -->
    <video id="fishVideo" src="{% static 'fish1.mp4' %}" preload="metadata" autoplay muted playsinline loop></video>
  </div>
  <div class="ripples" aria-hidden="true"></div>

  <div class="vessels-layer" id="vessels" aria-hidden="true">
    <img id="submarineGif" class="vessel sub" src="{% static 'submarine.gif' %}" alt="">
    <img id="boatGif" class="vessel boat" src="{% static 'boat.gif' %}" alt="">
  </div>

  <div class="celebration" id="celebration" aria-hidden="true">
    <div class="glass-card">
      <div class="media">
        <div class="halo-behind" aria-hidden="true"></div>
        <img class="platypus" src="{% static 'platypus_dance.gif' %}" alt="Dancing platypus">
        <img class="win-label" src="{% static 'win.png' %}" alt="Victory banner">
      </div>
    </div>
  </div>

  <!-- ===== Bi-weekly Monday countdown banner (above the right card dock) ===== -->
  <div id="collectionCountdown" class="collection-countdown" role="status" aria-live="polite">
    <div class="cd-wrap">
      <span class="cd-label">Next Animal Collection update</span>
      <span class="cd-eta" id="cdEta">--d --:--:--</span>
      <span class="cd-date" id="cdDate">Target: Mon -- --</span>
      <div class="cd-track"><b class="cd-fill" id="cdFill"></b></div>
    </div>
  </div>

  <aside class="progress-dock" id="progressDock">
    <div class="ring" id="progressRing" role="progressbar" aria-valuemin="0" aria-valuemax="0" aria-valuenow="0" aria-label="Lesson progress">
      <div class="ring-core">
        <div class="ring-count"><span id="doneCount">0</span>/<span id="totalCount">0</span></div>
        <div class="ring-caption">learned</div>
      </div>
    </div>
    <div class="segbar" id="segbar" aria-hidden="true"></div>
    <div class="progress-toast" id="progressToast" aria-live="polite"></div>
  </aside>

  <div class="card-dock">
    <div class="sleepy-wrap" aria-hidden="true">
      <img class="sleepy-platypus" src="{% static 'platypus_sleep.gif' %}" alt="">
    </div>

    <div class="cards" id="cards">
      {% for c in db_cards %}
      <article
        class="card{% if c.is_starter %} card--starter{% endif %}{% if c.is_starter or forloop.first %} active{% endif %}"
        data-card="{{ c.card_order }}"
        data-read-sec="{{ c.read_seconds|default:4 }}"
        tabindex="0"
        aria-expanded="false"
        aria-controls="details-{{ c.card_order }}">
        <div class="hud" aria-hidden="true">
          <div class="read-timer"><span class="read-dot"></span><span class="read-text">Keep readingâ€¦ {{ c.read_seconds|default:4 }}s</span></div>
          <div class="check-badge">âœ“</div>
        </div>
        <h3>{{ c.title }}</h3>
        <div class="qa-wrap">
          {{ c.lead_html|safe }}
          <div class="details" id="details-{{ c.card_order }}">{{ c.detail_html|safe }}</div>
        </div>
        <span class="hint" aria-hidden="true">{{ c.hint_text }}</span>
      </article>
      {% endfor %}
    </div>
  </div>

  <button id="nextBtn" class="next-btn" type="button" aria-label="Next card">â€º</button>
  <button id="finishBtn" class="finish-btn" type="button" aria-label="Finish">Finish</button>
</section>

<!-- Kids Collection Cards -->
<section class="kids-collection f76" aria-label="Your Ocean Cards">
  <!-- Transparent glass pane behind the grid so users don't mistake it as "broken" -->
  <div class="glass-backdrop" aria-hidden="true"></div>

  <h2 class="collect-title">Collect Your Ocean Cards</h2>
  <div class="collect-grid" id="collectGrid"></div>
</section>

<!-- Server-provided JSON for collection cards -->
<script id="collectCardsData" type="application/json">{{ collect_cards_json|default:"[]"|safe }}</script>
{% endblock %}

{% block page_scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>

<script>
  const STATIC_BASE = "{% get_static_prefix %}";

  /* Toastr "success" with a built-in fallback pill */
  function greenToast(msg, title='Unlocked!'){
    if (window.toastr && typeof toastr.success === 'function'){
      toastr.options = Object.assign({
        closeButton: false,
        newestOnTop: true,
        progressBar: true,
        positionClass: "toast-bottom-right",
        timeOut: 2600,
        extendedTimeOut: 1200,
        tapToDismiss: true,
        preventDuplicates: true
      }, toastr.options || {});
      toastr.success(msg, title);
    }else{
      const t = document.getElementById('progressToast');
      if(!t) return;
      t.textContent = msg;
      t.classList.add('show');
      setTimeout(()=> t.classList.remove('show'), 2600);
    }
  }

  window.pageInit = function(){
    const hdr = document.getElementById('siteHeader');
    const applyHdrH = () => document.documentElement.style.setProperty('--hdrH', (hdr?.offsetHeight || 80) + 'px');
    applyHdrH(); window.addEventListener('resize', applyHdrH);

    const aquarium   = document.getElementById('aquarium');
    const fishVideo  = document.getElementById('fishVideo');
    const celebration= document.getElementById('celebration');
    const cardsWrap  = document.getElementById('cards');
    const nextBtn    = document.getElementById('nextBtn');
    const finishBtn  = document.getElementById('finishBtn');
    const collectGrid= document.getElementById('collectGrid');

    const ring   = document.getElementById('progressRing');
    const segbar = document.getElementById('segbar');
    const toast  = document.getElementById('progressToast');
    const doneEl = document.getElementById('doneCount');
    const totalEl= document.getElementById('totalCount');

    const submarine = document.getElementById('submarineGif');
    const boat = document.getElementById('boatGif');

    /* Pull collectible card data (array of objects) from the backend JSON script tag */
    let COLLECT_CARDS = [];
    try{
      const tag = document.getElementById('collectCardsData');
      COLLECT_CARDS = JSON.parse(tag?.textContent || '[]') || [];
    }catch(e){ COLLECT_CARDS = []; }

    // Learn cards
    const cards = Array.from(cardsWrap.querySelectorAll('.card'));
    let activeIndex = cards.findIndex(c => c.classList.contains('active'));
    if (activeIndex < 0) activeIndex = 0;

    // Per-card state
    const state = new Map();
    const ensure = (id)=>{ if(!state.has(id)) state.set(id, {timerId:null, startTime:null, done:false, unlocked:false}); return state.get(id); };

    // Background video loops
    fishVideo.loop = true;

    // Background fishN.mp4 switching per learn card
    const MAX_FISH = 19;
    const knownMissing = new Set();
    let fishSwitchToken = 0;
    const fishUrl = (n) => STATIC_BASE + 'fish' + n + '.mp4';
    function hideFish(){ document.getElementById('aquarium').classList.remove('bg-on'); try{ fishVideo.pause(); }catch(e){} }
    function setFishForCard(i){
      const nRaw = parseInt(cards[i]?.dataset?.card, 10);
      let n = isNaN(nRaw) ? (i+1) : nRaw;
      n = Math.max(1, Math.min(MAX_FISH, n));
      while(n > 1 && knownMissing.has(n)) n--;
      const url = fishUrl(n);
      const myToken = ++fishSwitchToken;
      const onLoaded = () => {
        if (myToken !== fishSwitchToken) return cleanup();
        fishVideo.loop = true; fishVideo.currentTime = 0;
        document.getElementById('aquarium').classList.add('bg-on');
        fishVideo.play?.().catch(()=>{});
        cleanup();
      };
      const onError = () => { knownMissing.add(n); cleanup(); if(n>1) setFishForCard(i); };
      const cleanup = () => {
        fishVideo.removeEventListener('loadeddata', onLoaded);
        fishVideo.removeEventListener('error', onError);
      };
      if (fishVideo.getAttribute('src') === url){
        fishVideo.loop = true;
        document.getElementById('aquarium').classList.add('bg-on');
        fishVideo.play?.().catch(()=>{});
        return;
      }
      fishVideo.addEventListener('loadeddata', onLoaded);
      fishVideo.addEventListener('error', onError);
      fishVideo.setAttribute('src', url); fishVideo.load();
    }

    // Vessels visuals
    let gameStarted = false;
    let postCelebrationWindow = false;
    const WATER_RISE_MS = 1400, WATER_FALL_MS = 1400;
    const VESSEL_RUN_MS = 9000, LOOP_TOTAL_MS = 60000, LOOP_GAP_MS = 1000;
    function canPlayVessel(){ return (!gameStarted) || postCelebrationWindow; }
    let loopToken = 0;
    function cancelVesselLoops(){ loopToken++; submarine.classList.remove('run'); boat.classList.remove('run'); }
    function startVesselLoop(el, preDelayMs){
      if (!canPlayVessel()) return;
      cancelVesselLoops();
      const myToken = ++loopToken; let elapsed = 0;
      const runOnce = ()=>{
        if (myToken !== loopToken || !canPlayVessel()) return;
        el.classList.remove('run'); void el.offsetWidth; el.classList.add('run');
        setTimeout(()=>{
          if (myToken !== loopToken) { el.classList.remove('run'); return; }
          elapsed += VESSEL_RUN_MS + LOOP_GAP_MS;
          if (elapsed + VESSEL_RUN_MS <= LOOP_TOTAL_MS){ runOnce(); } else { el.classList.remove('run'); }
        }, VESSEL_RUN_MS + LOOP_GAP_MS);
      };
      setTimeout(()=>{ if (myToken === loopToken) runOnce(); }, preDelayMs);
    }
    const docEl = document.documentElement;
    const obs = new MutationObserver(muts=>{
      muts.forEach(m=>{
        if(m.type==='attributes' && m.attributeName==='data-theme'){
          const theme = docEl.getAttribute('data-theme') || '';
          if (theme === 'dark'){ startVesselLoop(submarine, WATER_RISE_MS); }
          else{ startVesselLoop(boat, WATER_FALL_MS); }
        }
      });
    });
    obs.observe(docEl, {attributes:true});

    // Progress UI
    const total = cards.length;
    totalEl.textContent = String(total);
    ring.setAttribute('aria-valuemax', String(total));
    function buildSegbar(n){
      segbar.innerHTML = '';
      segbar.style.gridTemplateColumns = `repeat(${n}, 1fr)`;
      for(let i=0;i<n;i++){ const s = document.createElement('span'); s.className = 'seg'; segbar.appendChild(s); }
    }
    buildSegbar(total);
    function popToast(msg, ms=3200){ toast.textContent = msg; toast.classList.add('show'); setTimeout(()=> toast.classList.remove('show'), ms); }

    // Celebration
    const CELEB_IN_MS=600, CELEB_HOLD_MS=4800, CELEB_OUT_MS=600, CELEB_START_FADE_OUT_AT=CELEB_IN_MS+CELEB_HOLD_MS;
    function onCelebrationComplete(){ postCelebrationWindow = true; }
    function celebrateFinish(){
      hideFish(); celebration.classList.add('show'); celebration.setAttribute('aria-hidden','false'); void celebration.offsetWidth;
      celebration.classList.add('anim-in');
      setTimeout(()=>{
        celebration.classList.remove('anim-in'); celebration.classList.add('anim-out');
        setTimeout(()=>{ celebration.classList.remove('anim-out','show'); celebration.setAttribute('aria-hidden','true'); onCelebrationComplete(); }, CELEB_OUT_MS);
      }, CELEB_START_FADE_OUT_AT);
    }

    // Next button visibility
    let lastDone = 0;
    const segOn = ()=> Array.from(state.values()).filter(x=>x.done).length;
    function updateProgress(){
      const doneCount = segOn();
      const p = total ? doneCount / total : 0;
      ring.style.setProperty('--p', p);
      ring.setAttribute('aria-valuenow', String(doneCount));
      doneEl.textContent = String(doneCount);
      const segs = segbar.querySelectorAll('.seg');
      segs.forEach((seg, idx)=> seg.classList.toggle('on', idx < doneCount));
      if(doneCount !== lastDone){
        const halfway = Math.ceil(total/2);
        if(doneCount === halfway) popToast('Halfway! Keep cruising ðŸ’§', 3600);
        if(doneCount === total){ popToast('All done! Tap Finish ðŸ’§', 6600); finishBtn.classList.add('show'); }
      }
      lastDone = doneCount;
      updateNextVisibility();
    }
    function updateNextVisibility(){
      const stActive = ensure(String(cards[activeIndex].dataset.card));
      const show = stActive.done && activeIndex < cards.length-1;
      nextBtn.classList.toggle('show', show);
    }

    // Height lock so the card doesn't jump when details open
    function lockAllCardHeights() {
      cards.forEach((card) => {
        const details = card.querySelector('.details');
        if (!details) return;
        const wasOpen = details.classList.contains('open');
        const wasRevealed = card.classList.contains('revealed');
        details.classList.remove('open'); card.classList.remove('revealed'); card.style.height = 'auto';
        const hClosed = card.scrollHeight;
        details.classList.add('open'); card.classList.add('revealed');
        const hOpen = card.scrollHeight;
        details.classList.toggle('open', wasOpen); card.classList.toggle('revealed', wasRevealed);
        const fixed = Math.max(hClosed, hOpen, 240); card.style.setProperty('--fixedH', fixed + 'px'); card.classList.add('fixed');
      });
    }
    function showOnly(index){
      cards.forEach((c,i)=> c.classList.toggle('active', i===index));
      hideFish();
      updateNextVisibility();
    }

    // Read timer
    function setReading(cardEl, on){ cardEl.classList.toggle('reading', !!on); }
    function setDone(cardEl){ cardEl.classList.add('done'); setReading(cardEl,false); }
    function stopTimer(id){ const st = ensure(id); if(st.timerId!=null){ clearInterval(st.timerId); st.timerId=null; } st.startTime=null; }
    function getReadMs(cardEl){ const sec = Number(cardEl.dataset.readSec); return (!isNaN(sec) && sec > 0) ? sec * 1000 : 4000; }
    function startTimer(cardEl, id){
      const st = ensure(id); stopTimer(id); st.startTime = Date.now(); setReading(cardEl, true);
      const READ_MS = getReadMs(cardEl); const readText = cardEl.querySelector('.read-text');
      const update = ()=>{ if(!readText) return; const remain = Math.max(0, READ_MS - (Date.now() - st.startTime)); readText.textContent = `Keep readingâ€¦ ${Math.ceil(remain/1000)}s`; };
      update();
      st.timerId = setInterval(()=>{
        const elapsed = Date.now() - st.startTime; update();
        if(elapsed >= READ_MS){
          stopTimer(id);
          if(!st.done){
            st.done = true; setDone(cardEl); updateProgress();
            const idx = cards.indexOf(cardEl);
            document.getElementById('aquarium').classList.add('bg-on');
            setFishForCard(idx);
            fishVideo?.play?.().catch(()=>{});
            gameStarted = true; postCelebrationWindow = false; cancelVesselLoops();
          }
        }
      }, 100);
    }

    // Reveal active card once
    function revealOnce(card){
      if(card.classList.contains('locked')) return;
      const id = card.dataset.card;
      const details = document.getElementById('details-'+id);
      if(!details) return;
      card.classList.add('revealed'); details.classList.add('open'); card.setAttribute('aria-expanded', 'true');
      card.classList.add('locked'); card.setAttribute('tabindex','-1');
      const st = ensure(id);
      if(!st.done) startTimer(card, id); else { setDone(card); setFishForCard(cards.indexOf(card)); }
    }
    cardsWrap.addEventListener('click', e=>{
      const card = e.target.closest('.card.active');
      if(!card || card.classList.contains('locked')) return;
      revealOnce(card);
    });
    cardsWrap.addEventListener('keydown', e=>{
      const t = e.target;
      if(!t.classList?.contains('card') || !t.classList.contains('active')) return;
      if(t.classList.contains('locked')) return;
      if(e.key==='Enter' || e.key===' '){ e.preventDefault(); revealOnce(t); }
    });

    /* ========= Collectible card builder (with grade text color) ========= */
    function normGrade(x){
      const t = String(x || 'S').trim().toUpperCase();
      if (t === 'S+' || t === 'SSS') return 'SS';
      return (['SS','S','A','B','C'].includes(t)) ? t : 'S';
    }
    function esc(s){
      return String(s).replace(/[&<>"']/g, m => (
        {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]
      ));
    }

    function appendCollectForCardId(cardId){
      const st = ensure(cardId);
      if (st.unlocked) return;
      if (!Array.isArray(COLLECT_CARDS) || COLLECT_CARDS.length === 0) return;

      const ord  = parseInt(cardId, 10) || 1;
      const pool = COLLECT_CARDS[(ord - 1) % COLLECT_CARDS.length] || {};

      const num      = pool.no ?? pool.number ?? ord;
      const title    = pool.title ?? 'Ocean Friend';
      const aria     = pool.aria ?? pool.aria_label ?? (title + ' card');
      const img      = pool.img ?? pool.image ?? pool.img_url ?? (STATIC_BASE + 'cards/placeholder.png');
      const desc     = pool.desc ?? pool.description ?? 'Learn more about this ocean friend!';
      const cap      = parseInt(pool.levelCap ?? pool.level_cap ?? 3, 10) || 3;
      const cur      = parseInt(pool.levelCur ?? pool.level_cur ?? 1, 10) || 1;
      const rawSpec  = pool.special ?? 'S';
      const grade    = normGrade(rawSpec);     // â†’ SS / S / A / B / C

      // Do NOT lazy/async GIFs (they sometimes stall animation).
      const isGif = /\.gif(\?.*)?$/i.test(img);
      const safeTitle = esc(title);
      const imgTag = isGif
        ? `<img class="slugger" src="${img}" alt="${safeTitle}" width="320" height="260">`
        : `<img class="slugger" src="${img}" alt="${safeTitle}" width="320" height="260" loading="lazy" decoding="async">`;

      const html = `
        <div class="card-scene">
          <div class="card" data-level-cap="${cap}" data-level-current="${cur}">
            <div class="card-face card-backing" aria-hidden="true">
              <div class="top-banner"></div>
              <div class="back-main">
                <div class="vault-tec">
                  <div class="center"></div>
                  <div class="lines">
                    <div class="line line--left">
                      <div class="line-inner"></div><div class="line-inner"></div><div class="line-inner"></div>
                    </div>
                    <div class="line line--right">
                      <div class="line-inner"></div><div class="line-inner"></div><div class="line-inner"></div>
                    </div>
                  </div>
                </div>
                <p class="flip-hint">Click to reveal!</p>
              </div>
            </div>
            <div class="card-face card-front theme-blue" role="group" aria-label="${esc(aria)}">
              <h1><span class="bump"><b class="outer"><b class="inner">${num}</b></b></span>${safeTitle}</h1>
              <div class="main-pane">
                ${imgTag}
              </div>
              <div class="desc">
                <p>${esc(desc)}</p>
                <!-- Text-only grade styling: keep layout, inject inner span for gradient text -->
                <div class="special" data-category="science" data-grade="${grade}">
                  <span class="special__txt">${esc(grade)}</span>
                </div>
                <div class="level"></div>
              </div>
            </div>
          </div>
        </div>`.trim();

      const tmp = document.createElement('div');
      tmp.innerHTML = html;
      const scene = tmp.firstElementChild;
      collectGrid.appendChild(scene);

      initF76Card(scene.querySelector('.card'));
      st.unlocked = true;
      greenToast('A new Ocean Card appeared!', 'Unlocked!');
    }

    // Next (read-timer only)
    nextBtn.addEventListener('click', ()=>{
      const curId = String(cards[activeIndex].dataset.card);
      const st = ensure(curId);
      if(!st.done) return;
      appendCollectForCardId(curId);
      if (activeIndex < cards.length-1){
        hideFish();
        activeIndex += 1;
        showOnly(activeIndex);
      }
    });

    // Finish
    finishBtn.addEventListener('click', ()=>{
      const doneCount = Array.from(state.values()).filter(x=>x.done).length;
      if(doneCount === total){
        const lastId = String(cards[cards.length-1].dataset.card);
        const st = ensure(lastId);
        if(st.done && !st.unlocked){ appendCollectForCardId(lastId); }
        celebrateFinish();
      }
    });

    // Boot
    showOnly(activeIndex);
    lockAllCardHeights();
    updateProgress();

    window.addEventListener('resize', ()=>{
      cards.forEach(c => { c.classList.remove('fixed'); c.style.removeProperty('--fixedH'); });
      lockAllCardHeights();
    });

    document.addEventListener('visibilitychange', ()=>{
      if(!fishVideo) return;
      if(document.hidden) fishVideo.pause?.(); else if(aquarium.classList.contains('bg-on')) fishVideo.play?.();
    });

    celebration.addEventListener('click', ()=>{
      if(!celebration.classList.contains('show')) return;
      celebration.classList.remove('anim-in'); celebration.classList.add('anim-out');
      setTimeout(()=>{ celebration.classList.remove('anim-out','show'); celebration.setAttribute('aria-hidden','true'); onCelebrationComplete(); }, 600);
    });

    // Fallout mini-card init (adds stars and flip interaction)
    function initF76Card(card){
      if(!card) return;
      const cap = parseInt(card.getAttribute('data-level-cap') || '3', 10);
      const cur = parseInt(card.getAttribute('data-level-current') || '1', 10);
      const levelBox = card.querySelector('.level');
      if(levelBox){
        levelBox.innerHTML = '';
        for(let i=1;i<=cap;i++){
          const s = document.createElement('span');
          s.className = 'star' + (i<=cur ? ' current-level' : '');
          levelBox.appendChild(s);
        }
      }
      card.addEventListener('click', (e)=>{
        e.stopPropagation();
        if(card.classList.contains('card--flipped')){
          card.classList.add('card--unflip');
          setTimeout(()=> card.classList.remove('card--flipped','card--unflip'), 320);
        }else{
          card.classList.add('card--flipped');

          // If the front image is a GIF, restart its animation when the card flips open.
          const img = card.querySelector('.slugger');
          if (img && /\.gif(\?.*)?$/i.test(img.src)) {
            const s = img.src;
            img.src = '';
            void img.offsetWidth;   // force reflow
            img.src = s;            // reload â†’ restart animation
          }
        }
      });
    }

    /* ===================== Bi-weekly Monday countdown logic ===================== */
    // Window is [this Monday 00:00, Monday after next 00:00)
    const cdEta = document.getElementById('cdEta');
    const cdDate= document.getElementById('cdDate');
    const cdFill= document.getElementById('cdFill');

    function startOfDay(d){
      const x = new Date(d);
      x.setHours(0,0,0,0);
      return x;
    }
    function mondayOfWeek(d){
      // JS getDay(): Sun=0..Sat=6; we want Monday=1 -> offset = (day+6)%7
      const x = startOfDay(d);
      const offset = (x.getDay() + 6) % 7; // 0 if Monday, 6 if Sunday
      x.setDate(x.getDate() - offset);
      return x;
    }
    function addDays(d, n){
      const x = new Date(d);
      x.setDate(x.getDate() + n);
      return x;
    }
    function fmtTargetDate(d){
      try{
        return d.toLocaleDateString(undefined, { weekday:'short', month:'short', day:'numeric', year: 'numeric' });
      }catch(e){
        return d.toDateString();
      }
    }
    function pad(n){ return String(n).padStart(2,'0'); }

    function updateCountdown(){
      const now    = new Date();
      let start    = mondayOfWeek(now);     // this Monday 00:00
      let end      = addDays(start, 14);    // Monday after next 00:00

      // If we somehow crossed the window, roll forward by whole 14-day blocks
      while(now >= end){
        start = addDays(start, 14);
        end   = addDays(end, 14);
      }

      const total   = end - start;          // total ms in this 2-week window
      const remain  = Math.max(0, end - now);
      const passed  = Math.max(0, now - start);
      const pct     = Math.min(1, passed / total);

      // Text ETA: D HH:MM:SS
      const sec = Math.floor(remain / 1000);
      const d   = Math.floor(sec / 86400);
      const h   = Math.floor((sec % 86400) / 3600);
      const m   = Math.floor((sec % 3600) / 60);
      const s   = sec % 60;
      if(cdEta)  cdEta.textContent  = `${d}d ${pad(h)}:${pad(m)}:${pad(s)}`;
      if(cdDate) cdDate.textContent = `Target: ${fmtTargetDate(end)} (00:00)`;
      if(cdFill) cdFill.style.width = `${(pct*100).toFixed(2)}%`;
    }

    updateCountdown();
    setInterval(updateCountdown, 1000);
    /* ========================================================================= */
  };
</script>
{% endblock %}
