{% extends "base.html" %}
{% load static %}

{% block title %}For Kids â€“ Learn & Play | Water & Sanitation{% endblock %}

{% block head_extras %}
<link rel="preload" href="{% static 'card1.mp4' %}" as="video">
<link rel="preload" href="{% static 'card2.mp4' %}" as="video">
<link rel="preload" href="{% static 'card3.mp4' %}" as="video">
<link rel="preload" href="{% static 'platypus_dance.gif' %}" as="image">
<link rel="preload" href="{% static 'platypus_sleep.gif' %}" as="image">
<link rel="preload" href="{% static 'win.png' %}" as="image">
<link rel="preload" href="{% static 'submarine.gif' %}" as="image">
<link rel="preload" href="{% static 'boat.gif' %}" as="image">

<!-- Toastr (success toast) -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css" />


<style>

  /* Register Super Shape (only font, no color changes) */
@font-face{
  font-family: "Super Shape";
  src:
    url("{% static 'fonts/super-shape/SuperShiny-0v0rG.ttf' %}") format("truetype");
  font-weight: 200;
  font-style: normal;
  font-display: swap;
}

  :root{
    --card-radius: 18px;
    --hdrH: 80px;
    --card-text: #fff;
    --card-text-shadow: 0 2px 6px rgba(0,0,0,.65);
    --title-grad: linear-gradient(90deg,#98caff 0%, #58b2ff 50%, #1f8aff 100%);
    --gold: #ffd34d; /* for dark-mode hint */
    --dockW: min(720px, 58vw);
  }
  [data-theme="light"]{
    --card-text:#fff;
    --card-text-shadow: 0 2px 8px rgba(0,0,0,.6);
  }

  #ripple-layer{ display:none !important; }

  /* ===== Stage ===== */
  .kids-stage{ position:relative; min-height: calc(100svh - var(--hdrH)); }
  .aquarium,.ripples{
    position: fixed; left:0; right:0; top: var(--hdrH); bottom:0; pointer-events:none;
  }
  .aquarium{ z-index:0; opacity:0; transition:opacity .6s ease; }
  .aquarium.bg-on{ opacity:1; }
  .aquarium video{ width:100%; height:100%; object-fit:cover; filter:saturate(1.05) contrast(1.02) brightness(1.05); }
  .ripples{
    z-index:1; opacity:.75;
    background:
      radial-gradient(1000px 500px at 12% 18%, rgba(91,200,255,.30), transparent 60%),
      radial-gradient(800px 400px at 85% 28%, rgba(40,150,255,.22), transparent 60%);
    animation:rippleMove 14s linear infinite;
  }
  @keyframes rippleMove{ 0%{transform:translateY(0)} 50%{transform:translateY(2px)} 100%{transform:translateY(0)} }

  
  /* ===== Right dock: the single active learn card ===== */
  .card-dock{
    position: fixed;
    right: clamp(12px, 3vw, 28px);
    top: calc(var(--hdrH) + clamp(12px, 1.5vw, 18px));
    bottom: clamp(12px, 2vw, 20px);
    /*width: min(560px, 44vw);*/
    width: var(--dockW);
    z-index: 2;
    display: grid;
    align-items: center;
    justify-items: stretch;
  }

  .sleepy-wrap{
    position: absolute; right: 0;
    top: clamp(-120px, -8vw, -84px);
   /* width: min(560px, 44vw);*/
    width: var(--dockW);
    display: grid; justify-items: end;
    pointer-events: none; z-index: 3;
  }
  .sleepy-platypus{ width: min(420px, 36vw); transform: scale(0.8); image-rendering: -webkit-optimize-contrast; filter: drop-shadow(0 8px 22px rgba(0,0,0,.38)); }
  @media (max-width: 980px){
    .sleepy-wrap{ top: clamp(-80px, -10vw, -60px); }
    .sleepy-platypus{ width: min(320px, 52vw); transform: scale(1.04); }
  }

  /* Only .cards > .card are learn cards */
  .cards{ display: contents; }
  .cards > .card{ display:none; }
  .cards > .card.active{ display:flex; flex-direction: column; }

  .cards > .card{
    background: linear-gradient(180deg, rgba(5,12,24,.80), rgba(8,18,36,.74)), rgba(8,18,38,.12);
    border:1px solid rgba(160,210,255,.30);
    border-radius:14px;
    padding: clamp(16px, 2vw, 22px);
    backdrop-filter: blur(1px) saturate(130%);
    color: var(--card-text);
    text-shadow: var(--card-text-shadow);
    min-height: 240px;
    box-shadow: 0 14px 34px rgba(0,20,60,.48);
    position:relative; overflow:hidden;
  }
  .cards > .card h3{
    font-weight: 900; font-size: clamp(35px, 2.4vw, 26px); margin: 0 0 10px; letter-spacing: .2px;
    background: var(--title-grad); -webkit-background-clip: text; background-clip:text; color: transparent; -webkit-text-fill-color: transparent;
    text-shadow: 0 1px 0 rgba(0,0,0,.45), 0 0 14px rgba(40,120,220,.35);
  }
  [data-theme="light"] .cards > .card h3{
    background: none !important; -webkit-background-clip: initial; background-clip: initial; -webkit-text-fill-color: initial; color: #fff !important; text-shadow: 0 2px 8px rgba(0,0,0,.6);
  }
  .cards > .card > *{ min-width:0; }
  .qa-wrap{ width:100%; display:grid; }
  .qa-wrap > p, .details p{ margin:0 0 12px; font-size: clamp(18px, 1.6vw, 24px); line-height:1.6; overflow-wrap:anywhere; 
    
  }
  .details{ max-height: none !important; opacity: 0; transition: opacity .25s ease; width: 100%; }
  .cards > .card.revealed .details{ opacity: 1; }

  .hud{ position:absolute; top:12px; right:12px; z-index:3; display:grid; align-items:center; justify-items:end; pointer-events:none; }
  .hud > *{ grid-area: 1 / 1; }
  .read-timer{ height:28px; padding:0 10px; border-radius:999px; display:inline-flex; align-items:center; gap:6px; font-size:12px; font-weight:800; color:#0a2a6b;
    background:linear-gradient(180deg,#d7fbe8,#b5f1d4); border:1px solid rgba(24,192,109,.6); box-shadow: 0 2px 10px rgba(24,192,109,.25), inset 0 1px 0 #fff;
    opacity:0; transform:translateY(-6px); transition:opacity .2s ease, transform .2s ease; }
  .cards > .card.reading .read-timer{ opacity:1; transform:translateY(0); }
  .read-dot{ width:8px; height:8px; border-radius:50%; background:#18c06d; box-shadow:0 0 0 3px rgba(24,192,109,.25); }
  .check-badge{ width:28px; height:28px; border-radius:999px; display:grid; place-items:center; font-size:18px; line-height:1; background:#18c06d; color:#fff; border:none;
    box-shadow: 0 4px 16px rgba(24,192,109,.45), inset 0 -2px 0 rgba(0,0,0,.18); transform:scale(.82); opacity:0; transition:opacity .2s ease, transform .2s ease; }
  .cards > .card.done .check-badge{ opacity:1; transform:scale(1); }

  .hint{
    position:absolute; right:12px; bottom:12px; background:rgba(255,255,255,.16);
    border:1px dashed rgb(255,255,255);
    font-size:14px; padding:4px 8px; border-radius:999px; color:#fff;
    text-shadow:0 1px 0 rgba(255,254,254,.45); pointer-events:none;
  }
  [data-theme="dark"] .hint{
    color: var(--gold);
    border-color: var(--gold);
    background: rgba(255,211,77,.12);
    text-shadow: 0 0 8px rgba(255,211,77,.55);
  }

    [data-theme="light"] .hint{
    color: var(--gold);
    border-color: var(--gold);
    background: rgba(255,211,77,.12);
    text-shadow: 0 0 8px rgba(255,211,77,.55);
  }

  .cards > .card .hint{
    font-size: clamp(16px, 1.6vw, 18px);
    padding: 6px 12px;    
    border-width: 1.5px;
        font-family: "Super Shape", system-ui, -apple-system, "Segoe UI",
                Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif !important;
    font-weight: 400;     
    letter-spacing: .02em; 
    line-height: 1.12;
  }
  /* Only change the learn-card title font; colors/shadows remain */
  .cards > .card h3{
    font-family: "Super Shape", system-ui, -apple-system, "Segoe UI",
                Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif !important;
    font-weight: 400;     
    letter-spacing: .02em; 
    line-height: 1.12;
  }

  /* ===== Next / Finish ===== */
    /* Bigger capsule Next button with wiggle + sheen */
    .next-btn{
      position: fixed;
      /* right: calc(clamp(12px, 3vw, 28px) + min(560px, 44vw) + 10px);*/
      right: calc(clamp(12px, 3vw, 28px) + var(--dockW) + 10px);
      top: 50%;
      transform: translateY(-50%);
      z-index: 2;

      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 12px 22px;
      min-width: 132px;
      height: 48px;
      border-radius: 999px;

      background: linear-gradient(180deg,#e8f5ff,#cfe9ff);
      border: 1px solid rgba(120,170,255,.6);
      color: #0a2a6b;
      font-weight: 900;
      font-size: 25px;
      letter-spacing: .02em;

      box-shadow: 0 10px 24px rgba(30,90,200,.30), inset 0 1px 0 #fff;
      text-shadow: 0 1px 0 rgba(255,255,255,.6);

      cursor: pointer;
      opacity: 0;                
      pointer-events: none;
      transition: opacity .2s ease, transform .2s ease;

      animation:
        next-wiggle 1.2s ease-in-out 2s infinite,
        next-glow   2.6s ease-in-out 0s  infinite alternate;

      position: fixed;  /* for ::after sheen positioning context */
      overflow: hidden;
    }

    .next-btn::after{
      content: "";
      position: absolute;
      top: -150%;
      left: -60%;
      width: 40%;
      height: 400%;
      background: linear-gradient(90deg, rgba(255,255,255,0) 0%,
                                          rgba(255,255,255,.65) 50%,
                                          rgba(255,255,255,0) 100%);
      transform: rotate(20deg);
      animation: next-sheen 2.2s linear infinite;
      pointer-events: none;
    }

    .next-btn.show{ opacity: 1; pointer-events: auto; }
    .next-btn:active{ transform: translateY(-50%) scale(.98); }

    @media (max-width:980px){
      .next-btn{
        right: clamp(12px, 3vw, 28px);
        top: auto;
        bottom: calc(12px + env(safe-area-inset-bottom));
        transform: none;
      }
      .next-btn:active{ transform: scale(.98); }
    }

    /* Keyframes */
    @keyframes next-wiggle{
      0%,100%{ transform: translateY(-50%) rotate(0deg); }
      10%   { transform: translateY(calc(-50% - 1px)) rotate(-1.2deg); }
      20%   { transform: translateY(-50%) rotate(1.2deg); }
      30%   { transform: translateY(calc(-50% - .5px)) rotate(-.8deg); }
      40%   { transform: translateY(-50%) rotate(.8deg); }
      50%   { transform: translateY(calc(-50% - .3px)) rotate(-.5deg); }
      60%,90%{ transform: translateY(-50%) rotate(0deg); }
    }
    @keyframes next-glow{
      from{ box-shadow: 0 10px 24px rgba(30,90,200,.30), inset 0 1px 0 #fff; }
      to  { box-shadow: 0 14px 32px rgba(30,90,200,.48), inset 0 1px 0 #fff; }
    }
    @keyframes next-sheen{
      0%{ left:-60%; }
      100%{ left:140%; }
    }

    @media (prefers-reduced-motion: reduce){
      .next-btn{ animation: none; }
      .next-btn::after{ animation: none; opacity:.45; }
    }


  .finish-btn{
    position: fixed; 
    /*right: calc(clamp(12px, 3vw, 28px) + min(560px, 44vw) + 10px); */
    right: calc(clamp(12px, 3vw, 28px) + var(--dockW) + 10px);
    top: 50%; transform: translateY(-50%);
    z-index: 2; padding: 12px 18px; border-radius: 999px; font-weight: 900; letter-spacing: .02em; font-size: 14px; color: #6b4a00;
    background: linear-gradient(180deg,#fff3b0,#ffd069); border: 1px solid rgba(160,120,20,.6);
    box-shadow: 0 10px 26px rgba(180,140,30,.45), inset 0 1px 0 #fff; cursor: pointer; opacity: 0; pointer-events: none; transform-origin: center;
    transition: opacity .2s ease, transform .2s ease; overflow: hidden;
  }
  .finish-btn.show{ opacity:1; pointer-events:auto; }
  .finish-btn:hover{ transform: translateY(-50%) scale(1.03); }
  .finish-btn::after{
    content:""; position:absolute; top:-120%; left:-60%; width:45%; height:320%;
    background: linear-gradient(90deg, rgba(255,255,255,0), rgba(255,255,255,.65), rgba(255,255,255,0));
    transform: rotate(25deg); animation: sheen 2.2s linear infinite;
  }
  @keyframes sheen{ 0%{ left:-60%; } 100%{ left: 140%; } }

  @media (prefers-reduced-motion: reduce){
    .aquarium, .ripples{ transition:none; animation:none; }
    .aquarium video{ filter:none; }
    .finish-btn::after{ animation: none; }
  }

  
  .cards > .card.fixed{ height: var(--fixedH); }
  .cards > .card.locked{ pointer-events:none; }

  
  /* ===== Progress dock ===== */
  .progress-dock{
    position: fixed; left: clamp(12px, 3vw, 28px);
    top: calc(var(--hdrH) + clamp(12px, 1.5vw, 18px));
    z-index: 2; display: grid; gap: 14px; width: min(340px, 40vw); align-content: start;
  }

  /* NEW: compact head row placing the ring on the left and the single collapsible button on the right */
  .progress-head{
    display: grid;
    grid-template-columns: auto 1fr;
    gap: 12px;
    align-items: center;
  }

  .ring{
    --p: 0; --track: rgba(255,255,255,.14); --fillA: #40dd75; --fillB: #3ee6ff;
    width: 140px; height: 140px; border-radius: 50%; position: relative;
    background: conic-gradient(var(--fillA), var(--fillB)) 0/0 0 no-repeat,
                conic-gradient(var(--fillB) calc(var(--p)*1turn), var(--track) 0);
    box-shadow: 0 10px 30px rgba(30,140,255,.35), 0 0 0 1px rgba(160,210,255,.25) inset;
    transition: background .6s ease;
  }
  .ring::before{ content:""; position:absolute; inset:8px; border-radius:50%; background: rgba(7,15,30,.92); box-shadow: inset 0 0 0 1px rgba(160,210,255,.25); }
  .ring::after{ content:""; position:absolute; inset:-6px; border-radius:50%;
    background: radial-gradient(closest-side, rgba(64,221,117,.28), transparent),
                radial-gradient(closest-side, rgba(62,230,255,.25), transparent);
    filter: blur(8px); opacity:.7; pointer-events:none; }
  .ring-core{ position:absolute; inset:0; display:grid; place-items:center; text-align:center; }
  .ring-count{ font-weight:900; font-size: 28px; letter-spacing:.4px; color:#eaf7ff; }
  .ring-caption{ font-size:12px; opacity:.85; text-transform: uppercase; letter-spacing:.12em; color:#dff3ff; }

  .segbar{ display: grid; grid-auto-flow: column; gap: 6px; align-items: center;
    background: rgba(8,18,38,.42); border:1px solid rgba(160,210,255,.30); box-shadow: 0 8px 22px rgba(0,20,60,.28);
    padding: 10px 12px; border-radius: 12px; }
  .seg{ height: 8px; width: 100%; border-radius: 6px; background: rgba(255,255,255,.18); }
  .seg.on{ background: linear-gradient(90deg, #40dd75, #3ee6ff); box-shadow: 0 0 16px rgba(64,221,117,.55); }

  .progress-toast{ min-height: 22px; width: max-content; font-size: 12px; font-weight:800; color:#0a2a6b;
    background: linear-gradient(180deg,#fffbd1,#ffe27a); border:1px solid rgba(180,160,60,.6);
    border-radius: 999px; padding: 4px 10px; opacity: 0; transform: translateY(-6px);
    transition: opacity .25s ease, transform .25s ease; box-shadow: 0 8px 18px rgba(180,160,60,.35); }
  .progress-toast.show{ opacity:1; transform: translateY(0); }

  /* ===== NEW: single light-blue Collapse/Expand button (sits beside the ring) ===== */
  .collapse-btn{
    appearance:none;
    display:inline-flex; align-items:center; justify-content:center;
    height: 42px; padding: 0 12px;
    border-radius: 10px;
    border:1px solid rgba(120,170,255,.55);
    background: linear-gradient(180deg,#e8f5ff,#cfe9ff);
    color:#0a2a6b; font-weight: 900; letter-spacing:.02em; font-size: 14px;
    box-shadow: 0 6px 18px rgba(30,90,200,.28), inset 0 1px 0 #fff;
    cursor:pointer;
  }
  .collapse-btn:focus-visible{ outline:3px solid #fff; outline-offset:2px; box-shadow: 0 0 0 4px rgba(255,255,255,.3), 0 0 18px rgba(120,170,255,.55); }
  .collapse-btn:active{ transform: translateY(1px); }

  /* ===== NEW: one-click fold state (hide progress, replay button, and the countdown bar) ===== */
  .ui-collapsed .progress-dock .ring,
  .ui-collapsed .progress-dock .segbar,
  .ui-collapsed .progress-dock .progress-toast,
  .ui-collapsed #coachReplay,
  .ui-collapsed .collection-countdown{
    display: none !important; /* hide learned progress, toast, replay, and the 'next update' banner */
  }

  /* ===== Old rainbox button: Show Me How Again button==== */
  .rainbow-btn{
    --glow: rgba(255, 255, 255, .75);
    display:inline-flex; align-items:center; justify-content:center; gap:.4em;
    width: 100%;
    padding: 12px 14px;
    border: 0;
    border-radius: 12px;
    font-weight: 1000;
    letter-spacing: .02em;
    font-size: 15px;
    color:#0a2a6b;
    text-shadow: 0 1px 0 rgba(255,255,255,.6);
    cursor:pointer;
    box-shadow:
      0 10px 24px rgba(255,180,60,.25),
      0 0 0 1px rgba(255,255,255,.25) inset;
    background: linear-gradient(90deg,#ff6b6b,#ffb347,#ffe66d,#9cff6f,#53d9ff,#a07bff,#ff6af1,#ff6b6b);
    background-size: 300% 100%;
    animation: rainbowShift 4s linear infinite;
  }
  .rainbow-btn:hover{ transform: translateY(-1px); }
  .rainbow-btn:active{ transform: translateY(0) scale(.98); }
  .rainbow-btn:focus-visible{
    outline: 3px solid #fff;
    outline-offset: 2px;
    box-shadow: 0 0 0 4px rgba(255,255,255,.3), 0 0 18px rgba(255,211,77,.55);
  }
  @keyframes rainbowShift{
    0%{ background-position: 0% 0; }
    100%{ background-position: 300% 0; }
  }
  @media (prefers-reduced-motion: reduce){
    .rainbow-btn{ animation: none; }
  }


  /* Override rainbow button to match the Collapse button (light blue) */
  .rainbow-btn{
    background: linear-gradient(180deg,#e8f5ff,#cfe9ff) !important;
    border: 1px solid rgba(120,170,255,.55) !important;
    box-shadow: 0 6px 18px rgba(30,90,200,.28), inset 0 1px 0 #fff !important;
    color: #0a2a6b !important;
    text-shadow: 0 1px 0 rgba(255,255,255,.6);
    background-size: auto !important;   /* no wider animated gradient needed */
    animation: none !important;         /* disable rainbow shifting animation */
  }

  .rainbow-btn:focus-visible{
    outline: 3px solid #fff;
    outline-offset: 2px;
    box-shadow: 0 0 0 4px rgba(255,255,255,.3), 0 0 18px rgba(120,170,255,.55);
  }



  /* Enlarge Toastr popups */
  #toast-container > .toast {
    min-width: 250px;
    border-radius: 10px;
  }
  #toast-container > .toast-success { font-size: 15px; }

  /* ===== Celebration overlay ===== */
  .celebration{ position: fixed; inset: var(--hdrH) 0 0 0; display: none; align-items: center; justify-content: center; z-index: 999;
    background: radial-gradient(1200px 600px at 20% 10%, rgba(140,200,255,.15), transparent 55%),
                radial-gradient(1000px 500px at 80% 20%, rgba(60,170,255,.12), transparent 60%),
                rgba(10,18,34,.35);
    backdrop-filter: blur(16px) saturate(140%); -webkit-backdrop-filter: blur(16px) saturate(140%); opacity: 0; }
  .celebration.show{ display:flex; }
  .celebration .glass-card{ position:relative; padding: 0; border-radius: 0; background: none; border: 0; box-shadow: none; transform: translateY(8px) scale(.985); opacity: 0; text-align: center; }
  .media{ position:relative; width: min(86vw, 1100px); aspect-ratio: 16 / 9; display: block; }
  .halo-behind{ position:absolute; left:50%; top:50%; transform: translate(-50%, -50%); width: min(60%, 700px); aspect-ratio: 1 / 1; border-radius: 50%;
    z-index: 1; pointer-events:none; mix-blend-mode: screen;
    background: radial-gradient(closest-side, rgba(255,240,170,.75) 0%, rgba(255,225,120,.45) 35%, rgba(255,210,100,.28) 55%, rgba(255,195,80,.18) 70%, rgba(255,180,60,0) 85%);
    filter: blur(18px) brightness(1.2) saturate(1.1); }
  .media .win-label{ position:absolute; inset:0; width:100%; height:100%; object-fit: contain; image-rendering: -webkit-optimize-contrast; filter: drop-shadow(0 10px 22px rgba(0,0,0,.5)); z-index: 3; pointer-events:none; }
  .media .platypus{ position:absolute; left:50%; top:50%; transform: translate(-50%, -50%); height: min(62%, 520px); width: auto; image-rendering: -webkit-optimize-contrast; filter: drop-shadow(0 12px 28px rgba(0,0,0,.45)); z-index: 2; }

  /* ===== Vessels ===== */
  .vessels-layer{ position: fixed; inset: var(--hdrH) 0 0 0; z-index: 2; pointer-events: none; overflow: visible; }
  .vessel{ position:absolute; top: calc(58%); transform: translateX(110vw) scale(1.08); opacity: 0; will-change: transform, opacity; image-rendering: -webkit-optimize-contrast; filter: drop-shadow(0 8px 18px rgba(0,0,0,.35)); }
  .vessel.sub{ width: min(34vw, 460px); } .vessel.boat{ width: min(30vw, 420px); }
  .vessel.run{ opacity: 1; animation: sail-left 9s linear forwards; }
  @keyframes sail-left{ 0%{ transform: translateX(110vw) scale(1.08); } 100%{ transform: translateX(-130vw) scale(1.08); } }

  @keyframes celebIn { from { opacity: 0; } to { opacity: 1; } }
  @keyframes cardIn  { 0%{ opacity:0; transform: translateY(12px) scale(.975); } 100%{ opacity:1; transform: translateY(0) scale(1);} }
  @keyframes celebOut{ from { opacity:  1; } to { opacity: 0; } }
  @keyframes cardOut { 0%{ opacity:1; transform: translateY(0) scale(1);} 100%{ opacity:0; transform: translateY(10px) scale(.985);} }
  .celebration.anim-in{ animation: celebIn 600ms ease forwards; }
  .celebration.anim-in .glass-card{ animation: cardIn 700ms cubic-bezier(.2,.9,.2,1.0) 80ms forwards; }
  .celebration.anim-out{ animation: celebOut 600ms ease forwards; }
  .celebration.anim-out .glass-card{ animation: cardOut 500ms ease forwards; }

  @media (max-width: 560px){
    .media{ width: min(94vw, 560px); }
    .media .platypus{ height: min(64%, 360px); }
    .finish-btn{ right: clamp(12px, 3vw, 28px); top:auto; bottom: calc(12px + env(safe-area-inset-bottom)); transform:none; }
    .vessel.sub{ width: min(56vw, 420px); }
    .vessel.boat{ width: min(52vw, 400px); }
  }

 /* ===== Kids Collection grid (Fallout-style mini cards) ===== */
.kids-collection{
  padding: clamp(18px,3vw,26px);
  position: relative;
  z-index: 3;
}

/* Frosted glass panel behind the entire collection section */
.kids-collection .glass-backdrop{
  position: absolute;
  inset: 0;
  border-radius: 16px;
  background:
    linear-gradient(180deg, rgba(8,18,38,.60), rgba(8,18,38,.38)),
    rgba(10,18,34,.35);
  border: 1px solid rgba(160,210,255,.28);
  box-shadow:
    inset 0 1px 0 rgba(255,255,255,.12),
    0 10px 30px rgba(0,20,60,.35);
  backdrop-filter: blur(12px) saturate(135%);
  -webkit-backdrop-filter: blur(12px) saturate(135%);
  pointer-events: none;
  z-index: 0;
}
/* Bring content above the glass */
.kids-collection > .collect-title,
.kids-collection > .collect-nav,
.kids-collection > .collect-grid,
.kids-collection > .empty-hint{
  position: relative;
  z-index: 1;
}

.kids-collection .collect-title{
  margin: -10px 0 14px;
  font-weight: 900;
  font-size: clamp(18px,2.2vw,30px);
  color:#eaf7ff;
  text-shadow: 0 2px 10px rgba(0,0,0,.4);
    font-family: "Super Shape", system-ui, -apple-system, "Segoe UI",
               Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif !important;
  font-weight: 400;     
  letter-spacing: .02em; 
  line-height: 1.12;
}

/* Pagination controls */
.collect-nav{
  display:flex; align-items:center; gap:10px;
  margin: 6px 0 22px;
}
.collect-nav .nav-btn{
  width:50px; height:50px;  /* bigger */
  font-size:22px;
  color:#ffbf00;
  border:1px solid #ffbf00;
  background: linear-gradient(180deg, rgba(60,40,0,.8), rgba(60,40,0,.55));
  box-shadow: 0 0 12px rgba(255,211,77,.5), inset 0 1px 0 rgba(255,255,255,.12);
}
.collect-nav .page-label{
  font-size:16px;
  color:#ffd34d;    /* gold yellow */
}
.collect-nav .nav-btn:disabled{ opacity:.45; cursor:not-allowed; }
.collect-nav .page-label{ font-size:22px; letter-spacing:.06em; opacity:.9; 
    font-family: "Super Shape", system-ui, -apple-system, "Segoe UI",
               Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif !important;
  font-weight: 400;      
  letter-spacing: .02em; 
  line-height: 1.12;
}

/* Grid of mini-cards */
.kids-collection .collect-grid{
  display:grid;
  grid-template-columns: repeat(3, minmax(0,1fr));
  gap: 16px;
}
/* Only show current page's 3 items */
.collect-grid .card-scene{ display:none; }
.collect-grid .card-scene.show{ display:block; }

@media (max-width: 860px){
  .kids-collection .collect-grid{ grid-template-columns: repeat(2, minmax(0,1fr)); }
}
@media (max-width: 560px){
  .kids-collection .collect-grid{ grid-template-columns: 1fr; }
}

/* ===== Collection countdown banner (fixed above the right card dock) ===== */
.collection-countdown{
  position: fixed;
  right: clamp(12px, 3vw, 28px);
  top: calc(var(--hdrH) + 6px);
 /* width: min(400px, 44vw);*/
  width: min(400px, var(--dockW));
  z-index: 3;
  pointer-events: none;
}
.collection-countdown .cd-wrap{
  display: grid;
  grid-template-columns: 1fr auto;
  align-items: center;
  gap: 8px 10px;
  padding: 8px 12px 10px;
  border-radius: 12px;
  background: linear-gradient(180deg, rgba(8,18,38,.68), rgba(8,18,38,.42));
  border: 1px solid rgba(160,210,255,.30);
  backdrop-filter: blur(10px) saturate(135%);
  -webkit-backdrop-filter: blur(10px) saturate(135%);
  box-shadow: 0 10px 24px rgba(0,20,60,.35), inset 0 1px 0 rgba(255,255,255,.12);
  color: #eaf7ff;
  text-shadow: 0 1px 0 rgba(0,0,0,.45);
}
.cd-label{
  font-size: 12px;
  font-weight: 900;
  text-transform: uppercase;
  letter-spacing: .14em;
  opacity: .92;
}
.cd-eta{
  font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
  font-weight: 900;
  font-size: 14px;
  background: linear-gradient(90deg, #aee6ff, #eaf6ff);
  -webkit-background-clip: text; background-clip:text;
  -webkit-text-fill-color: transparent; color: transparent;
  text-shadow: 0 0 10px rgba(80,160,255,.35);
}
.cd-date{
  grid-column: 1 / -1;
  font-size: 12px;
  opacity: .85;
}
.cd-track{
  grid-column: 1 / -1;
  height: 6px; border-radius: 999px;
  background: rgba(255,255,255,.14);
  box-shadow: inset 0 1px 0 rgba(255,255,255,.12);
  overflow: hidden;
}
.cd-fill{
  display: block; height: 100%; width: 0%;
  background: linear-gradient(90deg, #40dd75, #3ee6ff);
  box-shadow: 0 0 12px rgba(64,221,117,.45);
  transition: width .6s ease;
}

/* ===== Fallout-style mini cards (GIF-friendly + pale-blue theme) ===== */
.f76{
  --color-yellow:#ddb724; --color-off-black:#352d2a; --color-white:#e3dfc6; --color-bone:#e7e4d5;
  --color-main:#8cd1b3; --color-main-lighten:#afdbbf; --color-main-lighten2:#b2efcd; --color-main-dark:#84a782;
  --color-backing-top:#4e79ad; --color-backing-light1:#b6cff3; --color-backing-light2:#c8dcf1; --color-backing-light3:#88b4ed; --color-backing-light4:#2f5c8c;

  --meta-gap: 3.2rem;

  --card-radius: 9px;
  --card-border: .5rem;
  --frame: var(--color-bone);

  --bump-size:  6.8rem;
  --bump-offset: 1.6rem;

  --sheen-speed: 4.6s;
}

.f76 .card-scene{ width:100%; aspect-ratio:36/46; perspective:900px; }
.f76 .card{
  height:100%; width:100%; position:relative;
  transform-style:preserve-3d; transform:rotateY(180deg);
  cursor:pointer;
}
.f76 .card.card--flipped{ animation:f76Flip .28s linear forwards; }
.f76 .card.card--unflip{ animation:f76Unflip .28s linear forwards; }
@keyframes f76Flip{
  0%{transform:rotateZ(0) rotateY(180deg);}
  50%{transform:rotateZ(-10deg) rotateY(90deg);}
  100%{transform:rotateZ(0) rotateY(0);}
}
@keyframes f76Unflip{
  0%{transform:rotateZ(0) rotateY(0);}
  50%{transform:rotateZ(-10deg) rotateY(90deg);}
  100%{transform:rotateZ(0) rotateY(180deg);}
}

/* === Unified card face rules === */
.f76 .card-face {
  position: absolute;
  inset: 0;
  backface-visibility: hidden;
  border-radius: var(--card-radius);
  border: var(--card-border) solid var(--frame);
  box-shadow: 0 0 3px 2px #4e4e4e;
  overflow: hidden;
  height: 100%;
}

/* === Card back (fix white bottom) === */
.f76 .card-backing {
  transform: rotateY(180deg);
  display: flex;
  flex-direction: column;
  position: absolute; inset: 0;
  background: #90c6ff;
  border-radius: var(--card-radius);
}

/* top banner and back-main no longer control card height */
.f76 .card-backing .top-banner { height: 5.6rem; background: var(--color-backing-top); }

.f76 .card-backing .back-main {
  flex: 1;
  display: flex; flex-direction: column;
  justify-content: center; align-items: center;
  padding: 10px;
  background: linear-gradient(
    135deg,
    var(--color-backing-light1) 0 25%,
    var(--color-backing-light2) 25% 50%,
    var(--color-backing-light3) 50% 75%,
    var(--color-backing-light4) 75% 100%
  );
}

.f76 .card-backing.theme-blue { background: #90c6ff; }
.f76 .flip-hint{ margin-top:12px; font-size:25px; color:#15365c; font-weight:800; 
    font-family: "Super Shape", system-ui, -apple-system, "Segoe UI",
               Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif !important;
  font-weight: 400;      
  letter-spacing: .02em; 
  line-height: 1.12;
}

.f76 .vault-tec{ position:relative; width:70%; height:80px; margin:8px auto; }
.f76 .vault-tec .center{ width:64px; height:64px; border-radius:50%; border:8px solid var(--color-bone); margin:auto; }
.f76 .vault-tec .lines{ position:absolute; inset:0; display:grid; grid-template-columns:40% 1fr 40%; }
.f76 .vault-tec .line{ display:flex; flex-direction:column; justify-content:center; gap:10px; }
.f76 .vault-tec .line-inner{ height:10px; width:60%; background:var(--color-bone); position:relative; }
.f76 .vault-tec .line--left .line-inner::before{ content:""; position:absolute; left:-5%; width:10%; height:100%; background:var(--color-bone); border-radius:50% 0 0 50%; }
.f76 .vault-tec .line--right{ grid-column:3; }
.f76 .vault-tec .line--right .line-inner::before{ content:""; position:absolute; right:-5%; width:10%; height:100%; background:var(--color-bone); border-radius:0 50% 50% 0; }

/* ---------- front (revealed) layout ---------- */
.f76 .card-front{
  display:flex; flex-direction:column;
  background:var(--color-bone);
  position: relative;
  isolation: isolate;
}
.f76 .card-front h1{
  position:relative; margin:0;
  font-size:1.8rem; line-height: 4.6rem;
  color:#ffffff; background:var(--color-main-dark);
  text-align:center; padding-left:3.2rem;
  border-top-right-radius:1rem;
    font-family: "Super Shape", system-ui, -apple-system, "Segoe UI",
               Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif !important;
  font-weight: 400;      
}

/* === Numeric bump === */
.f76 .bump{
  position:absolute; left:-1.6rem; top:-1.6rem;
  height:var(--bump-size); width:var(--bump-size);
  border: var(--card-border) solid var(--frame);
  border-radius:.8rem;
  box-shadow: none;
  z-index: 3;
}
.f76 .bump .outer{ position:absolute; inset:0; padding:.3rem; background:var(--color-main-dark); border-radius:.3rem; display:block; }
.f76 .bump .inner{
  display:block; height:100%; width:100%;
  background:#fff; border-radius:3px; text-align:center;
  font-weight:900; font-size:1.6rem; line-height:5.2rem; color:#4e4943;
}
.f76 .bump::after{ content:""; position:absolute; inset:0; border-radius: inherit; pointer-events:none; box-shadow: none; z-index: -1; }

/* Image well */
.f76 .main-pane{ position:relative; overflow:hidden; padding:0 1.2rem; display:flex; flex: 1 1 auto; }
.f76 .main-pane::before{
  content:""; position:absolute; top:-42rem; left:-32rem; height:69.5rem; width:100rem; border-radius:50%;
  background:repeating-conic-gradient(from 90deg,
    var(--color-main-lighten2) 0 25deg, var(--color-bone) 0 35deg,
    var(--color-main) 0 40deg, var(--color-bone) 0 47deg,
    var(--color-main-lighten) 0 50deg, var(--color-bone) 0 55deg,
    var(--color-main) 0 127deg, var(--color-bone) 0 132deg,
    var(--color-main-lighten) 0 135deg, var(--color-bone) 0 140deg,
    var(--color-main) 0 145deg, var(--color-bone) 0 155deg,
    var(--color-main-lighten2) 0 360deg);
  z-index:0;
}
.f76 img.slugger{
  display: block; position: relative; left: 50%; transform: translateX(-50%);
  margin-top: 5rem; width: clamp(260px, 110%, 560px); max-width: none; height: auto;
  image-rendering: -webkit-optimize-contrast; image-rendering: pixelated;
}

.card-front h1 .title-text { color: #006ef5; }

/* Description + badges */
.f76 .desc{
  align-self:end; min-height:28%;
  margin-top: var(--meta-gap);
  padding: 1.2rem 1.4rem 1.8rem;
  text-align:center; display:flex; align-items:center; justify-content:center;
  background:linear-gradient(to bottom, #b8cbad, #ede8d4 18% 70%, #a5bc9e);
  border:2px solid var(--color-off-black); border-radius:12px; position:relative;
}
.f76 .desc p{
      font-family: "Super Shape", system-ui, -apple-system, "Segoe UI",
               Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif !important;
  font-weight: 400;   
}

.f76 .desc p{ margin:0; font-size:1.4rem; color:#0097f5; }

.f76 .special{
  position:absolute; bottom: calc(100% + .4rem); left: .6rem;
  height:3.2rem; padding:.25rem .55rem;
  background:var(--color-main); border:.2rem solid #fff; color:var(--color-off-black);
  font-size:2.8rem; line-height:130%; border-radius:.35rem; transform:skew(-7deg,-10deg);
  box-shadow:0 3px 10px rgba(0,0,0,.15);
  z-index:2; display: grid; place-items: center; line-height:1; isolation: isolate;
}
.f76 .level{
  position:absolute; bottom: calc(100% + .4rem); right: .2rem;
  height:2.6rem; display:inline-block; background:var(--color-main-dark); color:var(--color-off-black);
  font-size:1.8rem; padding:2px 6px 2px 0;
  border-top:2px solid var(--color-off-black); border-bottom:2px solid var(--color-off-black);
  border-left:2px solid var(--color-off-black); border-right:1px solid #6c6c6c; border-radius:6px;
  box-shadow:0 3px 10px rgba(0,0,0,.12);
  z-index:2;
}
.f76 .level .star, .f76 .level .star::before, .f76 .level .star::after{
  border-color:transparent var(--color-off-black) transparent transparent; border-width:1rem .5rem 1rem 0; border-style:solid;
}
.f76 .level .star{ display:inline-block; width:1.5rem; transform:rotate(270deg); margin-top:.4rem; margin-left:.8rem; position:relative; }
.f76 .level .star::before{ content:""; position:absolute; left:.9rem; top:-.9rem; transform:rotate(68deg); }
.f76 .level .star::after{ content:""; position:absolute; left:.9rem; top:-1.1rem; transform:rotate(-68deg); }

/* Allow overflow for bump */
.f76 .card, .f76 .card-face{ overflow: visible; }

/* ---------- Pale blue theme ---------- */
.f76 .card-front.theme-blue{ background:#e8f3ff; }
.f76 .card-front.theme-blue h1{ background:#78aeea; color:#eaf6ff; }
.f76 .card-front.theme-blue .bump{ border-color:#cfe2ff; }
.f76 .card-front.theme-blue .bump .outer{ background:#78aeea; }
.f76 .card-front.theme-blue .bump .inner{ background:#eaf6ff; color:#2a3a4a; }
.f76 .card-front.theme-blue .main-pane::before{ display:none; }
.f76 .card-front.theme-blue .desc{ background:linear-gradient(to bottom, #d7eaff, #c2defd 18% 70%, #cfe3ff); border-color:#2a3a4a; }
.f76 .card-front.theme-blue .special{ background:#a9c9ff; color:#243447; border-color:#fff; box-shadow:0 3px 10px rgba(111,166,230,.35); }
.f76 .card-front.theme-blue .level{ background:#6fa6e6; color:#243447; box-shadow:0 3px 10px rgba(111,166,230,.25); }
.f76 .card-front.theme-blue.card-face{ border-color: var(--frame); }

@media (max-width:960px){
  .f76{ --meta-gap: 2.6rem; }
  .f76 .card-front h1{ font-size:2.1rem; padding-left:3rem; }
  .f76 .bump{ height:6rem; width:6rem; border-width:3px; left:-1.2rem; top:-1.2rem; }
  .f76 .bump .inner{ font-size:3.2rem; line-height:5.4rem; }
  .f76 img.slugger{ max-width:95%; margin:1.4rem auto 0; }
  .f76 .desc{ padding:1rem 1.2rem 1.6rem; }
  .f76 .desc p{ font-size:1.5rem; }
  .f76 .special{ bottom: calc(100% + .35rem); height:2.8rem; font-size:2.4rem; }
  .f76 .level{   bottom: calc(100% + .35rem); height:2.4rem; font-size:1.6rem; }
}

/* --- Metallic gloss overlay --- */
.f76 .card-front.theme-blue{
  box-shadow:
    inset 0 1px 0 rgba(255,255,255,.38),
    inset 0 -1px 0 rgba(8,24,44,.12),
    inset 1px 0 0 rgba(255,255,255,.22),
    inset -1px 0 0 rgba(8,24,44,.10);
}
.f76 .card-front.theme-blue::before{
  content:"";
  position:absolute; inset:0; border-radius: inherit; pointer-events: none;
  background:
    linear-gradient(180deg,
      rgba(255,255,255,.35) 0%,
      rgba(255,255,255,.12) 14%,
      rgba(255,255,255,.05) 48%,
      rgba(255,255,255,.16) 64%,
      rgba(255,255,255,0) 100%),
    repeating-linear-gradient(-12deg,
      rgba(255,255,255,.10) 0 1px,
      rgba(255,255,255,0) 1px 6px);
  mix-blend-mode: screen;
  opacity: .8;
  z-index: 2;
}
.f76 .card-front.theme-blue::after{
  content:"";
  position:absolute; inset:0; border-radius: inherit; pointer-events: none;
  background-image: linear-gradient(
    100deg,
    rgba(255,255,255,0) 30%,
    rgba(255,255,255,.85) 50%,
    rgba(255,255,255,0) 70%
  );
  background-repeat: no-repeat;
  background-size: 220% 100%;
  background-position: -120% 0%;
  mix-blend-mode: screen;
  animation: f76SheenBG var(--sheen-speed) linear infinite;
  opacity:.65;
  z-index: 2;
}
@keyframes f76SheenBG{ 0%{ background-position: -120% 0%; } 100%{ background-position: 120% 0%; } }
@media (prefers-reduced-motion: reduce){
  .f76 .card-front.theme-blue::after{ animation: none; opacity:.4; }
}

/* ===== Star visuals (gold glow for current level) ===== */
.f76{ --gold: #ffd34d; --gold-strong: #ffbf26; --gold-soft: rgba(255,220,110,.95); --gold-halo: rgba(255, 255, 60, 0.279); }
.f76 .level .star, .f76 .level .star::before, .f76 .level .star::after{ border-right-color: #708199; }
.f76 .level .star.current-level, .f76 .level .star.current-level::before, .f76 .level .star.current-level::after{ border-right-color: var(--gold) !important; }
.f76 .level .star.current-level{
  filter:
    drop-shadow(0 0 2px  var(--gold-soft))
    drop-shadow(0 0 6px  var(--gold-halo))
    drop-shadow(0 0 14px rgba(255,150,0,.45));
  animation: goldTwinkle 1.6s ease-in-out infinite alternate;
}
@keyframes goldTwinkle{
  0%{ filter: drop-shadow(0 0 2px var(--gold-soft)) drop-shadow(0 0 6px var(--gold-halo)) drop-shadow(0 0 14px rgba(255,150,0,.45)); }
  100%{ filter: drop-shadow(0 0 3px var(--gold-soft)) drop-shadow(0 0 10px var(--gold-halo)) drop-shadow(0 0 22px rgba(255,150,0,.55)); }
}
@media (prefers-reduced-motion: reduce){
  .f76 .level .star.current-level{ animation: none; }
}

/* ===== Badge text only ===== */
.f76 .card-front .special .special__txt{
  font-weight: 1000;
  transform: translateY(-0.12rem);
  color: transparent; -webkit-text-fill-color: transparent;
  background-clip: text; -webkit-background-clip: text;
  -webkit-text-stroke: 1px rgba(0,0,0,.18);
  text-shadow: 0 1px 0 rgba(255,255,255,.45);
}

/* ===== Grade colorways ===== */
.f76 .card-front .special[data-grade="SS"]{ overflow: visible; }
.f76 .card-front .special[data-grade="SS"] .special__txt{
  background-image: linear-gradient(270deg,#fff200,#f96c01,#f90101,#01f1f9,#2301f9,#c7a4ff,#00ff1a,#fff200);
  background-size: 600% 100%;
  animation: diamondShine 2s linear infinite;
  text-shadow: 0 0 12px rgba(255,255,255,.9), 0 0 26px rgba(160,210,255,.7), 0 0 40px rgba(120,200,255,.5);
}
.f76 .card-front .special[data-grade="SS"]::after{
  content: ""; position: absolute; inset: -3px; border-radius: .4rem; pointer-events: none;
  background: radial-gradient(closest-side, rgba(255,255,255,.65), transparent 70%), conic-gradient(from 0deg, rgba(255,255,255,.4), rgba(150,210,255,.28), rgba(255,255,255,.4));
  mix-blend-mode: screen; filter: blur(5px); opacity: .9; animation: ssPulse 1.6s ease-in-out infinite alternate; z-index: -1;
}
@keyframes diamondShine{ from{ background-position: 0% 50%; } to{ background-position: 100% 50%; } }
@keyframes ssPulse{ from{ opacity:.7; transform:scale(1);} to{ opacity:1; transform:scale(1.05);} }
.f76 .card-front .special[data-grade="S"] .special__txt{ background-image: linear-gradient(135deg,#fff2b6,#ffd24d 40%,#b8870d 60%,#ffe07a); }
.f76 .card-front .special[data-grade="A"] .special__txt{ background-image: linear-gradient(135deg,#f2a5a5,#e05555 45%,#7c1212 70%,#f8b0b0); }
.f76 .card-front .special[data-grade="B"] .special__txt{ background-image: linear-gradient(135deg,#9fb7ff,#4a79d6 55%,#173262 85%,#c5d3ff); }
.f76 .card-front .special[data-grade="C"] .special__txt{ background-image: linear-gradient(135deg,#9be2b8,#2d8f5c 55%,#0f4a2b 85%,#c3f1d7); }
@supports not ((-webkit-background-clip:text) or (background-clip:text)){
  .f76 .card-front .special .special__txt{ -webkit-text-stroke: 0; text-shadow:none; }
  .f76 .card-front .special[data-grade="SS"] .special__txt{ color:#6fb3ff; -webkit-text-fill-color:#6fb3ff; }
  .f76 .card-front .special[data-grade="S"]  .special__txt{ color:#d4a017; -webkit-text-fill-color:#d4a017; }
  .f76 .card-front .special[data-grade="A"]  .special__txt{ color:#7c1212; -webkit-text-fill-color:#7c1212; }
  .f76 .card-front .special[data-grade="B"]  .special__txt{ color:#173262; -webkit-text-fill-color:#173262; }
  .f76 .card-front .special[data-grade="C"]  .special__txt{ color:#0f4a2b; -webkit-text-fill-color:#0f4a2b; }
}

/* Back-face bump & fixes */
.f76 .card-backing{ position: absolute; inset: 0; border-radius: var(--card-radius); }
.f76 .card-backing::before{
  content:"";
  position:absolute; top:  calc(-1 * var(--card-border)); right:calc(-1 * var(--card-border));
  width: var(--bump-size); height: var(--bump-size); background: var(--color-backing-top); border-radius: .6rem;
  box-shadow: 0 0 0 var(--card-border) var(--frame), 0 3px 8px rgba(0,0,0,.35);
  z-index: 6; pointer-events: none;
}
.f76 .card-backing .top-banner{ position: relative; }
.f76 .card-backing .top-banner::after{
  content:""; position:absolute; top: .95rem; right: calc(var(--bump-size) - .2rem);
  width: 1.8rem; height: .42rem; background: var(--frame); border-radius: .21rem; z-index: 7; pointer-events:none;
}

/* Force frames to light blue */
.f76 { --frame: #cfe2ff; }
.f76 .card-face, .f76 .card-front.theme-blue.card-face { border-color: var(--frame) !important; }
.f76 .bump, .f76 .card-front.theme-blue .bump { border-color: var(--frame) !important; }
.f76 .card-backing::before { box-shadow: 0 0 0 var(--card-border) var(--frame), 0 3px 8px rgba(0,0,0,.35); }

 /* Remove bump shadows */
.f76 .bump { box-shadow: none !important; }
.f76 .bump::after { box-shadow: none !important; }

 /* Vault-Tec micro-fix */
.f76 .vault-tec .line-inner { width: 100% !important; }
.f76 .vault-tec .line--left .line-inner::before,
.f76 .vault-tec .line--right .line-inner::before { display: none !important; }
.f76 .vault-tec .center { border: 8px solid var(--color-bone); margin: 0 auto; position: relative; z-index: 2; }

.empty-hint {
  text-align: center;
  font-size: 45px;
  color: #ffd34d; /* golden */
  text-shadow: 0 0 8px rgba(255,211,77,.5);
  margin: 20px 0;
  font-weight: 500;
    font-family: "Super Shape", system-ui, -apple-system, "Segoe UI",
               Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif !important;
  font-weight: 400;     
  letter-spacing: .02em; 
  line-height: 1.12;
}

/* ===== First-visit coach / spotlight (English UI) ===== */
.coach {
  position: fixed;
  inset: var(--hdrH) 0 0 0;
  z-index: 10000;
  display: none;
}
.coach.show { display: block; }

.coach-dim {
  position: absolute; inset: 0;
  --x: 50%; --y: 50%; --r: 160px;
  background:
    radial-gradient(circle at var(--x) var(--y),
      transparent var(--r),
      rgba(0,0,0,.72) calc(var(--r) + 1px));
  transition: background .25s ease;
  pointer-events: auto;
}

.coach-tip {
  position: absolute;
  max-width: 340px;
  padding: 14px 16px 12px;
  background: linear-gradient(180deg, rgba(8,18,38,.88), rgba(8,18,38,.72));
  border: 1px solid rgba(160,210,255,.35);
  border-radius: 12px;
  box-shadow: 0 12px 28px rgba(0,0,0,.45), inset 0 1px 0 rgba(255,255,255,.12);
  color: #eaf6ff;
  text-shadow: 0 1px 0 rgba(0,0,0,.45);
  transform: translate(-50%, 0);
}

.coach-body { font-size: 14px; line-height: 1.6; }
.coach-nav {
  display: flex; align-items: center; gap: 8px; margin-top: 10px;
}
.coach-btn {
  appearance: none; border: 1px solid rgba(160,210,255,.4);
  background: linear-gradient(180deg,#e8f5ff,#cfe9ff);
  color:#0a2a6b; padding: 6px 10px; border-radius: 10px; font-weight: 800;
  cursor: pointer; box-shadow: 0 4px 12px rgba(30,90,200,.28);
}
.coach-btn:disabled { opacity:.5; cursor:not-allowed; }
.coach-btn.coach-next {
  background: linear-gradient(180deg,#fff3b0,#ffd069);
  color:#6b4a00; border-color: rgba(160,120,20,.55);
}
.coach-btn.coach-skip { background: transparent; color:#eaf6ff; border-color: rgba(160,210,255,.35); }
.coach .spacer { flex: 1; }

@media (max-width: 560px){
  .coach-tip{ left: 50% !important; right: auto !important; transform: translate(-50%,0); }
}


</style>
{% endblock %}

{% block content %}
<section class="kids-stage">
  <div class="aquarium" id="aquarium" aria-hidden="true">
    <video id="fishVideo" src="{% static 'card1.mp4' %}" preload="metadata" autoplay muted playsinline loop></video>
  </div>
  <div class="ripples" aria-hidden="true"></div>

  <div class="vessels-layer" id="vessels" aria-hidden="true">
    <img id="submarineGif" class="vessel sub" src="{% static 'submarine.gif' %}" alt="">
    <img id="boatGif" class="vessel boat" src="{% static 'boat.gif' %}" alt="">
  </div>

  <div class="celebration" id="celebration" aria-hidden="true">
    <div class="glass-card">
      <div class="media">
        <div class="halo-behind" aria-hidden="true"></div>
        <img class="platypus" src="{% static 'platypus_dance.gif' %}" alt="Dancing platypus">
        <img class="win-label" src="{% static 'win.png' %}" alt="Victory banner">
      </div>
    </div>
  </div>

  <!-- ===== Bi-weekly Monday countdown banner ===== -->
  <div id="collectionCountdown" class="collection-countdown" role="status" aria-live="polite">
    <div class="cd-wrap">
      <span class="cd-label">Next Animal Collection update</span>
      <span class="cd-eta" id="cdEta">--d --:--:--</span>
      <!--<span class="cd-date" id="cdDate">Target: Mon -- --</span>
      <div class="cd-track"><b class="cd-fill" id="cdFill"></b></div>-->
    </div>
  </div>

  <aside class="progress-dock" id="progressDock">
    <!-- NEW: head row = ring (left) + single light-blue collapse/expand button (right) -->
    <div class="progress-head">
      <div class="ring" id="progressRing" role="progressbar" aria-valuemin="0" aria-valuemax="0" aria-valuenow="0" aria-label="Lesson progress">
        <div class="ring-core">
          <div class="ring-count"><span id="doneCount">0</span>/<span id="totalCount">0</span></div>
          <div class="ring-caption">learned</div>
        </div>
      </div>

      <!-- This is the ONLY control for folding UI sections; it collapses: progress + replay + countdown -->
      <button id="collapseToggle"
              class="collapse-btn"
              type="button"
              aria-pressed="false"
              aria-controls="progressDock collectionCountdown"
              aria-expanded="true">
        â–¾ Collapse
      </button>
    </div>

    <div class="segbar" id="segbar" aria-hidden="true"></div>
    <div class="progress-toast" id="progressToast" aria-live="polite"></div>

    <!-- Show Me How Again (will be hidden when collapsed) -->
    <button id="coachReplay" class="rainbow-btn" type="button" aria-label="Replay spotlight tutorial">Show Me How Again</button>
  </aside>

  <div class="card-dock">
    <div class="sleepy-wrap" aria-hidden="true">
      <img class="sleepy-platypus" src="{% static 'platypus_sleep.gif' %}" alt="">
    </div>

    <div class="cards" id="cards">
      {% for c in db_cards %}
      <article
        class="card{% if c.is_starter %} card--starter{% endif %}{% if c.is_starter or forloop.first %} active{% endif %}"
        data-card="{{ c.card_order }}"
        data-read-sec="{{ c.read_seconds|default:4 }}"
        tabindex="0"
        aria-expanded="false"
        aria-controls="details-{{ c.card_order }}">
        <div class="hud" aria-hidden="true">
          <div class="read-timer"><span class="read-dot"></span><span class="read-text">Keep readingâ€¦ {{ c.read_seconds|default:4 }}s</span></div>
          <div class="check-badge">âœ“</div>
        </div>
        <h3>{{ c.title }}</h3>
        <div class="qa-wrap">
          {{ c.lead_html|safe }}
          <div class="details" id="details-{{ c.card_order }}">{{ c.detail_html|safe }}</div>
        </div>
        <span class="hint" aria-hidden="true">{{ c.hint_text }}</span>
      </article>
      {% endfor %}
    </div>
  </div>

  <button id="nextBtn" class="next-btn" type="button" aria-label="Next card">Next</button>
  <button id="finishBtn" class="finish-btn" type="button" aria-label="Finish">Finish</button>
</section>

<!-- Kids Collection Cards -->
<section class="kids-collection f76" aria-label="Your Ocean Cards">
  <div class="glass-backdrop" aria-hidden="true"></div>

  <h2 class="collect-title"> Cards Collection</h2>

  <!-- 3 pages -->
  <div class="collect-nav" aria-label="Collection pages">
    <button id="collectPrev" class="nav-btn" type="button" aria-label="Previous 3 cards">â€¹</button>
    <span id="collectPageInfo" class="page-label">1 / 1</span>
    <button id="collectNext" class="nav-btn" type="button" aria-label="Next 3 cards">â€º</button>
  </div>

  <div class="collect-grid" id="collectGrid"></div>
  <!-- Empty state hint -->
  <div id="emptyHint" class="empty-hint" role="status" aria-live="polite" style="display:none;">
    No cards yet â€” Tap to learn a knowledge card!
  </div>
</section>

<!-- First-visit tutorial overlay (English UI) -->
<div id="coach" class="coach" aria-hidden="true">
  <div class="coach-dim"></div>
  <div class="coach-tip" id="coachTip" role="dialog" aria-live="polite" aria-modal="true">
    <div class="coach-body" id="coachText">â€¦</div>
    <div class="coach-nav">
      <button type="button" class="coach-btn coach-skip" id="coachSkip">Skip</button>
      <div class="spacer"></div>
      <button type="button" class="coach-btn coach-back" id="coachBack">Back</button>
      <button type="button" class="coach-btn coach-next" id="coachNext">Next</button>
    </div>
  </div>
</div>

<!-- Server-provided JSON for collection cards -->
<script id="collectCardsData" type="application/json">{{ collect_cards_json|default:"[]"|safe }}</script>
{% endblock %}

{% block page_scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
  const STATIC_BASE = "{% get_static_prefix %}";

  /* Toastr "success" with a graceful fallback pill */
  function greenToast(msg, title='Unlocked!'){
    if (window.toastr && typeof toastr.success === 'function'){
      toastr.options = Object.assign({
        closeButton: false,
        newestOnTop: true,
        progressBar: true,
        positionClass: "toast-bottom-right",
        timeOut: 2600,
        extendedTimeOut: 1200,
        tapToDismiss: true,
        preventDuplicates: true
      }, toastr.options || {});
      toastr.success(msg, title);
    }else{
      const t = document.getElementById('progressToast');
      if(!t) return;
      t.textContent = msg;
      t.classList.add('show');
      setTimeout(()=> t.classList.remove('show'), 2600);
    }
  }

  window.pageInit = function(){
    const hdr = document.getElementById('siteHeader');
    const applyHdrH = () => document.documentElement.style.setProperty('--hdrH', (hdr?.offsetHeight || 80) + 'px');
    applyHdrH(); window.addEventListener('resize', applyHdrH);

    const aquarium   = document.getElementById('aquarium');
    const fishVideo  = document.getElementById('fishVideo');
    const celebration= document.getElementById('celebration');
    const cardsWrap  = document.getElementById('cards');
    const nextBtn    = document.getElementById('nextBtn');
    const finishBtn  = document.getElementById('finishBtn');

    const ring   = document.getElementById('progressRing');
    const segbar = document.getElementById('segbar');
    const toast  = document.getElementById('progressToast');
    const doneEl = document.getElementById('doneCount');
    const totalEl= document.getElementById('totalCount');

    const replayBtn = document.getElementById('coachReplay');

    const submarine = document.getElementById('submarineGif');
    const boat = document.getElementById('boatGif');

    /* NEW: One-click Collapse/Expand control & persisted state */
    const collapseToggle = document.getElementById('collapseToggle');
    const rootEl = document.documentElement;
    const COLLAPSE_KEY = 'kidsUiCollapsedV1';

    function setCollapsed(on){
      rootEl.classList.toggle('ui-collapsed', !!on);
      collapseToggle.setAttribute('aria-pressed', String(!!on));
      collapseToggle.setAttribute('aria-expanded', String(!on));
      collapseToggle.textContent = on ? 'â–¸ Expand' : 'â–¾ Collapse';
      try{ localStorage.setItem(COLLAPSE_KEY, on ? '1' : '0'); }catch(_){}
    }
    // Restore last state
    try{
      const saved = localStorage.getItem(COLLAPSE_KEY) === '1';
      setCollapsed(saved);
    }catch(_){}

    collapseToggle.addEventListener('click', ()=> setCollapsed(!rootEl.classList.contains('ui-collapsed')));

    /* Collection pager refs */
    const collectGrid = document.getElementById('collectGrid');
    const collectPrev = document.getElementById('collectPrev');
    const collectNext = document.getElementById('collectNext');
    const collectPageInfo = document.getElementById('collectPageInfo');
    const emptyHint = document.getElementById('emptyHint');
    const COLLECT_PAGE_SIZE = 3;
    let collectPage = 0;

    /* Pull collectible card data */
    let COLLECT_CARDS = [];
    try{
      const tag = document.getElementById('collectCardsData');
      COLLECT_CARDS = JSON.parse(tag?.textContent || '[]') || [];
    }catch(e){ COLLECT_CARDS = []; }

    // Learn cards
    const cards = Array.from(cardsWrap.querySelectorAll('.card'));
    let activeIndex = cards.findIndex(c => c.classList.contains('active'));
    if (activeIndex < 0) activeIndex = 0;

    // Per-card state
    const state = new Map();
    const ensure = (id)=>{ if(!state.has(id)) state.set(id, {timerId:null, startTime:null, done:false, unlocked:false}); return state.get(id); };

    // Background video loops
    fishVideo.loop = true;

    // Background fishN.mp4 switching per learn card
    const MAX_FISH = 19;
    const knownMissing = new Set();
    let fishSwitchToken = 0;
    const fishUrl = (n) => STATIC_BASE + 'card' + n + '.mp4';
    function hideFish(){ document.getElementById('aquarium').classList.remove('bg-on'); try{ fishVideo.pause(); }catch(e){} }
    function setFishForCard(i){
      const nRaw = parseInt(cards[i]?.dataset?.card, 10);
      let n = isNaN(nRaw) ? (i+1) : nRaw;
      n = Math.max(1, Math.min(MAX_FISH, n));
      while(n > 1 && knownMissing.has(n)) n--;
      const url = fishUrl(n);
      const myToken = ++fishSwitchToken;
      const onLoaded = () => {
        if (myToken !== fishSwitchToken) return cleanup();
        fishVideo.loop = true; fishVideo.currentTime = 0;
        document.getElementById('aquarium').classList.add('bg-on');
        fishVideo.play?.().catch(()=>{});
        cleanup();
      };
      const onError = () => { knownMissing.add(n); cleanup(); if(n>1) setFishForCard(i); };
      const cleanup = () => {
        fishVideo.removeEventListener('loadeddata', onLoaded);
        fishVideo.removeEventListener('error', onError);
      };
      if (fishVideo.getAttribute('src') === url){
        fishVideo.loop = true;
        document.getElementById('aquarium').classList.add('bg-on');
        fishVideo.play?.().catch(()=>{});
        return;
      }
      fishVideo.addEventListener('loadeddata', onLoaded);
      fishVideo.addEventListener('error', onError);
      fishVideo.setAttribute('src', url); fishVideo.load();
    }

    // Vessels visuals
    let gameStarted = false;
    let postCelebrationWindow = false;
    const WATER_RISE_MS = 1400, WATER_FALL_MS = 1400;
    const VESSEL_RUN_MS = 9000, LOOP_TOTAL_MS = 60000, LOOP_GAP_MS = 1000;
    function canPlayVessel(){ return (!gameStarted) || postCelebrationWindow; }
    let loopToken = 0;
    function cancelVesselLoops(){ loopToken++; submarine.classList.remove('run'); boat.classList.remove('run'); }
    function startVesselLoop(el, preDelayMs){
      if (!canPlayVessel()) return;
      cancelVesselLoops();
      const myToken = ++loopToken; let elapsed = 0;
      const runOnce = ()=>{
        if (myToken !== loopToken || !canPlayVessel()) return;
        el.classList.remove('run'); void el.offsetWidth; el.classList.add('run');
        setTimeout(()=>{
          if (myToken !== loopToken) { el.classList.remove('run'); return; }
          elapsed += VESSEL_RUN_MS + LOOP_GAP_MS;
          if (elapsed + VESSEL_RUN_MS <= LOOP_TOTAL_MS){ runOnce(); } else { el.classList.remove('run'); }
        }, VESSEL_RUN_MS + LOOP_GAP_MS);
      };
      setTimeout(()=>{ if (myToken === loopToken) runOnce(); }, preDelayMs);
    }
    const docEl = document.documentElement;
    const obs = new MutationObserver(muts=>{
      muts.forEach(m=>{
        if(m.type==='attributes' && m.attributeName==='data-theme'){
          const theme = docEl.getAttribute('data-theme') || '';
          if (theme === 'dark'){ startVesselLoop(submarine, WATER_RISE_MS); }
          else{ startVesselLoop(boat, WATER_FALL_MS); }
        }
      });
    });
    obs.observe(docEl, {attributes:true});

    // Progress UI
    const total = cards.length;
    totalEl.textContent = String(total);
    ring.setAttribute('aria-valuemax', String(total));
    function buildSegbar(n){
      segbar.innerHTML = '';
      segbar.style.gridTemplateColumns = `repeat(${n}, 1fr)`;
      for(let i=0;i<n;i++){ const s = document.createElement('span'); s.className = 'seg'; segbar.appendChild(s); }
    }
    buildSegbar(total);
    function popToast(msg, ms=3200){ toast.textContent = msg; toast.classList.add('show'); setTimeout(()=> toast.classList.remove('show'), ms); }

    // Celebration
    const CELEB_IN_MS=600, CELEB_HOLD_MS=4800, CELEB_OUT_MS=600, CELEB_START_FADE_OUT_AT=CELEB_IN_MS+CELEB_HOLD_MS;
    function onCelebrationComplete(){ postCelebrationWindow = true; }
    function celebrateFinish(){
      hideFish(); celebration.classList.add('show'); celebration.setAttribute('aria-hidden','false'); void celebration.offsetWidth;
      celebration.classList.add('anim-in');
      setTimeout(()=>{
        celebration.classList.remove('anim-in'); celebration.classList.add('anim-out');
        setTimeout(()=>{ celebration.classList.remove('anim-out','show'); celebration.setAttribute('aria-hidden','true'); onCelebrationComplete(); }, CELEB_OUT_MS);
      }, CELEB_START_FADE_OUT_AT);
    }

    // Next button visibility
    let lastDone = 0;
    const segOn = ()=> Array.from(state.values()).filter(x=>x.done).length;
    function updateProgress(){
      const doneCount = segOn();
      const p = total ? doneCount / total : 0;
      ring.style.setProperty('--p', p);
      ring.setAttribute('aria-valuenow', String(doneCount));
      doneEl.textContent = String(doneCount);
      const segs = segbar.querySelectorAll('.seg');
      segs.forEach((seg, idx)=> seg.classList.toggle('on', idx < doneCount));
      if(doneCount !== lastDone){
        const halfway = Math.ceil(total/2);
        if(doneCount === halfway) popToast('Halfway! Keep cruising ðŸ’§', 3600);
        if(doneCount === total){ popToast('All done! Tap Finish ðŸ’§', 6600); finishBtn.classList.add('show'); }
      }
      lastDone = doneCount;
      updateNextVisibility();
    }
    function updateNextVisibility(){
      const stActive = ensure(String(cards[activeIndex].dataset.card));
      const show = stActive.done && activeIndex < cards.length-1;
      nextBtn.classList.toggle('show', show);
    }

    // Height lock so the card doesn't jump when details open
    function lockAllCardHeights() {
      cards.forEach((card) => {
        const details = card.querySelector('.details');
        if (!details) return;
        const wasOpen = details.classList.contains('open');
        const wasRevealed = card.classList.contains('revealed');
        details.classList.remove('open'); card.classList.remove('revealed'); card.style.height = 'auto';
        const hClosed = card.scrollHeight;
        details.classList.add('open'); card.classList.add('revealed');
        const hOpen = card.scrollHeight;
        details.classList.toggle('open', wasOpen); card.classList.toggle('revealed', wasRevealed);
        const fixed = Math.max(hClosed, hOpen, 240); card.style.setProperty('--fixedH', fixed + 'px'); card.classList.add('fixed');
      });
    }
    function showOnly(index){
      cards.forEach((c,i)=> c.classList.toggle('active', i===index));
      hideFish();
      updateNextVisibility();
    }

    // Read timer
    function setReading(cardEl, on){ cardEl.classList.toggle('reading', !!on); }
    function setDone(cardEl){ cardEl.classList.add('done'); setReading(cardEl,false); }
    function stopTimer(id){ const st = ensure(id); if(st.timerId!=null){ clearInterval(st.timerId); st.timerId=null; } st.startTime=null; }
    function getReadMs(cardEl){ const sec = Number(cardEl.dataset.readSec); return (!isNaN(sec) && sec > 0) ? sec * 1000 : 4000; }
    function startTimer(cardEl, id){
      const st = ensure(id); stopTimer(id); st.startTime = Date.now(); setReading(cardEl, true);
      const READ_MS = getReadMs(cardEl); const readText = cardEl.querySelector('.read-text');
      const update = ()=>{ if(!readText) return; const remain = Math.max(0, READ_MS - (Date.now() - st.startTime)); readText.textContent = `Keep readingâ€¦ ${Math.ceil(remain/1000)}s`; };
      update();
      st.timerId = setInterval(()=>{
        const elapsed = Date.now() - st.startTime; update();
        if(elapsed >= READ_MS){
          stopTimer(id);
          if(!st.done){
            st.done = true; setDone(cardEl); updateProgress();
            const idx = cards.indexOf(cardEl);
            document.getElementById('aquarium').classList.add('bg-on');
            setFishForCard(idx);
            fishVideo?.play?.().catch(()=>{});
            gameStarted = true; postCelebrationWindow = false; cancelVesselLoops();
          }
        }
      }, 100);
    }

    // Reveal active card once
    function revealOnce(card){
      if(card.classList.contains('locked')) return;
      const id = card.dataset.card;
      const details = document.getElementById('details-'+id);
      if(!details) return;

      // --- NEW: start background video as soon as the card is unlocked ---
      const idx = cards.indexOf(card);                     // which card index
      aquarium.classList.add('bg-on');                     // fade in the bg layer
      setFishForCard(idx);                                 // load the right mp4 and reset to 0
      fishVideo?.play?.().catch(()=>{});                   // play on user gesture
      // -------------------------------------------------------------------
      card.classList.add('revealed'); details.classList.add('open'); card.setAttribute('aria-expanded', 'true');
      card.classList.add('locked'); card.setAttribute('tabindex','-1');
      const st = ensure(id);
      if(!st.done) startTimer(card, id); else { setDone(card); setFishForCard(cards.indexOf(card)); }
    }
    cardsWrap.addEventListener('click', e=>{
      const card = e.target.closest('.card.active');
      if(!card || card.classList.contains('locked')) return;
      revealOnce(card);
    });
    cardsWrap.addEventListener('keydown', e=>{
      const t = e.target;
      if(!t.classList?.contains('card') || !t.classList.contains('active')) return;
      if(t.classList.contains('locked')) return;
      if(e.key==='Enter' || e.key===' '){ e.preventDefault(); revealOnce(t); }
    });

    /* ========= Collectible card builder ========= */
    function normGrade(x){
      const t = String(x || 'S').trim().toUpperCase();
      if (t === 'S+' || t === 'SSS') return 'SS';
      return (['SS','S','A','B','C'].includes(t)) ? t : 'S';
    }
    function esc(s){
      return String(s).replace(/[&<>"']/g, m => (
        {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]
      ));
    }

    /* ===== Collection pagination helpers (3 per page) ===== */
    function totalCollectItems(){ return collectGrid.querySelectorAll('.card-scene').length; }
    function totalCollectPages(){ return Math.max(1, Math.ceil(totalCollectItems() / COLLECT_PAGE_SIZE)); }
    function showCollectPage(p){
      const pages = totalCollectPages();
      p = Math.max(0, Math.min(p, pages - 1));
      collectPage = p;
      const items = collectGrid.querySelectorAll('.card-scene');
      items.forEach((el, idx)=> el.classList.toggle('show', Math.floor(idx / COLLECT_PAGE_SIZE) === p));
      collectPageInfo.textContent = `${p+1} / ${pages}`;
      collectPrev.disabled = (p === 0);
      collectNext.disabled = (p >= pages - 1);
      updateEmptyHint();
    }
    collectPrev.addEventListener('click', ()=> showCollectPage(collectPage - 1));
    collectNext.addEventListener('click', ()=> showCollectPage(collectPage + 1));

    /* Empty-state toggler */
    function updateEmptyHint(){
      if (!emptyHint) return;
      const hasItems = totalCollectItems() > 0;
      emptyHint.style.display = hasItems ? 'none' : 'block';
    }

    function appendCollectForCardId(cardId){
      const st = ensure(cardId);
      if (st.unlocked) return;
      if (!Array.isArray(COLLECT_CARDS) || COLLECT_CARDS.length === 0) return;

      const ord  = parseInt(cardId, 10) || 1;
      const pool = COLLECT_CARDS[(ord - 1) % COLLECT_CARDS.length] || {};

      const num      = pool.no ?? pool.number ?? ord;
      const title    = pool.title ?? 'Ocean Friend';
      const aria     = pool.aria ?? pool.aria_label ?? (title + ' card');
      const img      = pool.img ?? pool.image ?? pool.img_url ?? (STATIC_BASE + 'cards/placeholder.png');
      const desc     = pool.desc ?? pool.description ?? 'Learn more about this ocean friend!';
      const cap      = parseInt(pool.levelCap ?? pool.level_cap ?? 3, 10) || 3;
      const cur      = parseInt(pool.levelCur ?? pool.level_cur ?? 1, 10) || 1;
      const rawSpec  = pool.special ?? 'S';
      const grade    = normGrade(rawSpec);

      const isGif = /\.gif(\?.*)?$/i.test(img);
      const safeTitle = esc(title);
      const imgTag = isGif
        ? `<img class="slugger" src="${img}" alt="${safeTitle}" width="320" height="260">`
        : `<img class="slugger" src="${img}" alt="${safeTitle}" width="320" height="260" loading="lazy" decoding="async">`;

      const html = `
        <div class="card-scene">
          <div class="card" data-level-cap="${cap}" data-level-current="${cur}">
            <div class="card-face card-backing" aria-hidden="true">
              <div class="top-banner"></div>
              <div class="back-main">
                <div class="vault-tec">
                  <div class="center"></div>
                  <div class="lines">
                    <div class="line line--left">
                      <div class="line-inner"></div><div class="line-inner"></div><div class="line-inner"></div>
                    </div>
                    <div class="line line--right">
                      <div class="line-inner"></div><div class="line-inner"></div><div class="line-inner"></div>
                    </div>
                  </div>
                </div>
                <p class="flip-hint">Click to reveal!</p>
              </div>
            </div>
            <div class="card-face card-front theme-blue" role="group" aria-label="${esc(aria)}">
              <h1><span class="bump"><b class="outer"><b class="inner">${num}</b></b></span><span class="title-text">${safeTitle}</span></h1>
              <div class="main-pane">
                ${imgTag}
              </div>
              <div class="desc">
                <p>${esc(desc)}</p>
                <div class="special" data-category="science" data-grade="${grade}">
                  <span class="special__txt">${esc(grade)}</span>
                </div>
                <div class="level"></div>
              </div>
            </div>
          </div>
        </div>`.trim();

      const tmp = document.createElement('div');
      tmp.innerHTML = html;
      const scene = tmp.firstElementChild;
      collectGrid.appendChild(scene);

      initF76Card(scene.querySelector('.card'));
      st.unlocked = true;
      greenToast('A new Ocean Card appeared!', 'Unlocked!');

      const newIndex = totalCollectItems() - 1;
      const newPage = Math.floor(newIndex / COLLECT_PAGE_SIZE);
      showCollectPage(newPage);
      updateEmptyHint();
    }

    // Next (read-timer only)
    nextBtn.addEventListener('click', ()=>{
      // If the player still has 0 cards, nudge them to scroll to the collection
      if (typeof totalCollectItems === 'function' && totalCollectItems() === 0) {
        openScrollHintSwal({ force: true });
      }

      const curId = String(cards[activeIndex].dataset.card);
      const st = ensure(curId);
      if(!st.done) return;
      appendCollectForCardId(curId);
      if (activeIndex < cards.length-1){
        hideFish();
        activeIndex += 1;
        showOnly(activeIndex);
      }
    });

    // Finish
    finishBtn.addEventListener('click', ()=>{
      const doneCount = Array.from(state.values()).filter(x=>x.done).length;
      if(doneCount === total){
        const lastId = String(cards[cards.length-1].dataset.card);
        const st = ensure(lastId);
        if(st.done && !st.unlocked){ appendCollectForCardId(lastId); }
        celebrateFinish();
      }
    });

    // Boot
    showOnly(activeIndex);
    lockAllCardHeights();
    updateProgress();

    showCollectPage(0);
    updateEmptyHint();



/* === Scroll hint via SweetAlert2 (no floating button needed) === */

// Section reference for scrolling
const collectionSection = document.querySelector('.kids-collection');

// Simple re-entrancy + "seen once" guard
let scrollSwalOpen = false;
const SCROLL_SWAL_KEY = 'kidsScrollSwalSeenV1';

/** Open the SweetAlert hint. If force=true, ignore the "seen" flag. */
function openScrollHintSwal({ force = false } = {}) {
  // If the user already has items, no need to show
  if (typeof totalCollectItems === 'function' && totalCollectItems() > 0) return;

  // Respect "seen" unless forced
  let seen = false;
  try { seen = localStorage.getItem(SCROLL_SWAL_KEY) === '1'; } catch (_) {}
  if (!force && seen) return;

  if (!window.Swal || scrollSwalOpen) return;
  scrollSwalOpen = true;

  Swal.fire({
    title: 'Cards live below ðŸ‘‡',
    text: 'Scroll down to see your card collection. Tap a card to flip it!',
    icon: 'info',
    confirmButtonText: 'Take me there',
    showCancelButton: true,
    cancelButtonText: 'Later',
    allowOutsideClick: true,
    allowEscapeKey: true,
    backdrop: true
  }).then((res) => {
    scrollSwalOpen = false;
    try { localStorage.setItem(SCROLL_SWAL_KEY, '1'); } catch (_) {}
    if (res.isConfirmed && collectionSection) {
      collectionSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
  });
}

/** Auto-close the hint when the collection section enters the viewport. */
function attachScrollHintObserver() {
  if (!('IntersectionObserver' in window) || !collectionSection) return;
  const io = new IntersectionObserver(([entry]) => {
    if (entry?.isIntersecting && window.Swal && scrollSwalOpen) {
      Swal.close();
      scrollSwalOpen = false;
      try { localStorage.setItem(SCROLL_SWAL_KEY, '1'); } catch (_) {}
      io.disconnect();
    }
  }, { rootMargin: '-80px 0px 0px 0px', threshold: 0.15 });
  io.observe(collectionSection);
}

// Start observer immediately
attachScrollHintObserver();

// Show once on first load if user has 0 cards
//openScrollHintSwal({ force: false });

/* === End: SweetAlert2 scroll hint === */




    window.addEventListener('resize', ()=>{
      cards.forEach(c => { c.classList.remove('fixed'); c.style.removeProperty('--fixedH'); });
      lockAllCardHeights();
    });

    // REMOVE these lines from the READ_MS branch

    //document.addEventListener('visibilitychange', ()=>{
      //if(!fishVideo) return;
      //if(document.hidden) fishVideo.pause?.(); else if(aquarium.classList.contains('bg-on')) fishVideo.play?.();
    //});

    celebration.addEventListener('click', ()=>{
      if(!celebration.classList.contains('show')) return;
      celebration.classList.remove('anim-in'); celebration.classList.add('anim-out');
      setTimeout(()=>{ celebration.classList.remove('anim-out','show'); celebration.setAttribute('aria-hidden','true'); onCelebrationComplete(); }, 600);
    });

    // Fallout mini-card init (adds stars and flip interaction)
    function initF76Card(card){
      if(!card) return;
      const cap = parseInt(card.getAttribute('data-level-cap') || '3', 10);
      const cur = parseInt(card.getAttribute('data-level-current') || '1', 10);
      const levelBox = card.querySelector('.level');
      if(levelBox){
        levelBox.innerHTML = '';
        for(let i=1;i<=cap;i++){
          const s = document.createElement('span');
          s.className = 'star' + (i<=cur ? ' current-level' : '');
          levelBox.appendChild(s);
        }
      }
      card.addEventListener('click', (e)=>{
        e.stopPropagation();
        if(card.classList.contains('card--flipped')){
          card.classList.add('card--unflip');
          setTimeout(()=> card.classList.remove('card--flipped','card--unflip'), 320);
        }else{
          card.classList.add('card--flipped');
          const img = card.querySelector('.slugger');
          if (img && /\.gif(\?.*)?$/i.test(img.src)) {
            const s = img.src; img.src = ''; void img.offsetWidth; img.src = s;
          }
        }
      });
    }

    /* ===================== Bi-weekly Monday countdown logic ===================== */
    const cdEta = document.getElementById('cdEta');
    const cdDate= document.getElementById('cdDate');
    const cdFill= document.getElementById('cdFill');

    function startOfDay(d){ const x = new Date(d); x.setHours(0,0,0,0); return x; }
    function mondayOfWeek(d){ const x = startOfDay(d); const offset = (x.getDay() + 6) % 7; x.setDate(x.getDate() - offset); return x; }
    function addDays(d, n){ const x = new Date(d); x.setDate(x.getDate() + n); return x; }
    function fmtTargetDate(d){ try{ return d.toLocaleDateString(undefined, { weekday:'short', month:'short', day:'numeric', year: 'numeric' }); }catch(e){ return d.toDateString(); } }
    function pad(n){ return String(n).padStart(2,'0'); }

    function updateCountdown(){
      const now = new Date();
      let start = mondayOfWeek(now);
      let end   = addDays(start, 14);
      while(now >= end){ start = addDays(start, 14); end = addDays(end, 14); }
      const total = end - start, remain = Math.max(0, end - now), passed = Math.max(0, now - start), pct = Math.min(1, passed / total);
      const sec = Math.floor(remain / 1000);
      const d = Math.floor(sec / 86400), h = Math.floor((sec % 86400) / 3600), m = Math.floor((sec % 3600) / 60), s = sec % 60;
      if(cdEta)  cdEta.textContent  = `${d}d ${pad(h)}:${pad(m)}:${pad(s)}`;
      if(cdDate) cdDate.textContent = `Target: ${fmtTargetDate(end)} (00:00)`;
      if(cdFill) cdFill.style.width = `${(pct*100).toFixed(2)}%`;
    }
    updateCountdown();
    setInterval(updateCountdown, 1000);
    /* ===================== End countdown logic ===================== */

    /* ===================== First-visit tutorial (spotlight coach) ===================== */
    (function initTutorial(){
      const TUT_KEY = 'kidsTutSeenV1';

      const coach = document.getElementById('coach');
      const coachDim = coach?.querySelector('.coach-dim');
      const coachTip = document.getElementById('coachTip');
      const coachText = document.getElementById('coachText');
      const btnNext = document.getElementById('coachNext');
      const btnBack = document.getElementById('coachBack');
      const btnSkip = document.getElementById('coachSkip');
      if(!coach || !coachDim || !coachTip || !coachText) return;

      const prefersReduce = window.matchMedia?.('(prefers-reduced-motion: reduce)')?.matches;
      const hdrH = (document.getElementById('siteHeader')?.offsetHeight || 80);

      const steps = [
        { q: '.cards .card.active',
          text: 'Tap this card to reveal the details. When the reading timer completes, it gets a check!',
          prefer: 'bottom' },
        { q: '#nextBtn',
          text: 'After finishing a card, press here to go to the next one.',
          prefer: 'left' },
        { q: '#progressRing',
          text: 'This ring shows your learning progress. The more cards you finish, the fuller it gets.',
          prefer: 'right' },
          { q: '.kids-collection .collect-title',
          text: 'Your unlocked mini cards appear here. Scroll to see them and click any card to flip it!',
          prefer: 'top' }
      ];

      let activeIndex = -1;

      function isVisible(el){
        if(!el) return false;
        const r = el.getBoundingClientRect();
        return r.width > 0 && r.height > 0 && r.bottom > hdrH && r.top < window.innerHeight;
      }

      function spotlightTo(el, prefer='bottom'){
        if(!el) return;
        const r = el.getBoundingClientRect();
        const cx = r.left + r.width/2;
        const cy = r.top + r.height/2 - hdrH;
        const pad = 20;
        const radius = Math.round(Math.hypot(r.width, r.height)/2) + pad;

        coachDim.style.setProperty('--x', `${cx}px`);
        coachDim.style.setProperty('--y', `${cy}px`);
        coachDim.style.setProperty('--r', `${radius}px`);

        const margin = 14;
        let tipX = cx, tipY;
        const vw = window.innerWidth, vh = window.innerHeight - hdrH;

        const below = r.bottom - hdrH + margin;
        const above = r.top - hdrH - coachTip.offsetHeight - margin;
        const left  = r.left - coachTip.offsetWidth - margin;
        const right = r.right + margin;

        function clamp(v, min, max){ return Math.max(min, Math.min(max, v)); }

        switch(prefer){
          case 'top':
            tipY = (above > 0 ? above : below);
            break;
          case 'left':
            tipY = clamp(cy - coachTip.offsetHeight/2, 8, vh - coachTip.offsetHeight - 8);
            tipX = (left > 8 ? r.left - margin : r.right + margin + coachTip.offsetWidth/2);
            coachTip.style.transform = 'translate(-100%,0)';
            break;
          case 'right':
            tipY = clamp(cy - coachTip.offsetHeight/2, 8, vh - coachTip.offsetHeight - 8);
            tipX = (right + coachTip.offsetWidth < vw - 8 ? r.right + margin + coachTip.offsetWidth/2 : r.left - margin);
            coachTip.style.transform = (right + coachTip.offsetWidth < vw - 8) ? 'translate(-0%,0)' : 'translate(-100%,0)';
            break;
          default:
            tipY = (below + coachTip.offsetHeight < vh ? below : above);
        }

        if(prefer !== 'left' && prefer !== 'right'){
          tipX = clamp(cx, coachTip.offsetWidth/2 + 8, vw - coachTip.offsetWidth/2 - 8);
          coachTip.style.transform = 'translate(-50%,0)';
        }

        coachTip.style.left = `${tipX}px`;
        coachTip.style.top  = `${tipY}px`;
      }

      function scrollIntoViewIfNeeded(el){
        if(!el) return Promise.resolve();
        const r = el.getBoundingClientRect();
        const need = (r.top < hdrH + 20 || r.bottom > window.innerHeight - 20);
        if(need){
          el.scrollIntoView({behavior: prefersReduce ? 'auto' : 'smooth', block: 'center'});
          return new Promise(res => setTimeout(res, prefersReduce ? 0 : 380));
        }
        return Promise.resolve();
      }

      function setStep(i){

          let idx = Math.max(0, Math.min(i, steps.length - 1));

          let step, el;
          let dir = (i > activeIndex) ? 1 : -1;
          while (idx >= 0 && idx < steps.length) {
            step = steps[idx];
            el = document.querySelector(step.q);
            if (el) break;               
            idx += dir;
          }
          if (!el) { closeTutorial(true); return; }

          activeIndex = idx;
          coachText.textContent = step.text;

          scrollIntoViewIfNeeded(el).then(()=>{
            requestAnimationFrame(()=>{
              spotlightTo(el, step.prefer || 'bottom');
            });
          });

          btnBack.disabled = (activeIndex === 0);
          btnNext.textContent = (activeIndex === steps.length - 1) ? 'Got it' : 'Next';
      }


      function openTutorial(){
        const coach = document.getElementById('coach');
        if(coach.classList.contains('show')) return;
        coach.classList.add('show');
        coach.setAttribute('aria-hidden','false');
        document.body.style.overflow = 'hidden';

        document.getElementById('coachSkip').onclick = ()=> closeTutorial(true);
        document.getElementById('coachBack').onclick = ()=> setStep(activeIndex - 1);
        document.getElementById('coachNext').onclick = ()=> {
          if(activeIndex === steps.length - 1) closeTutorial(true);
          else setStep(activeIndex + 1);
        };
        coach.addEventListener('click', (e)=> {
          if(e.target === coach || e.target === coach.querySelector('.coach-dim')) document.getElementById('coachNext').click();
        });
        window.addEventListener('keydown', onKey);
        window.addEventListener('resize', onResize);

        setTimeout(()=> setStep(0), 60);
      }

      function onKey(e){
        if(e.key === 'Escape'){ closeTutorial(false); }
        else if(e.key === 'ArrowRight' || e.key === 'Enter'){ document.getElementById('coachNext').click(); }
        else if(e.key === 'ArrowLeft'){ document.getElementById('coachBack').click(); }
      }
      function onResize(){
        if(activeIndex < 0) return;
        const step = steps[activeIndex];
        const el = document.querySelector(step.q);
        if(el) spotlightTo(el, step.prefer || 'bottom');
      }

      function closeTutorial(saveSeen){
        const coach = document.getElementById('coach');
        coach.classList.remove('show');
        coach.setAttribute('aria-hidden','true');
        document.body.style.overflow = '';
        window.removeEventListener('keydown', onKey);
        window.removeEventListener('resize', onResize);
        if(saveSeen){
          try{ localStorage.setItem(TUT_KEY, '1'); }catch(_){}
        }
      }

      // expose public triggers
      window.startTutorialOnce = function(){
        let seen = false;
        try{ seen = localStorage.getItem(TUT_KEY) === '1'; }catch(_){}
        if(!seen) openTutorial();
      };
      window.replayTutorial = function(){
        try{ localStorage.removeItem(TUT_KEY); }catch(_){}
        openTutorial();
      };
    })();
    /* ===================== End first-visit tutorial ===================== */

    // Hook the rainbow replay button
    if(replayBtn){
      replayBtn.addEventListener('click', ()=>{
        if(window.replayTutorial){ window.replayTutorial(); }
        else{
          try{ localStorage.removeItem('kidsTutSeenV1'); }catch(_){}
          if(window.startTutorialOnce) window.startTutorialOnce();
        }
      });
    }

    // Kick off the tutorial once (will no-op if already seen)
    startTutorialOnce();
  };
</script>
{% endblock %}
