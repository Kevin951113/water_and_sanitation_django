{% load static %}
<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <title>{% block title %}[Water and Sanitation]{% endblock %}</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <!-- super-early theme boot so there’s no flash -->
  <script>
    (function () {
      try {
        var saved = localStorage.getItem('theme'); // 'light' | 'dark' | null
        var isLight;
        if (saved === 'light')      { isLight = true; }
        else if (saved === 'dark')  { isLight = false; }
        else {
          isLight = window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches;
        }
        document.documentElement.setAttribute('data-theme', isLight ? 'light' : 'dark');
      } catch(e) {}
    })();
  </script>

  <!-- Bootstrap (for responsive navbar collapse only) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script defer src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- assets we want asap -->
  <link rel="preload" href="{% static 'lightoff_logo.png' %}" as="image">
  <link rel="preload" href="{% static 'lighton_logo.png' %}" as="image">
  <link rel="preload" href="{% static 'giphy1.gif' %}" as="image"><!-- loading GIF -->

  {% block head_extras %}{% endblock %}

  <style>
    /* ===== Dropdown ===== */
    .menu .dropdown { position: relative; display: inline-block; }
    .menu .dropdown > a { display: inline-flex; align-items: center; }
    .menu .submenu {
      display: none; position: absolute; top: 100%; left: 0; min-width: 260px;
      background: rgba(5, 8, 15, 0.96);
      border: 1px solid rgba(255, 255, 255, 0.12);
      box-shadow: 0 12px 28px rgba(0,0,0,0.35);
      padding: 6px 0; z-index: 1000; backdrop-filter: saturate(120%) blur(6px);
    }
    .menu .submenu a { display: block; padding: 10px 14px; text-decoration: none; white-space: nowrap; }
    .menu .submenu a:hover, .menu .submenu a:focus { background: rgba(255,255,255,0.08); }
    .menu .dropdown:hover .submenu, .menu .dropdown:focus-within .submenu { display: block; }

    /* Light theme dropdown panel */
    html[data-theme="light"] .menu .submenu{
      background: color-mix(in srgb, var(--card-bg) 92%, var(--header-glow) 8%);
      border: 1px solid rgba(0,0,0,.08);
      box-shadow: 0 12px 24px rgba(0,0,0,.12);
    }
    html[data-theme="light"] .menu .submenu a{ color: var(--text); }
    html[data-theme="light"] .menu .submenu a:hover,
    html[data-theme="light"] .menu .submenu a:focus {
      background: color-mix(in srgb, var(--header-glow) 16%, white 84%);
      color: var(--header-glow);
      text-shadow: 0 0 6px color-mix(in srgb, var(--header-glow) 70%, white 30%);
    }

    /* ===== Theme Variables ===== */
    :root{
      --bg:#0e1420; --text:#f2f5f9; --muted:#9fb0c3;
      --header-bg:rgba(14,20,32,.65); --hairline:rgba(255,255,255,.1);
      --card-bg:#111; --shadow:0 10px 30px rgba(0,0,0,.35); --card-stroke:rgba(255,255,255,.08);
      --card-radius:22px; --gap:18px;
      --header-glow:#9ad7ff;
      --stroke: rgba(0,0,0,.78);
      --glow-outer: 0 0 28px color-mix(in srgb, var(--header-glow) 95%, transparent);
      --glow-inner: 0 0 10px color-mix(in srgb, var(--header-glow) 90%, transparent);
      --ico-sun: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23fff' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Ccircle cx='12' cy='12' r='4'/%3E%3Cpath d='M12 2v2M12 20v2M4 12H2M22 12h-2M5 5l-1.4-1.4M20.4 20.4 19 19M5 19l-1.4 1.4M20.4 3.6 19 5'/%3E%3C/svg%3E");
      --ico-moon: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23fff'%3E%3Cpath d='M21 12.8A8.5 8.5 0 1 1 11.2 3a7 7 0 1 0 9.8 9.8z'/%3E%3C/svg%3E");
    }
    html[data-theme="light"]{
      --bg:#fff; --text:#0e1420; --muted:#4a5a6c;
      --header-bg:rgba(255,255,255,.75); --hairline:rgba(0,0,0,.1);
      --card-bg:#f5f7fb; --shadow:0 10px 30px rgba(0,0,0,.12); --card-stroke:rgba(0,0,0,.06);
      --header-glow:#1b4fff;
      --stroke: rgba(0,0,0,.55);
      --glow-outer: 0 0 14px color-mix(in srgb, var(--header-glow) 65%, transparent);
      --glow-inner: 0 0 3px  color-mix(in srgb, var(--header-glow) 70%, transparent);
      --ico-sun: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23fff' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Ccircle cx='12' cy='12' r='4'/%3E%3Cpath d='M12 2v2M12 20v2M4 12H2M22 12h-2M5 5l-1.4-1.4M20.4 20.4 19 19M5 19l-1.4 1.4M20.4 3.6 19 5'/%3E%3C/svg%3E");
      --ico-moon: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23fff'%3E%3Cpath d='M21 12.8A8.5 8.5 0 1 1 11.2 3a7 7 0 1 0 9.8 9.8z'/%3E%3C/svg%3E");
    }

    *{box-sizing:border-box}
    html,body{ margin:0; height:100%; background:var(--bg); color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial,"Noto Sans","Apple Color Emoji","Segoe UI Emoji"; }

    /* ===== Header ===== */
    header{
      position:sticky; top:0; z-index:10; backdrop-filter:blur(10px);
      background:var(--header-bg); border-bottom:1px solid var(--hairline);
      padding:12px 18px; display:flex; align-items:center; gap:16px;
    }
    .brand{display:flex; align-items:center; gap:10px}
    .brand .logo{ width:clamp(40px, 10vw, 110px); height:clamp(40px, 10vw, 110px); display:inline-block; }
    .brand .logo img{width:100%; height:100%; object-fit:contain; display:block}
    header h1{
      margin:0;
      font-size:clamp(16px, 4.2vw, 22px);
      letter-spacing:.5px; white-space:nowrap;
      -webkit-text-stroke:.4px var(--stroke);
      text-shadow:0 1px 0 rgba(0,0,0,.25);
    }
    @media (max-width:575.98px){
      header{ padding:10px 12px; }
      .brand{ gap:8px; }
    }

    /* ===== Menu with slot effect ===== */
    nav.menu{flex:1; justify-content:center; gap:28px; flex-wrap:wrap;}
    nav.menu a, nav.menu .menu-link{
      position:relative; display:inline-block; color:var(--text); text-decoration:none;
      font-weight:800; letter-spacing:.08em; font-size:14px; text-transform:uppercase;
      padding:8px 10px; border-radius:10px;
      -webkit-text-stroke:.35px var(--stroke);
      text-shadow: 0 1px 0 rgba(0,0,0,.22);
    }
    .slot-window{ display:block; height:1.2em; overflow:hidden; line-height:1.2em; }
    .slot-track{ display:block; }
    .slot-item{ display:block; line-height:1.2em; }
    @keyframes slotSpin{
      0%{transform:translateY(0)}45%{transform:translateY(-105%)}60%{transform:translateY(5%)}100%{transform:translateY(0)}
    }
    nav.menu a:hover .slot-track{ animation: slotSpin 1.1s cubic-bezier(.22,.72,.17,1) both; }
    nav.menu a:focus-visible{outline:2px solid var(--text); outline-offset:4px; border-radius:6px}

    /* hover/focus/active */
    nav.menu a:hover, nav.menu a:focus-visible, nav.menu a.active,
    nav.menu .menu-link:hover, nav.menu .menu-link:focus-visible, nav.menu .menu-link.active{
      color: var(--header-glow);
      text-shadow: var(--glow-outer), var(--glow-inner), 0 1px 1px rgba(0,0,0,.18);
      background: color-mix(in srgb, var(--header-glow) 12%, transparent);
    }
    nav.menu a::after, nav.menu .menu-link::after{
      content:""; position:absolute; left:12px; right:12px; bottom:4px; height:6px; border-radius:999px;
      background: radial-gradient(60% 120% at 50% 50%, color-mix(in srgb, var(--header-glow) 65%, transparent), transparent 70%);
      opacity:0; transform:translateY(4px); transition:opacity .18s, transform .18s; pointer-events:none; filter:blur(.8px);
    }
    nav.menu a:hover::after, nav.menu a.active::after,
    nav.menu .menu-link:hover::after, nav.menu .menu-link.active::after{ opacity:1; transform:translateY(0); }

    html[data-theme="light"] nav.menu a:hover,
    html[data-theme="light"] nav.menu a:focus-visible,
    html[data-theme="light"] nav.menu a.active{
      text-shadow:0 1px 1px rgba(0,0,0,.28), 0 0 10px color-mix(in srgb, var(--header-glow) 40%, transparent);
      background: color-mix(in srgb, var(--header-glow) 12%, white 88%);
      border-radius: 8px; -webkit-text-stroke:.25px rgba(0,0,0,.35);
    }

    header button{
      appearance:none; border:1px solid var(--hairline); background:transparent; color:var(--text);
      border-radius:999px; padding:8px 12px; cursor:pointer; font-size:12px;
    }
    header button:hover{background:rgba(127,127,127,.12)}
    header button:focus-visible{outline:2px solid var(--text); outline-offset:2px}

    /* ===== Sun + Moon visuals only ===== */
    #lightBtn{ position:relative; }
    #lightBtn::before,
    #lightBtn::after{
      content:""; position:absolute; top:50%; transform:translateY(-50%);
      width:18px; height:18px; opacity:.95; pointer-events:none;
      background-repeat:no-repeat; background-position:center; background-size:contain;
      filter: drop-shadow(0 0 4px rgba(255,255,255,.45));
    }
    #lightBtn::before{ left:.1em; background-image: var(--ico-sun); }
    #lightBtn::after{  right:.1em; background-image: var(--ico-moon); }

    /* Make ONLY the light button responsive on larger screens too */
    #lightBtn{
      min-height: clamp(38px, 4.2vw, 46px);
      padding: clamp(.56em, .8vw, .72em) clamp(1em, 1.6vw, 1.8em);
      font-size: clamp(.95rem, .5vw + .7rem, 1rem);
    }
    #lightBtn::before,
    #lightBtn::after{
      width: clamp(16px, 1.2vw + 10px, 20px);
      height: clamp(16px, 1.2vw + 10px, 20px);
    }

    /* ===== Responsive navbar ===== */
    @media (min-width: 992px){
      nav.menu{ display:flex; }
      nav.menu.collapse,
      nav.menu.collapse:not(.show){
        display:flex !important;
        height:auto !important;
        visibility:visible !important;
      }
    }
    @media (max-width: 991.98px){
      nav.menu{ display:block; }
      nav.menu.collapse:not(.show){ display:none !important; }
    }

    /* Hamburger */
    .hamburger-btn{
      border:1px solid var(--hairline); color:var(--text); background:transparent;
      padding:.45rem .7rem; border-radius:10px; line-height:1; font-weight:900;
      min-width:40px; min-height:40px; box-shadow:none; transition:color .15s ease;
      -webkit-tap-highlight-color: transparent;
    }
    .hamburger-btn:hover,
    .hamburger-btn:focus-visible,
    .hamburger-btn[aria-expanded="true"]{
      color: var(--header-glow);
      background: transparent;
      text-shadow: none;
      box-shadow: none;
      transform: none;
      outline: none;
    }

    /* ===== Mobile: menu panel + FIX no-shift during .collapsing ===== */
    @media (max-width: 991.98px){
      header{ position:sticky; top:0; }

      /* Keep the nav OUT of the flex flow for the whole animation */
      #primaryNav.collapse,
      #primaryNav.collapsing,
      #primaryNav.collapse.show{
        position:absolute; left:0; right:0; top:100%;
        background: var(--header-bg);
        border-top:1px solid var(--hairline);
        padding:10px 18px 12px;
        z-index: 9;
        box-shadow: 0 10px 30px rgba(0,0,0,.35);
        backdrop-filter: blur(10px);
        width:100%;
        border-radius: 0 0 18px 18px;
      }

      /* Hidden state still fully removed */
      #primaryNav.collapse:not(.show){ display:none !important; }

      header .menu a,
      header .menu .menu-link{
        display:block; padding:10px 12px; margin:6px 0;
        color: var(--header-glow);
        background: transparent;
        text-shadow:none;
        border-radius:12px;
      }

      /* dropdown submenu becomes inline */
      .menu .submenu{
        position: static; display: none; padding: 4px 0; border: 0; box-shadow:none;
        background: transparent;
      }
      .menu .dropdown:focus-within .submenu,
      .menu .dropdown:hover .submenu{ display:block; }

      /* ===== Light button: icon-only on small screens (keep original gradient colors) ===== */
      #lightBtn{
        width: clamp(40px, 9.5vw, 46px);
        height: clamp(40px, 9.5vw, 46px);
        padding: 0;
        border-radius: 999px;
        font-size: 0;         /* hide text visually */
        min-width: auto;
        gap: 0;
      }
      #lightBtn::after{ display:none; } /* only one icon */
      #lightBtn::before{
        left:50%; right:auto; transform:translate(-50%, -50%);
        width: clamp(18px, 4.3vw, 22px);
        height: clamp(18px, 4.3vw, 22px);
      }
      html[data-theme="light"] #lightBtn::before{ background-image: var(--ico-sun); }
      html[data-theme="dark"]  #lightBtn::before{ background-image: var(--ico-moon); }
    }

    /* ===== Hero / Panels ===== */
    .hero{ max-width:1300px; margin:22px auto 0; padding:0; position:relative; z-index:1; }
    .panel{
      position:relative; aspect-ratio:9/14; overflow:hidden; border-radius:var(--card-radius);
      background:var(--card-bg); box-shadow:var(--shadow); border:1px solid var(--card-stroke);
      isolation:isolate; transform:translateY(0) scale(1);
      transition:transform .35s cubic-bezier(.2,.7,.2,1), box-shadow .35s; will-change:transform; z-index:1;
    }
    .panel-hero{ aspect-ratio:auto; height:clamp(160px, 28vw, 380px); background:#000; margin-bottom:var(--gap); }
    .panel video{
      position:absolute; inset:0; width:100%; height:100%; object-fit:cover;
      filter:saturate(1.05) contrast(1.02); transform:scale(1);
      transition:transform .6s ease, filter .35s ease; z-index:0; pointer-events:none; will-change:transform;
    }
    .panel:hover{ transform:translateY(-8px) scale(1.02); box-shadow:0 18px 50px rgba(0,0,0,.45) }
    .panel:hover video{ transform:scale(1.06); filter:saturate(1.1) contrast(1.05) }

    .tint{
      position:absolute; inset:0; pointer-events:none; z-index:1;
      background:linear-gradient(135deg, rgba(26,92,255,.35), rgba(0,178,255,.15));
      mix-blend-mode:soft-light; opacity:.75; transition:opacity .35s ease;
    }
    .panel-hero .tint{
      background: radial-gradient(120% 80% at 80% 10%, rgba(0,0,0,.28), transparent 60%),
                  linear-gradient(135deg, rgba(26,92,255,.35), rgba(0,178,255,.15));
      opacity:.85;
    }
    html[data-theme="light"] .panel .tint{opacity:.45}

    .wrap{max-width:1300px; margin:28px auto; padding:0 18px 36px; position:relative; z-index:1; }
    .grid{display:grid; grid-template-columns:1fr; gap:var(--gap)}
    @media (min-width:900px){ .grid{grid-template-columns:1fr 1fr} }
    @media (min-width:1200px){ .grid{grid-template-columns:1fr 1fr 1fr} }

    .overlay{position:absolute; inset:0; display:grid; place-items:center; pointer-events:none; z-index:2; padding:18px}
    .centerline{
      font-weight:800; letter-spacing:.5px; text-transform:uppercase;
      font-size:clamp(14px, 2vw, 22px); text-align:center; line-height:1.2;
      color:var(--text); padding:0 12px; text-shadow:0 2px 8px rgba(0,0,0,.35);
    }
    .title-row{
      display:inline-flex; align-items:center; gap:10px; pointer-events:auto;
      padding:6px 10px; border-radius:10px;
      background:rgba(0,0,0,.22); box-shadow:0 4px 20px rgba(0,0,0,.25);
    }
    html[data-theme="light"] .centerline{ text-shadow:none; }
    html[data-theme="light"] .title-row{ background: color-mix(in srgb, white 75%, var(--header-glow) 25%); box-shadow:none; }

    .water-chip{ width:28px; height:28px; border-radius:999px; display:inline-flex;
      align-items:center; justify-content:center; flex:0 0 auto;
      background: radial-gradient(circle at 60% 30%, #8fd3ff 0%, #3db7ff 40%, #0a62cc 100%);
      box-shadow: 0 0 0 2px rgba(255,255,255,.25), 0 6px 18px rgba(0, 150, 255, .35);
      overflow:hidden; position:relative; cursor:pointer; transition: filter .2s ease; }
    .water-chip:hover{ filter:brightness(1.05) saturate(1.1); }
    .water-chip svg{ width:70%; height:70%; display:block; }
    .water-chip .ring{ fill:none; stroke:#d8efff; opacity:.85; stroke-width:1.8; }
    .water-chip .drop{ fill:#e9f7ff; }
    .water-chip .bubble{ fill:#e9f7ff; opacity:.95; }

    @media (prefers-reduced-motion: reduce){
      .panel, .panel video, .tint{transition:none}
      .panel:hover{transform:none}
      .panel:hover video{transform:none}
      nav.menu a:hover .slot-track{animation:none}
      #ripple-layer{ display:none !important; }
    }

    .hint{position:fixed; right:12px; bottom:10px; color:var(--muted); font-size:12px; opacity:.75; user-select:none}

    /* ===== Background Ripple Layer ===== */
    #ripple-layer{ position:fixed; inset:0; z-index:0; pointer-events:none; opacity:.9; }
    html[data-theme="dark"] #ripple-layer{ mix-blend-mode:screen; }
    html[data-theme="light"] #ripple-layer{ mix-blend-mode:multiply; }
    .ripple{
      position:absolute; left:0; top:0; width:160px; height:160px; border-radius:999px;
      transform:translate(-50%,-50%) scale(.25); opacity:.8; will-change:transform,opacity,filter;
      background:radial-gradient(circle, rgba(180,235,255,.75) 0%, rgba(150,215,255,.35) 35%, rgba(150,215,255,0) 70%);
      filter:blur(.8px); box-shadow:0 0 28px rgba(120,190,255,.35);
    }
    html[data-theme="light"] .ripple{
      background:radial-gradient(circle, rgba(40,110,255,.22) 0%, rgba(40,110,255,.10) 35%, rgba(40,110,255,0) 70%);
      filter:blur(.6px); box-shadow:0 0 20px rgba(40,110,255,.12); opacity:.7;
    }

    /* ===== WHY ===== */
    .why-section{
      position:relative; display:flex; align-items:flex-start; min-height:460px; overflow:hidden; padding:48px 0 0 0;
      background: linear-gradient(135deg,#0b1f36 0%, #0c3d66 55%, #0e6fc0 100%);
      border-top:1px solid var(--card-stroke); border-bottom:1px solid var(--card-stroke);
    }
    html[data-theme="light"] .why-section{ background: linear-gradient(135deg,#eaf3ff 0%, #d8ebff 55%, #cfe7ff 100%); }
    .lottie-bg{ position:absolute; left:-70px; bottom:-70px; z-index:0; opacity:.65; pointer-events:none; user-select:none; width:700px; height:700px; filter: saturate(1.1) contrast(1.03); }
    .lottie-bg video{ width:100%; height:100%; object-fit:cover; opacity:.75; }
    .why-main-content{ z-index:1; margin:0 auto; width:100%; max-width:1300px; display:flex; flex-direction:column; align-items:center; position:relative; }
    .why-title{
      font-size:2.1rem; font-weight:900; margin-bottom:32px; text-align:center; letter-spacing:.7px; color:#fff;
      text-shadow:0 4px 18px rgba(0,0,0,.28), 0 1px 0 rgba(0,0,0,.35);
    }
    html[data-theme="light"] .why-title{
      color:#0e1420; text-shadow:none;
      background:linear-gradient(90deg,#1a5cff,#00b2ff);
      -webkit-background-clip:text; background-clip:text; color:transparent; -webkit-text-fill-color:transparent;
    }
    .why-list{ display:flex; flex-direction:column; gap:22px; width:100%; max-width:740px; margin:0 auto 18px auto; font-size:1.12rem; font-weight:600; z-index:1; line-height:1.45; }
    .why-list-item{
      display:flex; align-items:center; gap:18px; cursor:pointer;
      transition:transform .28s cubic-bezier(.4,2,.6,1), background .25s ease;
      will-change:transform; border-radius:10px; padding:.18em .34em .18em .18em; background:none; position:relative;
    }
    .why-list-item:hover{ transform:scale(1.045); background: color-mix(in srgb, var(--header-glow) 12%, transparent); }
    .why-icon-bullet{
      display:flex; align-items:center; justify-content:center; border-radius:50%;
      width:46px; height:46px; font-size:1.4em; background:#0d2036; color:var(--header-glow);
      border:2px solid transparent; box-shadow: 0 2px 14px rgba(24,110,255,.35);
      transition: box-shadow .24s, border .24s, transform .24s;
    }
    .why-list-item:hover .why-icon-bullet{
      box-shadow: 0 0 0 4px color-mix(in srgb, var(--header-glow) 35%, transparent), 0 6px 26px color-mix(in srgb, var(--header-glow) 45%, transparent);
      border:2px solid color-mix(in srgb, var(--header-glow) 55%, transparent);
      transform: translateY(-1px);
    }
    .why-note{ margin-top:6px; font-size:.92rem; color:var(--muted); text-align:center; }

    /* ===== fixed at the bottom of the water surface ===== */
    #water-stage{ position:fixed; inset:0; z-index:0; pointer-events:none; }
    #water-canvas{ width:100%; height:100%; display:block; }

    /* Button style */
    .dashboard-btn {
      background: linear-gradient(90deg,#08497e 0%, #0e6fc0 50%, #5dade2 100%);
      color: #fff; border: none; border-radius: 1.6em; padding: .72em 1.8em;
      font-weight: 800; font-size: 1rem; margin-top: .2em; cursor: pointer;
      box-shadow: 0 3px 13px rgba(14,111,192,.3);
      transition: background .18s, color .18s, box-shadow .18s, transform .18s;
      display: inline-flex; align-items: center; gap: .5em; position: relative; z-index: 2; -webkit-tap-highlight-color: transparent;
    }
    .dashboard-btn:hover{ background: linear-gradient(90deg, #5dade2 0%, #0e6fc0 100%); color: #eaf6ff; box-shadow: 0 8px 28px rgba(14,111,192,.5); transform: translateY(-1px) scale(1.02); }
    .dashboard-btn:focus{ outline:none; }
    .dashboard-btn:focus-visible{ background: linear-gradient(90deg, #5dade2 0%, #0e6fc0 100%); color: #eaf6ff; box-shadow: 0 0 0 3px rgba(90,173,226,.45), 0 8px 28px rgba(14,111,192,.5); transform: translateY(-1px) scale(1.02); }
    .dashboard-btn:active{ transform: translateY(0) scale(.98); box-shadow: 0 2px 10px rgba(14,111,192,.35); }

    footer{
      padding:16px; border-top:1px solid var(--card-stroke); text-align:center; color:var(--muted);
      position:relative; z-index:1; background:transparent;
    }

    /* ===== Full Page Loading Mask ===== */
    #loadingMask{
      display:none; position:fixed; inset:0; z-index:10000; background:rgba(14,20,32,0.16); backdrop-filter:blur(2.5px);
      align-items:center; justify-content:center; opacity:0; pointer-events:none; transition:opacity .22s ease;
    }
    #loadingMask.active{ display:flex !important; opacity:1; pointer-events:auto; }
    .loading-card{
      background:#ffffff3c; border-radius:26px; padding:32px 44px;
      box-shadow:0 8px 28px rgba(66,29,121,.38); display:flex; flex-direction:column; align-items:center; gap:12px;
      transform:scale(.985); transition:transform .6s ease, opacity .25s ease; opacity:.99;
    }
    #loadingMask.active .loading-card{ transform:scale(1); }
    .loading-gif{ width:min(420px, 72vw); height:auto; display:block; }
    .loading-text {
      font-size: clamp(28px,4.6vw,44px); font-weight: 900; letter-spacing: .8px; line-height: 1.08;
      background: linear-gradient(90deg,#d7e7ff 0%, #91a6ff 50%, #3d5afe 100%);
      -webkit-background-clip: text; background-clip: text; color: transparent;
      -webkit-text-stroke: 2px rgba(0, 50, 200, 0.7);
      text-shadow: 0 0 12px #3d5afeaa, 0 0 20px #536dfeaa, 0 0 28px #91a6ffaa, 0 0 4px #fff8, 0 2px 8px #e0e9ffcc;
    }
  </style>
</head>
<body>
  <header id="siteHeader" class="container-fluid">
    <div class="d-flex align-items-center w-100 gap-2 position-relative">
      <!-- Brand -->
      <div class="brand" aria-label="Brand">
        <span class="logo" aria-hidden="true">
          <img id="brandLogo" src="{% static 'lightoff_logo.png' %}" alt="Brand logo (lights off)">
        </span>
        <h1>[Water and Sanitation]</h1>
      </div>

      <!-- Hamburger (small screens only) -->
      <button class="hamburger-btn d-lg-none ms-auto"
              type="button"
              data-bs-toggle="collapse"
              data-bs-target="#primaryNav"
              aria-controls="primaryNav"
              aria-expanded="false"
              aria-label="Toggle menu">☰</button>

      {% with current=request.resolver_match.url_name %}
      <!-- Nav -->
      <nav id="primaryNav"
           class="menu collapse d-lg-flex flex-lg-row justify-content-center gap-3 mx-lg-auto"
           aria-label="Primary">
        <a href="{% url 'home' %}" class="{% if current == 'home' %}active{% endif %}">
          <span class="slot-window"><span class="slot-track">
            <span class="slot-item">[Home]</span><span class="slot-item" aria-hidden="true">[Home]</span>
          </span></span>
        </a>

        <!-- dropdown item -->
        <div class="dropdown menu-item">
          <a href="#"
             class="menu-link has-submenu {% if current == 'explore_water_quality' or current == 'pollution_sources' or current == 'future_family_safety' %}active{% endif %}"
             aria-haspopup="true"
             aria-expanded="{% if current == 'explore_water_quality' or current == 'pollution_sources' or current == 'future_family_safety' %}true{% else %}false{% endif %}">
            <span class="slot-window"><span class="slot-track">
              <span class="slot-item">[Water Insights]</span>
              <span class="slot-item" aria-hidden="true">[Water Insights]</span>
            </span></span>
          </a>
          <div class="submenu" role="menu">
            <a role="menuitem" href="{% url 'explore_water_quality' %}" class="{% if current == 'explore_water_quality' %}active{% endif %}">[Explore Water Quality]</a>
            <a role="menuitem" href="{% url 'pollution_sources' %}" class="{% if current == 'pollution_sources' %}active{% endif %}">[Pollution Sources]</a>
            <a role="menuitem" href="{% url 'future_family_safety' %}" class="{% if current == 'future_family_safety' %}active{% endif %}">[Community Reporting & Family Safety]</a>
          </div>
        </div>

        <a href="{% url 'for_kids_learn_play' %}" class="{% if current == 'for_kids_learn_play' %}active{% endif %}">
          <span class="slot-window"><span class="slot-track">
            <span class="slot-item">[For Kids – Learn & Play]</span><span class="slot-item" aria-hidden="true">[For Kids – Learn & Play]</span>
          </span></span>
        </a>

        <a href="{% url 'about_water_sanitation' %}" class="{% if current == 'about_water_sanitation' %}active{% endif %}">
          <span class="slot-window"><span class="slot-track">
            <span class="slot-item">[About Our Water]</span><span class="slot-item" aria-hidden="true">[About Our Water]</span>
          </span></span>
        </a>
      </nav>
      {% endwith %}

      <!-- Light switch -->
      <button id="lightBtn" class="dashboard-btn ms-lg-3" aria-pressed="false" aria-label="Toggle lights">
        Lights: Off
      </button>
    </div>
  </header>

  <!-- Fixed water surface and background ripples (shared) -->
  <div id="water-stage" aria-hidden="true">
    <canvas id="water-canvas"></canvas>
  </div>
  <div id="ripple-layer" aria-hidden="true"></div>

  <!-- Main content -->
  <main class="wrap">
    {% block content %}{% endblock %}
  </main>

  <!-- Shared Footer -->
  <footer>
    © {% now "Y" %} Water & Sanitation • All rights reserved.
  </footer>

  <!-- Full Page Loading Mask -->
  <div id="loadingMask" aria-hidden="true">
    <div class="loading-card" role="status" aria-live="polite">
      <img class="loading-gif" src="{% static 'giphy1.gif' %}" alt="Loading..." style="width:740px;height:460px;display:block;">
      <span class="loading-text">Loading…</span>
    </div>
  </div>

  <!-- Shared JS: GSAP loading + light switch + logo switching + water surface animation + background ripples -->
  <script>
    /************ GSAP Multi-CDN Loading ************/
    const GSAP_URLS = [
      "https://cdn.jsdelivr.net/npm/gsap@3.12.5/dist/gsap.min.js",
      "https://unpkg.com/gsap@3.12.5/dist/gsap.min.js",
      "https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"
    ];
    function loadScript(url){
      return new Promise((resolve,reject)=>{
        const s=document.createElement('script');
        s.src=url; s.async=true;
        s.onload=()=>resolve(url);
        s.onerror=()=>reject(url);
        document.head.appendChild(s);
      });
    }
    async function ensureGSAP(){
      if(window.gsap) return true;
      for(const url of GSAP_URLS){
        try{ await loadScript(url); if(window.gsap) return true; }catch(e){}
      }
      console.error("[GSAP] failed to load from all CDNs.");
      return false;
    }

    /************ Theme switching ************/
    const lightBtn=document.getElementById("lightBtn");
    const htmlEl=document.documentElement;
    const logoImg=document.getElementById("brandLogo");
    const LOGO_DARK="{% static 'lightoff_logo.png' %}";
    const LOGO_LIGHT="{% static 'lighton_logo.png' %}";
    let isLight = htmlEl.getAttribute("data-theme") === "light";

    function updateLogo(isLight){
      logoImg.src=isLight?LOGO_LIGHT:LOGO_DARK;
      logoImg.alt=isLight?"Brand logo (lights on)":"Brand logo (lights off)";
    }
    function updateButton(isLight){
      lightBtn.textContent=`Lights: ${isLight ? "On" : "Off"}`;
      lightBtn.setAttribute("aria-pressed", String(isLight));
    }
    updateButton(isLight);
    updateLogo(isLight);

    function setTheme(nextIsLight){
      isLight = !!nextIsLight;
      htmlEl.setAttribute("data-theme", isLight ? "light" : "dark");
      updateButton(isLight);
      updateLogo(isLight);
      try { localStorage.setItem('theme', isLight ? 'light' : 'dark'); } catch(e){}
      let meta=document.querySelector('meta[name="theme-color"]');
      if(!meta){ meta=document.createElement("meta"); meta.name="theme-color"; document.head.appendChild(meta); }
      meta.content=getComputedStyle(document.documentElement).getPropertyValue("--bg").trim();
      window.dispatchEvent(new CustomEvent('themechange', { detail: { isLight } }));
      if (window.waterStage && window.waterStage.transitionTo){
        window.waterStage.transitionTo(isLight);
      }
    }
    lightBtn.addEventListener("click",()=>{ setTheme(!isLight); });
    window.addEventListener('storage', (e)=>{
      if (e.key === 'theme' && e.newValue) {
        const wantLight = e.newValue === 'light';
        if (wantLight !== isLight) setTheme(wantLight);
      }
    });

    /* --- Desktop/mobile nav guard so nav never disappears on wide screens --- */
    function resetNavForBreakpoint(){
      const nav = document.getElementById('primaryNav');
      if (!nav) return;
      if (window.innerWidth >= 992){
        nav.classList.remove('collapsing');
        nav.classList.add('show');
        nav.style.removeProperty('height');
        nav.style.removeProperty('visibility');
        nav.style.removeProperty('display');
      } else {
        nav.style.removeProperty('height');
        nav.style.removeProperty('visibility');
        nav.style.removeProperty('display');
      }
    }
    window.addEventListener('resize', resetNavForBreakpoint);
    window.addEventListener('load', resetNavForBreakpoint);

    /************ Background Water Ripple (GSAP) ************/
    function initBackgroundRipple(){
      const prefersReduced = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;
      if (prefersReduced) return;
      const layer = document.getElementById('ripple-layer');
      if (!layer || !window.gsap) return;
      const headerEl = document.getElementById('siteHeader');
      const bannerEl = document.getElementById('bannerHero');

      const deadEls = [ headerEl, bannerEl ].filter(Boolean);
      let deadRects = [];
      function refreshRects(){ deadRects = deadEls.map(el => el.getBoundingClientRect()); }
      refreshRects();
      let refreshScheduled=false;
      function scheduleRefresh(){ if(!refreshScheduled){ refreshScheduled=true; requestAnimationFrame(()=>{refreshRects(); refreshScheduled=false;}); } }
      window.addEventListener('resize', scheduleRefresh, { passive:true });
      window.addEventListener('scroll', scheduleRefresh, { passive:true });
      function isInDeadZone(x,y){ for(const r of deadRects){ if(x>=r.left&&x<=r.right&&y>=r.top&&y<=r.bottom) return true; } return false; }

      const poolSize=22, pool=[]; let idx=0;
      for(let i=0;i<poolSize;i++){ const dot=document.createElement('span'); dot.className='ripple'; dot.style.opacity=0; layer.appendChild(dot); pool.push(dot); }

      let blocked = false;
      function clearRipples(){ pool.forEach(el=>{ gsap.killTweensOf(el); el.style.opacity=0; }); }
      function setBlocked(v){ if (blocked === v) return; blocked = v; if (blocked) clearRipples(); }
      if (headerEl){ headerEl.addEventListener('pointerenter', ()=>setBlocked(true), {passive:true}); headerEl.addEventListener('pointerleave', ()=>setBlocked(false), {passive:true}); }
      if (bannerEl){ bannerEl.addEventListener('pointerenter', ()=>setBlocked(true), {passive:true}); bannerEl.addEventListener('pointerleave', ()=>setBlocked(false), {passive:true}); }

      let lastX=null,lastY=null,lastT=0; const MIN_DT=40, MAX_V=2.2;

      function spawn(x,y,v){
        const el=pool[idx++ % pool.length]; el.style.left=x+'px'; el.style.top=y+'px';
        const vel=Math.min(MAX_V, v||0.8);
        const size=Math.round(130+vel*190);
        const dur=gsap.utils.clamp(0.55,1.35,1.25-vel*0.35);
        el.style.width=size+'px'; el.style.height=size+'px';
        gsap.killTweensOf(el);
        gsap.fromTo(el,{scale:0.25,opacity:0.7},{scale:1.7,opacity:0,duration:dur,ease:'sine.out'});
      }
      window.spawnRipple = function(x,y,v){
        if (blocked) return;
        spawn(x,y,v);
      };

      let rafPending=false, queuedEvent=null;
      function handlePointer(e, forceV){
        if (blocked) return;
        const now=performance.now(); if(now-lastT<MIN_DT) return;
        const x=e.clientX, y=e.clientY; if(isInDeadZone(x,y)) return;
        let v=0.6;
        if(forceV!=null){ v=forceV; }
        else if(lastX!==null){ const dx=x-lastX, dy=y-lastY, dt=(now-lastT); v=Math.hypot(dx,dy)/Math.max(1,dt); }
        lastX=x; lastY=y; lastT=now; spawn(x,y,v);
      }
      function onMove(e){
        if (blocked) return;
        queuedEvent=e;
        if(!rafPending){
          rafPending=true;
          requestAnimationFrame(()=>{ if(queuedEvent) handlePointer(queuedEvent,null); rafPending=false; queuedEvent=null; });
        }
      }
      window.addEventListener('pointermove', onMove, { passive:true });
      window.addEventListener('pointerdown', e=>handlePointer(e,1.2), { passive:true });
    }

    /************ Water surface ************/
    function initWaterStage(){
      if (!window.gsap) return null;
      const canvas = document.getElementById('water-canvas');
      const ctx = canvas.getContext('2d');
      const DPR = window.devicePixelRatio || 1;

      let vw=0, vh=0;
      const state = { baseLevel: 0, colorT: 0, scrolling: 0 };

      const darkTop=[6,18,38],   darkBot=[8,60,110];
      const lightTop=[190,230,255], lightBot=[140,205,255];
      const lerp = (a,b,t)=> a+(b-a)*t;
      function waterGradient(){
        const t = state.colorT;
        const top = [
          Math.round(lerp(darkTop[0], lightTop[0], t)),
          Math.round(lerp(darkTop[1], lightTop[1], t)),
          Math.round(lerp(darkTop[2], lightTop[2], t)),
        ];
        const bot = [
          Math.round(lerp(darkBot[0], lightBot[0], t)),
          Math.round(lerp(darkBot[1], lightBot[1], t)),
          Math.round(lerp(darkBot[2], lightBot[2], t)),
        ];
        const g = ctx.createLinearGradient(0,0,0,vh);
        g.addColorStop(0, `rgba(${top[0]},${top[1]},${top[2]},${lerp(0.90,0.92,t)})`);
        g.addColorStop(1, `rgba(${bot[0]},${bot[1]},${bot[2]},${lerp(0.85,0.88,t)})`);
        return g;
      }

      function resize(){
        vw = window.innerWidth; vh = window.innerHeight;
        canvas.width  = vw * DPR; canvas.height = vh * DPR;
        canvas.style.width = vw+'px'; canvas.style.height = vh+'px';
        ctx.setTransform(DPR,0,0,DPR,0,0);
        waves.forEach(w=>w.resize(vw,vh));
      }
      window.addEventListener('resize', resize);

      function createWave(opts){
        const w = Object.assign({
          amplitude: 24, ampHome: 24, duration: 3, frequency: 2, segments: 120,
          width: vw, height: vh, x: 0, y: 0, points: [], tweens: []
        }, opts||{});

        function kill(){ w.tweens.forEach(t=>t.kill()); w.tweens.length=0; w.points.length=0; }
        function init(){
          kill();
          const seg = w.segments;
          const dx = w.width/seg;
          for (let i=0;i<=seg;i++){
            const p = { x: w.x + i*dx, y: 1 };
            const tw = gsap.to(p, { duration:w.duration, y:-1, ease:'sine.inOut', repeat:-1, yoyo:true })
                           .progress((i/seg)*w.frequency);
            w.tweens.push(tw); w.points.push(p);
          }
        }
        function resize(width,height){
          w.width=width; w.height=height;
          const dx = w.width/w.segments;
          for(let i=0;i<w.points.length;i++){ w.points[i].x = w.x + i*dx; }
        }
        function draw(startY){
          const H = w.amplitude/2;
          const pts = w.points;
          const c = ctx;
          c.beginPath();
          c.moveTo(pts[0].x, startY + pts[0].y*H);
          for(let i=1;i<pts.length;i++){ const p=pts[i]; c.lineTo(p.x, startY + p.y*H); }
          c.lineTo(w.x + w.width, w.y + w.height);
          c.lineTo(w.x, w.y + w.height);
          c.closePath();
          c.fillStyle = waterGradient();
          c.fill();
        }
        w.init = init; w.resize = resize; w.draw = draw; w.kill = kill;
        w.init();
        return w;
      }

      let waves = [];
      function buildWaves(){
        waves = [
          createWave({ amplitude:16, ampHome:16, duration:2.4, frequency:2.4 }),
          createWave({ amplitude:28, ampHome:28, duration:3.2, frequency:1.5 }),
          createWave({ amplitude:44, ampHome:44, duration:4.6, frequency:0.9 })
        ];
      }

      function pauseOscillation(){ waves.forEach(w=>w.tweens.forEach(t=>t.paused(true))); }
      function resumeOscillation(){ waves.forEach(w=>w.tweens.forEach(t=>t.paused(false))); }

      function draw(){
        const ctx2 = ctx;
        ctx2.clearRect(0,0,vw,vh);
        const level = state.baseLevel + state.scrolling;
        waves[0].draw(level +  0);
        waves[1].draw(level +  8);
        waves[2].draw(level + 16);
      }
      const tick = ()=> draw();

      function transitionTo(isLightMode){
        if (!gsap) return;
        const targetLevel = isLightMode ? vh*0.80 : vh*0.18;

        pauseOscillation();
        const tl = gsap.timeline({ onComplete(){ resumeOscillation(); } });

        tl.to(waves, { amplitude: 0, duration: 0.35, ease:'power2.out' }, 0);
        tl.to(state, { colorT: isLightMode ? 1 : 0, duration: 0.9, ease: 'sine.inOut' }, 0);
        tl.to(state, { baseLevel: targetLevel, duration: 1.8, ease: 'power1.inOut' }, 0.1);
        tl.to(waves, { amplitude: (i,w)=> isLightMode ? w.ampHome * 1.9 : w.ampHome, duration: 0.28, ease: 'power2.out' }, "-=0.1")
          .to(waves, { amplitude: (i,w)=> isLightMode ? w.ampHome * 1.6 : w.ampHome, duration: 0.45, ease: 'sine.inOut' });

        return tl;
      }

      resize(); buildWaves(); gsap.ticker.add(tick);

      return {
        transitionTo,
        setModeImmediate(isLightMode){
          state.colorT = isLightMode ? 1 : 0;
          state.baseLevel = isLightMode ? vh*0.80 : vh*0.18;
        }
      };
    }

    (async function boot(){
      const ok = await ensureGSAP();
      if(!ok) return;

      initBackgroundRipple();
      window.waterStage = initWaterStage();
      if (window.waterStage){
        window.waterStage.setModeImmediate(isLight);
      }
      (function syncThemeColor(){
        let meta=document.querySelector('meta[name="theme-color"]');
        if(!meta){ meta=document.createElement("meta"); meta.name="theme-color"; document.head.appendChild(meta); }
        meta.content=getComputedStyle(document.documentElement).getPropertyValue("--bg").trim();
      })();
      if (window.pageInit) window.pageInit();
    })();
  </script>

  <!-- Jump to Loading + Prefetch + collapse events -->
  <script>
    function showLoadingMask(){
      const mask = document.getElementById('loadingMask');
      if(!mask) return;
      mask.style.display = 'flex';
      requestAnimationFrame(()=> mask.classList.add('active'),10);
    }
    function hideLoadingMask(){
      const mask = document.getElementById('loadingMask');
      if(!mask) return;
      mask.classList.remove('active');
      setTimeout(()=>{ mask.style.display='none'; }, 650);
    }
    function forceHideLoadingMask(){
      const mask = document.getElementById('loadingMask');
      if(!mask) return;
      mask.classList.remove('active');
      mask.style.display='none';
    }
    function isBackForwardNav(){
      try{
        const nav = performance.getEntriesByType && performance.getEntriesByType('navigation')[0];
        return nav && nav.type === 'back_forward';
      }catch(e){ return false; }
    }

    function hideMaskWhenHeroReady(e){
      if ((e && e.persisted) || isBackForwardNav()){
        forceHideLoadingMask(); return;
      }
      const hero = document.getElementById('heroVid');
      if (!hero){ hideLoadingMask(); return; }
      const done = () => { clearTimeout(tid); hideLoadingMask(); };
      if (hero.readyState >= 2){ done(); return; }
      hero.addEventListener('loadeddata', done, { once:true });
      const tid = setTimeout(done, 1600);
    }

    window.addEventListener('pageshow', hideMaskWhenHeroReady);
    window.addEventListener('load', hideMaskWhenHeroReady);
    window.addEventListener('pagehide', forceHideLoadingMask);
    document.addEventListener('visibilitychange', ()=>{ if (document.visibilityState === 'hidden') forceHideLoadingMask(); });

    function isInternalLink(a){
      if(!a || !a.href) return false;
      if(a.target === '_blank') return false;
      const href = a.getAttribute('href') || '';
      if(href.startsWith('#')) return false;
      try{
        const url = new URL(a.href, window.location.href);
        return url.origin === window.location.origin;
      }catch(e){ return false; }
    }
    function hasModifierKey(e){ return e.ctrlKey || e.metaKey || e.shiftKey || e.altKey || e.button === 1; }

    document.querySelectorAll('header .menu a').forEach(a=>{
      a.addEventListener('click', (e)=>{
        if(hasModifierKey(e)) return;
        if(!isInternalLink(a)) return;
        e.preventDefault();
        showLoadingMask();
        setTimeout(()=>{ window.location.href = a.href; }, 1000);
      });
    });

    document.querySelectorAll('button.dashboard-btn[data-href]').forEach(btn=>{
      btn.addEventListener('click', (e)=>{
        if(hasModifierKey(e)) return;
        const href = btn.dataset.href;
        if(!href) return;
        e.preventDefault();
        showLoadingMask();
        setTimeout(()=>{ window.location.href = href; }, 1000);
      });
    });

    /* Prefetch home videos */
    const HOME_PATH = new URL("{% url 'home' %}", window.location.origin).pathname;
    const isOnHome = window.location.pathname === HOME_PATH;
    const HOME_VIDEOS = [
      "{% static 'file1.mp4' %}",
      "{% static 'file2.mp4' %}",
      "{% static 'file3.mp4' %}",
      "{% static 'file4.mp4' %}",
      "{% static 'file5.mp4' %}"
    ];

    let homePrefetched = false;
    function canPrefetchNow(){
      const conn = navigator.connection || navigator.mozConnection || navigator.webkitConnection;
      const fastNet = !conn || ['4g','5g','wifi'].includes(conn.effectiveType || '');
      return fastNet;
    }
    function prefetchHomeVideos(){
      if (homePrefetched || isOnHome || !canPrefetchNow()) return;
      homePrefetched = true;
      HOME_VIDEOS.forEach(src=>{
        const l=document.createElement('link');
        l.rel='prefetch'; l.as='video'; l.href=src; l.crossOrigin='anonymous';
        document.head.appendChild(l);
      });
      HOME_VIDEOS.forEach(src=>{
        try{ fetch(src, { mode:'no-cors', cache:'force-cache', priority:'low' }).catch(()=>{}); }catch(e){}
      });
    }

    const homeLink = Array.from(document.querySelectorAll('header .menu a'))
      .find(a => { try { return new URL(a.href, location.href).pathname === HOME_PATH; } catch(e){ return false; }});
    if (homeLink){ homeLink.addEventListener('pointerenter', prefetchHomeVideos, { once:true, passive:true }); }

    if (!isOnHome){
      const idle = window.requestIdleCallback || (fn=>setTimeout(fn, 2000));
      idle(()=> prefetchHomeVideos());
    }

    document.addEventListener('shown.bs.collapse', e => {
      if (e.target && e.target.id === 'primaryNav') window.dispatchEvent(new Event('resize'));
    });
    document.addEventListener('hidden.bs.collapse', e => {
      if (e.target && e.target.id === 'primaryNav') window.dispatchEvent(new Event('resize'));
    });
  </script>

  {% block page_scripts %}{% endblock %}
</body>
</html>
