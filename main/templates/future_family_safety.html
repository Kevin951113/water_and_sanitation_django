{% extends "base.html" %}
{% load static %}

{% block title %}Future & Family Safety | Water and Sanitation{% endblock %}

{% block head_extras %}
<style>
  /* ---------- Theme fallbacks ---------- */
  :root{
    --bg:#0b1220; --text:#e7eef8; --muted:#a7b2c3;
    --card-bg:#101826; --card-stroke:rgba(255,255,255,.08); --shadow:0 6px 30px rgba(0,0,0,.35);
    --select-bg:#0f1723; --chip-bg:rgba(255,255,255,.04); --accent:#3aa6ff;

    /* Screenshot blues for gradient text */
    --ws-blue-1:#8DC7FF; /* light */
    --ws-blue-2:#4EA3FF; /* mid   */
    --ws-blue-3:#1E6FFF; /* deep  */
    --ws-blue-4:#0B3B9C; /* extra deep for light theme tail */
  }
  html[data-theme="light"]{
    --bg:#f6f8fc; --text:#1b2430; --muted:#556171;
    --card-bg:#ffffff; --card-stroke:rgba(0,0,0,.08); --shadow:0 8px 30px rgba(15,23,42,.06);
    --select-bg:#ffffff; --chip-bg:rgba(0,0,0,.04); --accent:#1463d6;
  }

  /* ---------- Cards / layout ---------- */
  .card-box{ background:var(--card-bg); border:1px solid var(--card-stroke); border-radius:22px; box-shadow:var(--shadow); }
  .card-hd{ padding:16px 20px; border-bottom:1px solid var(--card-stroke); font-weight:800; letter-spacing:.3px; display:flex; align-items:center; justify-content:space-between; gap:12px; }
  .card-bd{ padding:18px 20px; }
  .muted{ color:var(--muted); }
  .kv{ display:grid; grid-template-columns:180px 1fr; gap:10px 18px; }
  @media (max-width:576px){ .kv{ grid-template-columns:1fr; } }

  /* ---------- Pills ---------- */
  .pill{ display:inline-block; padding:6px 14px; border-radius:9999px; font-weight:800; font-size:16px; letter-spacing:.02em; }
  .pill-good{ background:#d1fae5; color:#065f46; }
  .pill-fair{ background:#fef3c7; color:#92400e; }
  .pill-poor{ background:#fee2e2; color:#991b1b; }

  /* ---------- Safety bar ---------- */
  .safety-wrap{ position:relative; }
  .safety-bar{
    position:relative; height:22px; border-radius:12px; overflow:hidden;
    background:linear-gradient(90deg,#dc2626 0%,#f59e0b 50%,#16a34a 100%);
    border:1px solid var(--card-stroke);
  }
  .safety-glow{
    position:absolute; top:50%; left:0%; transform:translate(-50%,-50%);
    width:180px; height:80px; pointer-events:none;
    background:radial-gradient(closest-side,var(--glow,#34d399),transparent 65%);
    filter:blur(22px); opacity:.35; transition:left .35s ease, opacity .25s ease, background-color .25s ease;
  }
  .safety-pointer{ position:absolute; top:-16px; transform:translateX(-50%); text-align:center; transition:left .35s ease; }
  .safety-pointer .head{ width:0; height:0; border-left:7px solid transparent; border-right:7px solid transparent; border-bottom:10px solid #111827; margin:0 auto; }
  .safety-pointer .label{ background:#111827; color:#fff; padding:3px 8px; border-radius:8px; font-size:14px; margin-top:4px; text-transform:capitalize; }
  .safety-legend{ display:flex; justify-content:space-between; font-weight:900; font-size:18px; margin-top:8px; }

  /* ---------- Form controls ---------- */
  .form-label{ color:var(--text); }
  .form-control-like{ width:100%; padding:10px 12px; border:1px solid var(--card-stroke); border-radius:12px; background:var(--select-bg); color:var(--text); }
  select.form-control-like option{ color:var(--text); background:var(--select-bg); }
  select.form-control-like:focus{ outline:2px solid var(--accent); outline-offset:2px; }
  .btn-primary-like{ background:linear-gradient(90deg,#08497e 0%,#0e6fc0 50%,#5dade2 100%); color:#fff; border:none; border-radius:12px; padding:10px 14px; font-weight:800; width:100%; }
  .btn-primary-like:hover{ filter:brightness(1.05); }

  /* ---------- Chart legend chips ---------- */
  .legend-chip{ display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border:1px solid var(--card-stroke); border-radius:10px; background:var(--chip-bg); color:var(--text); font-weight:700; cursor:pointer; user-select:none; }
  .legend-dot{ width:10px; height:10px; border-radius:9999px; background:currentColor; }
  .legend-chip[aria-pressed="false"]{ opacity:.55; }
  .legend-chip:focus-visible{ outline:2px solid var(--accent); outline-offset:3px; }
  .legend-chip{
  background: rgba(17,24,39,0.92);
  border:1px solid rgba(80,160,255,0.25);
  box-shadow:
    inset 0 0 8px rgba(80,160,255,0.15), /* inner glow */
    0 0 10px rgba(80,160,255,0.18);      /* outer glow */
}

  /* ---------- Chart ---------- */
  .chart-wrap{ position:relative; height:220px; }
  #ffChart{ width:100% !important; height:100% !important; display:block; }

  /* ---------- KPI ---------- */
  .kpi{ text-align:center; padding:18px; min-height: 120px;  }
  .kpi .kpi-label{ color:var(--muted); font-size:20px; margin-bottom:6px; }
  .kpi .kpi-value{ font-weight:900; font-size:42px; line-height:1.1; letter-spacing:.5px; }
  .kpi .kpi-pill{ margin-top:4px; }
  .kpi {
  background: rgba(17, 24, 39, 0.95);
  border: 1px solid rgba(80,160,255,0.25);
  box-shadow: 
    inset 0 0 10px rgba(80,160,255,0.15), /* inner glow */
    0 0 12px rgba(80,160,255,0.15);       /* outer glow */
}

.legend-chip[aria-pressed="false"] {
  opacity: .55;
  text-decoration: line-through;
  text-decoration-thickness: 2px;
  text-decoration-color: currentColor;
}

  /* ---------- Expanders ---------- */
  details.expander{ margin-left:auto; }
  details.expander > summary{
    list-style:none; cursor:pointer; user-select:none;
    border:1px solid var(--card-stroke); background:var(--chip-bg);
    padding:6px 12px; border-radius:10px; font-weight:800; font-size:14px; color:var(--text);
    display:flex; align-items:center; gap:8px;
  }
  details.expander[open] > summary{ opacity:.85; }
  details.expander .body{
    margin-top:10px; background:linear-gradient(180deg, rgba(59,130,246,.10), transparent);
    border:1px dashed var(--card-stroke); border-radius:12px; padding:14px 16px; color:var(--text);
  }
  .explain-block{ margin-bottom:14px; padding-bottom:10px; border-bottom:1px solid rgba(255,255,255,.08); }
  .explain-title{ font-weight:800; color:var(--accent); margin:0 0 6px; }
  .exp-list{ margin:0 0 0 1.1rem; color:var(--muted); }
  .exp-list li{ margin-bottom:6px; }

  /* ---------- Title / subtitle ---------- */
  .page-lead{ display:flex; flex-direction:column; align-items:flex-start; }
  .page-lead h1{ margin:0 0 6px; }
  .page-lead p{ margin:0; }

  /* ---------- Blue gradient titles (with fallback) ---------- */
  .ws-grad{ color:var(--ws-blue-3); text-shadow:none; }
  .cap-textclip .ws-grad{
    background: linear-gradient(180deg,var(--ws-blue-1) 0%, var(--ws-blue-2) 55%, var(--ws-blue-3) 100%);
    -webkit-background-clip:text; background-clip:text; color:transparent; -webkit-text-fill-color:transparent;
  }
  /* Light theme needs a deeper tail for clarity */
  html[data-theme="light"] .ws-grad{ color:var(--ws-blue-3); }
  html[data-theme="light"] .cap-textclip .ws-grad{
    background: linear-gradient(180deg,var(--ws-blue-2) 0%, var(--ws-blue-3) 60%, var(--ws-blue-4) 100%);
    -webkit-background-clip:text; background-clip:text; color:transparent; -webkit-text-fill-color:transparent;
  }

  /* ---------- Loading overlay ---------- */
  #loading-overlay[hidden]{ display:none; }
  #loading-overlay{
    position:fixed; inset:0; z-index:9999;
    display:grid; place-items:center;
    background:rgba(11,18,32,.45);
    backdrop-filter: blur(6px);
    -webkit-backdrop-filter: blur(6px);
  }
  .loading-center{ display:flex; flex-direction:column; align-items:center; gap:14px; }
  .loading-title{
    font-weight:900;
    font-size:36px;
    background: linear-gradient(180deg,#d9efff 0%, #8dc7ff 60%, #4ea3ff 100%);
    -webkit-background-clip: text; background-clip:text; color:transparent;
    text-shadow: 0 2px 14px rgba(78,163,255,.28);
  }

  /* ---------- GSAP droplet ---------- */
  .gsap-drop{ width:22px; height:22px; display:inline-flex; align-items:center; justify-content:center; }
  .gsap-drop .drop-svg{ width:22px; height:22px; display:block; }
  details.expander > summary .gsap-drop{ margin-right:2px; }

  /* ---------- Focus handling for #safety ---------- */
  #safety{ scroll-margin-top:220px; }
  #safety:focus, #safety:focus-visible{
    outline:3px solid #fff; outline-offset:6px;
    box-shadow:0 0 0 4px rgba(255,255,255,.9), 0 0 0 8px rgba(59,130,246,.35);
    border-radius:22px;
  }

  /* ---------- Attention ring for form on validation ---------- */
  @keyframes attnPulse{
    0%{ box-shadow:0 0 0 0 rgba(30,111,255,.35); }
    100%{ box-shadow:0 0 0 8px rgba(30,111,255,0); }
  }
  .attn{
    border-color:#1E6FFF !important;
    box-shadow:0 0 0 3px rgba(30,111,255,.25);
    animation:attnPulse .9s ease-out 2;
  }

  /* ==========================
     NEW: water-* interactive
     ========================== */
  .water-wrap{ display:grid; grid-template-columns:360px 1fr; gap:18px; }
  @media (max-width: 992px){ .water-wrap{ grid-template-columns:1fr; } }

  .water-tiles{ display:flex; flex-direction:column; gap:12px; }
.water-tile{
  display:flex; align-items:center; justify-content:space-between; gap:14px;
  padding:14px 16px; border-radius:16px;
  background: rgba(17, 24, 39, 0.95);
  border:1px solid rgba(80,160,255,0.25);
  cursor:pointer;
  transition: box-shadow .18s ease, border-color .18s ease, transform .06s ease;
  box-shadow:
    inset 0 0 8px rgba(80,160,255,0.12),
    0 0 8px rgba(80,160,255,0.15);
}
.water-tile:hover{
  transform:translateY(-1px);
  border-color:rgba(80,160,255,0.45);
  box-shadow:
    inset 0 0 10px rgba(80,160,255,0.18),
    0 0 12px rgba(80,160,255,0.25);
}
.water-tile.is-active{
  border-color:rgba(80,160,255,0.85);
  background:linear-gradient(180deg, rgba(80,160,255,.12), transparent 55%);
  box-shadow:
    inset 0 0 12px rgba(80,160,255,0.25),
    0 0 16px rgba(80,160,255,0.35);
}

  .water-left{ display:flex; align-items:center; gap:12px; min-width:0; }
  .water-drop{ width:34px; height:34px; border-radius:12px; display:grid; place-items:center; background:linear-gradient(180deg,#cfe8ff,#8dbdff); flex:0 0 34px; }
  .water-drop svg{ width:20px; height:20px; display:block; }
  .water-labels{ display:flex; flex-direction:column; min-width:0; }
  .water-name{ font-weight:900; color:var(--text); }
  .water-sub{ color:var(--muted); font-size:13px; }
  .water-value{ font-weight:900; font-size:18px; letter-spacing:.2px; white-space:nowrap; color:var(--text); }

  /* --------- Numeric values gradient (red/yellow/green) with safe fallback --------- */
  .water-value.grad-red{ color:#ef4444; }
  .water-value.grad-yellow{ color:#f59e0b; }
  .water-value.grad-green{ color:#22c55e; }
  .cap-textclip .water-value.grad-red{
    background-image:linear-gradient(180deg,#fca5a5 0%, #ef4444 100%);
    -webkit-background-clip:text; background-clip:text; color:transparent; -webkit-text-fill-color:transparent;
  }
  .cap-textclip .water-value.grad-yellow{
    background-image:linear-gradient(180deg,#fde68a 0%, #f59e0b 100%);
    -webkit-background-clip:text; background-clip:text; color:transparent; -webkit-text-fill-color:transparent;
  }
  .cap-textclip .water-value.grad-green{
    background-image:linear-gradient(180deg,#86efac 0%, #22c55e 100%);
    -webkit-background-clip:text; background-clip:text; color:transparent; -webkit-text-fill-color:transparent;
  }

  .water-panel{ border-radius:18px; border:1px solid var(--card-stroke); background:linear-gradient(180deg, rgba(80,160,255,.08), transparent 60%); padding:18px; }
  .water-panel h3{ margin:0 0 6px; font-size:20px; font-weight:900; color:var(--text); }
  .water-panel .water-measured{ font-weight:800; margin-bottom:8px; color:var(--text); }
  .water-badge{ display:inline-block; padding:6px 10px; border-radius:999px; font-weight:800; font-size:12px; margin-left:8px; }
  .water-badge.ok{ background:#d1fae5; color:#065f46; }
  .water-badge.warn{ background:#fef3c7; color:#92400e; }
  .water-badge.bad{ background:#fee2e2; color:#991b1b; }
  .water-list{ margin:8px 0 0 1rem; font-size:16px; line-height:1.65; color:var(--text); }
  .water-foot{ color:var(--muted); font-size:12px; margin-top:10px; }


    .img-box {
      padding: 16px;
      border-radius: 22px;
      background: rgba(17,24,39,0.85); /* Dark glass base */
      backdrop-filter: blur(8px) saturate(150%);
      -webkit-backdrop-filter: blur(8px) saturate(150%);
      border: 1px solid rgba(80,160,255,0.25);
      box-shadow:
        inset 0 0 10px rgba(80,160,255,0.15),  /* Inner blue halo */
        0 0 20px rgba(80,160,255,0.35);        /* outer blue halo */
    }

    .family-gallery {
      display: flex;
      justify-content: center;
      gap: 24px;    
      flex-wrap: wrap; 
    }

    .family-img {
      max-width: 400px;   /* Size limit */
      width: 100%;        /* Responsive scaling */
      height: auto;
      border-radius: 18px;
      display: inline-block;
    }

    .img-box {
      position: relative; 
      overflow: visible;  
    }

    .platypus-sleep {
      position: absolute;
      bottom: -24px;         
      right: 24px;       
      width: 300px;      
      height: auto;
      z-index: 10;  
      pointer-events: none;


      filter: drop-shadow(0 -3px 4px rgba(0,0,0,0.3))
              drop-shadow(0 0 8px rgba(30,111,255,0.4));
      transform: translateY(30%); 
    }



    .range-card {
  margin: 18px 0 22px;
  padding: 14px 16px;
  border-radius: 18px;
  background: rgba(17, 24, 39, 0.92); 
  border: 1px solid rgb(80, 159, 255);
  box-shadow:
    inset 0 0 8px rgba(80,160,255,0.18),
    0 0 12px rgba(80,160,255,0.28);
}

html[data-theme="light"] .range-card {
  background: rgba(255,255,255,0.72);
  backdrop-filter: blur(12px) saturate(160%);
  -webkit-backdrop-filter: blur(12px) saturate(160%);
  border: 1px solid rgba(80,160,255,0.45);
  box-shadow:
    inset 0 0 10px rgba(80,160,255,0.15),
    0 0 18px rgba(80,160,255,0.25);
}

.range-table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 10px;
  font-size: 15px;
  border-radius: 12px;
  overflow: hidden;
}

.range-table th, .range-table td {
  padding: 10px 14px;
  border: 1px solid rgba(80,160,255,0.25);
  text-align: center;
}

.range-table th {
  background: rgba(59,130,246,0.15);
  font-weight: 800;
  color: var(--text);
}

.range-safe { background: rgba(34,197,94,0.15); color: #22c55e; font-weight: 700; }
.range-borderline { background: rgba(234,179,8,0.15); color: #eab308; font-weight: 700; }
.range-unsafe { background: rgba(239,68,68,0.15); color: #ef4444; font-weight: 700; }


  /* =========================================================
     LIGHT THEME "FROSTED GLASS" OVERRIDES FOR FIVE SECTIONS
     - We only change surfaces of the 5 requested parts in light mode.
     - Dark mode remains unchanged.
     ========================================================= */
  html[data-theme="light"] .card-box{
    /* Frosted glass for the 4 major cards (filters, safety, chemistry, 48h) */
    background: rgba(255,255,255,0.68);
    backdrop-filter: blur(12px) saturate(160%);
    -webkit-backdrop-filter: blur(12px) saturate(160%);
    border-color: rgba(255,255,255,0.45);
    box-shadow: 0 10px 30px rgba(15,23,42,0.08);
  }
  html[data-theme="light"] .kpi{
    /* KPI tiles inside the cards also get the same surface feel */
    background: rgba(255,255,255,0.68);
    backdrop-filter: blur(12px) saturate(160%);
    -webkit-backdrop-filter: blur(12px) saturate(160%);
    border: 1px solid rgba(255,255,255,0.45);
  }
  html[data-theme="light"] .water-tile{
    /* Left metric tiles (pH / EC / DO / ORP) as frosted chips */
    background: rgba(255,255,255,0.6);
    backdrop-filter: blur(10px) saturate(160%);
    -webkit-backdrop-filter: blur(10px) saturate(160%);
    border-color: rgba(255,255,255,0.45);
  }
  html[data-theme="light"] .water-panel{
    /* Right detail panel uses a slightly stronger blur to separate from background */
    background: rgba(255,255,255,0.62);
    backdrop-filter: blur(12px) saturate(160%);
    -webkit-backdrop-filter: blur(12px) saturate(160%);
    border-color: rgba(255,255,255,0.5);
  }
  html[data-theme="light"] details.expander .body{
    /* The collapsible info body also becomes frosted for consistency */
    background: rgba(255,255,255,0.5);
    backdrop-filter: blur(10px) saturate(160%);
    -webkit-backdrop-filter: blur(10px) saturate(160%);
    border: 1px dashed rgba(0,0,0,0.12);
  }
  html[data-theme="light"] #loading-overlay{
    /* (5) Full-screen loading overlay turns into a light frosted veil */
    background: rgba(255,255,255,0.55);
    backdrop-filter: blur(10px) saturate(180%);
    -webkit-backdrop-filter: blur(10px) saturate(180%);
  }

  /* Dark mode legend-chip */
  html[data-theme="dark"] .legend-chip {
    background: rgba(17,24,39,0.92);
    border: 1px solid rgba(80,160,255,0.35);
    box-shadow:
      inset 0 0 8px rgba(80,160,255,0.25),
      0 0 12px rgba(80,160,255,0.35);
  }

  /* Light mode legend-chip */
  html[data-theme="light"] .legend-chip {
        /* Right detail panel uses a slightly stronger blur to separate from background */
      background: rgba(255,255,255,0.62);
      backdrop-filter: blur(12px) saturate(160%);
      -webkit-backdrop-filter: blur(12px) saturate(160%);
      border-color: rgba(255,255,255,0.5);
    border: 1px solid rgba(80,160,255,0.4);
    box-shadow:
      inset 0 0 6px rgba(80,160,255,0.2),
      0 0 8px rgba(80,160,255,0.25);
  }

  /* Dark mode water-panel */
  html[data-theme="dark"] .water-panel {
    background: rgba(17,24,39,0.95);
    border: 1px solid rgba(80,160,255,0.35);
    box-shadow:
      inset 0 0 8px rgba(80,160,255,0.2),
      0 0 12px rgba(80,160,255,0.25);
  }

  /* Light mode water-panel */
  html[data-theme="light"] .water-panel {
    background: rgba(255,255,255,0.25);
    backdrop-filter: blur(12px) saturate(160%);
    -webkit-backdrop-filter: blur(12px) saturate(160%);
    border: 1px solid rgba(80,160,255,0.4);
    box-shadow:
      inset 0 0 6px rgba(80,160,255,0.2),
      0 0 12px rgba(80,160,255,0.3);
  }

  /* -------- Dark mode -------- */
  html[data-theme="dark"] .card-box {
    background: rgba(17,24,39,0.95); /* Maintain a dark background */
    border: 1px solid rgba(30,111,255,0.6); /* Blue border */
    box-shadow:
      inset 0 0 12px rgba(30,111,255,0.25), /* inner halo */
      0 0 20px rgba(30,111,255,0.45);       /* outer halo */
  }

  /* -------- Light mode -------- */
  html[data-theme="light"] .card-box {
    background: rgba(255,255,255,0.68); /* Retain the glass-like appearance */
    backdrop-filter: blur(12px) saturate(160%);
    -webkit-backdrop-filter: blur(12px) saturate(160%);
    border: 1px solid rgba(30,111,255,0.35); /* A lighter blue border */
    box-shadow:
      inset 0 0 10px rgba(30,111,255,0.15), /* inner halo */
      0 0 18px rgba(30,111,255,0.25);       /* outer halo */
  }

  html[data-theme="light"] .img-box {
  background: linear-gradient(180deg, rgba(78,163,255,0.15), rgba(255,255,255,0.8));
  border-color: rgba(30,111,255,0.3);
  box-shadow:
    inset 0 0 10px rgba(30,111,255,0.12),
    0 0 18px rgba(30,111,255,0.28);
}


</style>
{% endblock %}

{% block content %}
<div class="container" style="max-width:1100px; margin:0 auto;">
  <header class="page-lead" style="margin: 8px 0 14px;">
    <h1 class="ws-grad" style="font-size:28px; font-weight:900;">Future &amp; Family Safety</h1>
    <p class="muted">
      Simple Good / Fair / Poor guidance for <strong>{{ horizon_days|default:2 }}</strong> days ahead, plus how conditions may change over the next 48 hours.
    </p>
  </header>

  <!-- Filters -->
  <form id="forecast-form" method="get" class="card-box" style="margin-bottom:18px;">
    <div class="card-hd"><span class="ws-grad">Choose Area &amp; Days Ahead</span></div>
    <div class="card-bd">
      <div class="row g-3 align-items-end">
        <div class="col-lg-6">
          <label for="site_id" class="form-label fw-bold">Site ID</label>
          {% if site_options %}
            <select id="site_id" name="site_id" class="form-control-like">
              <option value="" disabled {% if not site_id %}selected{% endif %}>Select a site…</option>
              {% for sid in site_options %}
                <option value="{{ sid }}" {% if sid == site_id %}selected{% endif %}>{{ sid }}</option>
              {% endfor %}
            </select>
          {% else %}
            <input id="site_id" name="site_id" class="form-control-like" type="text" value="{{ site_id|default:'' }}" placeholder="e.g. 97226">
            <div class="muted" style="font-size:12px; margin-top:6px;">Tip: pass a list as <code>site_options</code> from the view to show a dropdown.</div>
          {% endif %}
        </div>
        <div class="col-lg-3">
          <label for="horizon_days" class="form-label fw-bold">Days ahead</label>
          <input id="horizon_days" name="horizon_days" class="form-control-like" type="number" min="1" max="90" value="{{ horizon_days|default:2 }}">
        </div>
        <div class="col-lg-3">
          <button id="btn-forecast" type="submit" class="btn-primary-like">Get forecast</button>
        </div>
      </div>
    </div>
  </form>

  <!-- Family Safety Indicator -->
  <section class="card-box" id="safety" style="margin-bottom:18px;" tabindex="-1">
    <div class="card-hd">
      <span class="ws-grad">Family Safety Indicator</span>
      <details class="expander">
        <summary>
          <!-- Animated droplet icon -->
          <span class="gsap-drop" aria-hidden="true">
            <svg class="drop-svg" viewBox="0 0 64 64">
              <defs>
                <radialGradient id="dropGrad" cx="50%" cy="35%" r="70%">
                  <stop offset="0%"  stop-color="#e6f4ff"/>
                  <stop offset="55%" stop-color="#5aa5ff"/>
                  <stop offset="100%" stop-color="#1e6fff"/>
                </radialGradient>
                <filter id="dropGlow" x="-60%" y="-60%" width="220%" height="220%">
                  <feGaussianBlur stdDeviation="2" result="b"/>
                  <feMerge><feMergeNode in="b"/><feMergeNode in="SourceGraphic"/></feMerge>
                </filter>
              </defs>
              <g class="drop-wrap" filter="url(#dropGlow)">
                <path class="drop-blob" d="M32 4C26 14 16 22 16 34c0 8.8 7.2 16 16 16s16-7.2 16-16C48 22 38 14 32 4z" fill="url(#dropGrad)"/>
              </g>
            </svg>
          </span>
          What’s this?
        </summary>
        <div class="body">
          <div class="explain-block">
            <p class="explain-title">What</p>
            <p>A single 0–100 score summarizing how safe the water is for families at this site.</p>
          </div>
          <div class="explain-block">
            <p class="explain-title">How to read</p>
            <ul class="exp-list">
              <li>The pointer shows where today’s score lands on the Poor > Fair > Good bar.</li>
              <li>The category pill (Poor / Fair / Good) matches the score.</li>
            </ul>
          </div>
          <div class="explain-block">
            <p class="explain-title">Why it matters</p>
            <p>It gives a quick, plain-language view to help decide everyday use: playing, swimming, or avoiding water.</p>
          </div>
        </div>
      </details>
    </div>
    <div class="card-bd">
      {% if result %}
        {% with score=result.quality.score category=result.quality.category %}
          <div class="safety-wrap">
            <div class="safety-bar" aria-label="Safety bar">
              <div id="ff-glow" class="safety-glow"></div>
            </div>
            <div id="ff-pointer" class="safety-pointer" style="left:0%">
              <div class="head"></div>
              <div class="label" id="ff-pointer-label">{{ category|default:"unknown" }}</div>
            </div>
          </div>
          <div class="safety-legend">
            <span style="color:#ef4444;">Poor</span>
            <span style="color:#d97706;">Fair</span>
            <span style="color:#059669;">Good</span>
          </div>

          <div class="row g-3 mt-3">
            <div class="col-12 col-md-4">
              <div class="card-box kpi">
                <div class="kpi-label">Score</div>
                <div class="kpi-value" id="kpi-score">0</div>
              </div>
            </div>
            <div class="col-12 col-md-4">
              <div class="card-box kpi">
                <div class="kpi-label">Category</div>
                <div class="kpi-pill">
                  {% if category == "good" %}
                    <span class="pill pill-good">Good</span>
                  {% elif category == "fair" %}
                    <span class="pill pill-fair">Fair</span>
                  {% else %}
                    <span class="pill pill-poor">Poor</span>
                  {% endif %}
                </div>
              </div>
            </div>
            <div class="col-12 col-md-4">
              <div class="card-box kpi">
                <div class="kpi-label">Checked on</div>
                <div style="font-weight:800; font-size:24px;">{{ result.last_updated|default:"–" }}</div>
              </div>
            </div>
          </div>
        {% endwith %}
      {% else %}
        <p class="muted mb-0">Pick a site and click <strong>Get forecast</strong> to see the indicator.</p>
      {% endif %}
    </div>
  </section>


<!-- Family illustration section -->
<div class="card-box img-box" style="margin: 22px 0; text-align:center; position:relative;">
  <div class="family-gallery">
    <img src="{% static 'family_fishing.png' %}" alt="Family fishing illustration" class="family-img">
    <img src="{% static 'family_camping.png' %}" alt="Family camping illustration" class="family-img">
  </div>

  <!-- Platypus sleeping at bottom right -->
  <img src="{% static 'platypus_family_sleep.png' %}" alt="Platypus sleeping" class="platypus-sleep">

  <h3 style="margin-top:12px; font-weight:900; font-size:20px; color:var(--ws-blue-2);">
    Family & Water Safety
  </h3>
  <p class="muted" style="margin:6px auto 0; max-width:500px;">
    Safe rivers and lakes let families enjoy camping, fishing, swimming, and spending time together — without worrying about hidden risks.
  </p>
</div>



  <!-- Water chemistry interactive (integrated block) -->
  <section class="card-box" style="margin-bottom:18px;">
    <div class="card-hd">
      <span class="ws-grad">Water Chemistry (in {{ horizon_days|default:2 }} days)</span>
      <details class="expander">
        <summary>
          <span class="gsap-drop" aria-hidden="true">
            <svg class="drop-svg" viewBox="0 0 64 64">
              <defs>
                <radialGradient id="dropGrad" cx="50%" cy="35%" r="70%">
                  <stop offset="0%"  stop-color="#e6f4ff"/>
                  <stop offset="55%" stop-color="#5aa5ff"/>
                  <stop offset="100%" stop-color="#1e6fff"/>
                </radialGradient>
                <filter id="dropGlow" x="-60%" y="-60%" width="220%" height="220%">
                  <feGaussianBlur stdDeviation="2" result="b"/>
                  <feMerge><feMergeNode in="b"/><feMergeNode in="SourceGraphic"/></feMerge>
                </filter>
              </defs>
              <g class="drop-wrap" filter="url(#dropGlow)">
                <path class="drop-blob" d="M32 4C26 14 16 22 16 34c0 8.8 7.2 16 16 16s16-7.2 16-16C48 22 38 14 32 4z" fill="url(#dropGrad)"/>
              </g>
            </svg>
          </span>
          What’s this?
        </summary>
        <div class="body">
          <div class="explain-block">
            <p class="explain-title">What</p>
            <p>A quick snapshot of expected water chemistry at the end of your selected window.</p>
          </div>
          <div class="explain-block">
            <p class="explain-title">How to read</p>
            <ul class="exp-list">
              <li><b>pH</b> – acidity/alkalinity (7 ≈ neutral).</li>
              <li><b>EC (µS/cm)</b> – salinity/ions; higher = saltier water.</li>
              <li><b>DO (mg/L)</b> – dissolved oxygen; higher is usually better for aquatic life.</li>
              <li><b>Redox (mV)</b> – oxidation-reduction potential; more positive = more oxidizing.</li>
            </ul>
          </div>
          <div class="explain-block">
            <p class="explain-title">Why it matters</p>
            <p>These values explain <em>why</em> the safety score falls into Poor / Fair / Good and guide simple checks at home or on site.</p>
          </div>
        </div>
      </details>
    </div>
    <div class="card-bd">
      {% if result %}
      <div class="water-wrap">
        <div class="water-tiles" id="water-tiles">
          <button type="button" class="water-tile" id="water-tile-ph" data-water-metric="ph">
            <div class="water-left">
              <div class="water-drop" aria-hidden="true">
                <svg viewBox="0 0 24 24"><path d="M12 3C9 8 5 11 5 15a7 7 0 0 0 14 0c0-4-4-7-7-12Z" fill="#0ea5e9"/></svg>
              </div>
              <div class="water-labels"><span class="water-name">pH</span><span class="water-sub">Acidity / alkalinity</span></div>
            </div>
            <div class="water-value" id="water-val-ph">—</div>
          </button>

          <button type="button" class="water-tile" id="water-tile-ec" data-water-metric="ec">
            <div class="water-left">
              <div class="water-drop" aria-hidden="true">
                <svg viewBox="0 0 24 24"><path d="M12 3C9 8 5 11 5 15a7 7 0 0 0 14 0c0-4-4-7-7-12Z" fill="#0ea5e9"/></svg>
              </div>
              <div class="water-labels"><span class="water-name">EC (µS/cm)</span><span class="water-sub">Salts / minerals</span></div>
            </div>
            <div class="water-value" id="water-val-ec">—</div>
          </button>

          <button type="button" class="water-tile" id="water-tile-do" data-water-metric="do">
            <div class="water-left">
              <div class="water-drop" aria-hidden="true">
                <svg viewBox="0 0 24 24"><path d="M12 3C9 8 5 11 5 15a7 7 0 0 0 14 0c0-4-4-7-7-12Z" fill="#0ea5e9"/></svg>
              </div>
              <div class="water-labels"><span class="water-name">DO (mg/L)</span><span class="water-sub">Dissolved oxygen</span></div>
            </div>
            <div class="water-value" id="water-val-do">—</div>
          </button>

          <button type="button" class="water-tile" id="water-tile-orp" data-water-metric="orp">
            <div class="water-left">
              <div class="water-drop" aria-hidden="true">
                <svg viewBox="0 0 24 24"><path d="M12 3C9 8 5 11 5 15a7 7 0 0 0 14 0c0-4-4-7-7-12Z" fill="#0ea5e9"/></svg>
              </div>
              <div class="water-labels"><span class="water-name">Redox (mV)</span><span class="water-sub">Oxidation–reduction</span></div>
            </div>
            <div class="water-value" id="water-val-orp">—</div>
          </button>
        </div>

        <div class="water-panel">
          <h3 id="water-panel-title">Pick a metric</h3>
          <div class="water-measured" id="water-panel-measured">Measured ~ —</div>
          <div id="water-panel-badge"></div>
          <ul class="water-list" id="water-panel-list"></ul>
          <div class="water-foot">Numbers are rounded for display.</div>
        </div>
      </div>
      {% else %}
        <p class="muted mb-0">No prediction yet.</p>
      {% endif %}
    </div>

    <details class="range-card" open>
  <summary style="font-weight:800; font-size:15px; cursor:pointer;">
    Show safe ranges for EC / DO / Redox
  </summary>
  <div class="body" style="margin-top:12px;">
    <table class="range-table">
      <thead>
        <tr>
          <th>Metric</th>
          <th>Safe</th>
          <th>Borderline</th>
          <th>Unsafe</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><strong>EC (µS/cm)</strong></td>
          <td class="range-safe">&lt; 1,500</td>
          <td class="range-borderline">1,500–5,000</td>
          <td class="range-unsafe">&gt; 5,000</td>
        </tr>
        <tr>
          <td><strong>DO (mg/L)</strong></td>
          <td class="range-safe">&gt; 5</td>
          <td class="range-borderline">3–5</td>
          <td class="range-unsafe">&lt; 3</td>
        </tr>
        <tr>
          <td><strong>Redox (mV)</strong></td>
          <td class="range-safe">+200–600</td>
          <td class="range-borderline">0–200</td>
          <td class="range-unsafe">&lt; 0</td>
        </tr>
      </tbody>
    </table>
  </div>
</details>

  </section>
  

  <!-- 48-hour forecast -->
  <section class="card-box" style="margin-bottom:18px;">
    <div class="card-hd">
      <span class="ws-grad">48-Hour Forecast (Keep Using vs Avoid Water)</span>
      <details class="expander">
        <summary>
          <span class="gsap-drop" aria-hidden="true">
            <svg class="drop-svg" viewBox="0 0 64 64">
              <defs>
                <radialGradient id="dropGrad" cx="50%" cy="35%" r="70%">
                  <stop offset="0%"  stop-color="#e6f4ff"/>
                  <stop offset="55%" stop-color="#5aa5ff"/>
                  <stop offset="100%" stop-color="#1e6fff"/>
                </radialGradient>
                <filter id="dropGlow" x="-60%" y="-60%" width="220%" height="220%">
                  <feGaussianBlur stdDeviation="2" result="b"/>
                  <feMerge><feMergeNode in="b"/><feMergeNode in="SourceGraphic"/></feMerge>
                </filter>
              </defs>
              <g class="drop-wrap" filter="url(#dropGlow)">
                <path class="drop-blob" d="M32 4C26 14 16 22 16 34c0 8.8 7.2 16 16 16s16-7.2 16-16C48 22 38 14 32 4z" fill="url(#dropGrad)"/>
              </g>
            </svg>
          </span>
          What’s this?
        </summary>
        <div class="body">
          <div class="explain-block">
            <p class="explain-title">What</p>
            <p>Two “what-if” lines showing how the safety score may move in the next 48 hours.</p>
          </div>
          <div class="explain-block">
            <p class="explain-title">Scenarios</p>
            <ul class="exp-list">
              <li><b>Keep Using</b> – continue using the water as usual (no extra precautions).</li>
              <li><b>Avoid Water</b> – families avoid direct use (no swimming, playing, or drinking) until conditions improve.</li>
            </ul>
          </div>
          <div class="explain-block">
            <p class="explain-title">How to read</p>
            <p>The gap between the two lines ≈ expected safety benefit from avoiding water. Hover points to see local time and score.</p>
          </div>
          <div class="explain-block">
            <p class="explain-title">Why it matters</p>
            <p>Helps decide whether to <em>hold off using the water now</em> or if it’s reasonably safe to continue.</p>
          </div>
        </div>
      </details>
    </div>
    <div class="card-bd">
      <div class="d-flex align-items-center gap-2" style="margin-bottom:10px;">
        <button type="button" class="legend-chip" id="btnKeepUsing" aria-pressed="true" title="Toggle Keep Using">
          <span class="legend-dot" style="color:#60a5fa;"></span> Keep Using
        </button>
        <button type="button" class="legend-chip" id="btnAvoidWater" aria-pressed="true" title="Toggle Avoid Water">
          <span class="legend-dot" style="color:#34d399;"></span> Avoid Water
        </button>
      </div>
      <div class="chart-wrap">
        <canvas id="ffChart"></canvas>
      </div>
      <p class="muted" style="margin-top:10px; font-size:12px;">Hover to see time and score. Click chips to show/hide scenarios.</p>
    </div>
  </section>

  {% if result %}{{ result|json_script:"ff-result" }}{% endif %}
</div>

<!-- Full-screen loading overlay -->
<div id="loading-overlay" role="dialog" aria-live="polite" aria-label="Loading" hidden>
  <div class="loading-center">
    <div id="lottie-box" style="width:300px;height:300px;"></div>
    <div class="loading-title">Loading…</div>
  </div>
</div>
{% endblock %}

{% block page_scripts %}
<!-- Chart.js -->
<script>
  (function loadChartJs(){
    if(window.Chart) return;
    const s=document.createElement('script');
    s.src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js";
    s.defer=true; document.head.appendChild(s);
  })();
</script>

<!-- Lottie -->
<script>
  (function loadLottie(){
    if(window.lottie) return;
    const s=document.createElement('script');
    s.src="https://cdnjs.cloudflare.com/ajax/libs/bodymovin/5.12.2/lottie.min.js";
    s.defer=true; document.head.appendChild(s);
  })();
</script>

<!-- GSAP -->
<script>
  (function loadGSAP(){
    if(window.gsap) return;
    const s=document.createElement('script');
    s.src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js";
    s.defer=true; document.head.appendChild(s);
  })();
</script>

<!-- SweetAlert2 -->
<script>
  (function loadSwal(){
    if(window.Swal) return;
    const s=document.createElement('script');
    s.src="https://cdn.jsdelivr.net/npm/sweetalert2@11";
    s.defer=true; document.head.appendChild(s);
  })();
</script>

<script>
  /* Detect text-clip support for gradient text (avoid invisible text in dark mode) */
  (function detectTextClip(){
    try{
      var ok = (window.CSS && (CSS.supports('background-clip:text') || CSS.supports('-webkit-background-clip:text')));
      if(ok) document.documentElement.classList.add('cap-textclip');
    }catch(e){}
  })();

  /* ---------- Utilities ---------- */
  function parseTs(ts){
    if(ts==null) return new Date(NaN);
    if(typeof ts==='number'){ if(ts<1e12) ts*=1000; return new Date(ts); }
    if(typeof ts==='string'){
      let s=ts.trim();
      if(/^\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}$/.test(s)) s=s.replace(' ','T')+'Z';
      if(!/[zZ]|[+\-]\d{2}:?\d{2}$/.test(s)) s+='Z';
      return new Date(s);
    }
    return new Date(NaN);
  }
  function fmt(n){ return (Math.round(Number(n)*100)/100).toFixed(2); }
  function scoreInfo(s){
    s=Number(s)||0;
    if(s>=75) return {cat:'good', label:'Good', tip:'Generally safe for family use.'};
    if(s>=60) return {cat:'fair', label:'Fair', tip:'Borderline — prefer caution; avoid swimming if possible.'};
    return {cat:'poor', label:'Poor', tip:'Avoid direct use (no swimming/playing/drinking).'};
  }
  function getColors(){
    const light=document.documentElement.getAttribute('data-theme')==='light';
    return { axis: light?'#2a3342':'#c7d0dc', grid: light?'rgba(0,0,0,.08)':'rgba(255,255,255,.08)', keepUsing:'#60a5fa', avoidWater:'#34d399', haloGood:'#059669', haloFair:'#d97706', haloPoor:'#ef4444' };
  }

  /* ---------- Series helpers ---------- */
  function synthForecast48h(seedScore){
    const out=[], now=Date.now(), stepMs=6*60*60*1000;
    let base=isFinite(seedScore)?Number(seedScore):65;
    for(let i=0;i<=8;i++){
      const ts=new Date(now+i*stepMs).toISOString();
      base=Math.max(0,Math.min(100, base+(65-base)*0.08 + (Math.random()-0.5)*2));
      const keep=base;
      const avoid=Math.min(100, keep + 8*(1-Math.exp(-i/4)));
      out.push({ts, keep_using:keep, avoid_water:avoid});
    }
    return out;
  }
  function ensureTimestamps(series){
    const stepMs=6*60*60*1000, now=Date.now();
    const invalid=series.filter(p=>isNaN(parseTs(p.ts).getTime())).length;
    if(invalid>series.length/2){
      return series.map((p,i)=>({...p, ts:new Date(now+i*stepMs).toISOString()}));
    }
    return series.map(p=>{
      const d=parseTs(p.ts);
      return {...p, ts:isNaN(d.getTime()) ? new Date(now).toISOString() : new Date(d.getTime()).toISOString()};
    });
  }

  /* ---------- Chart ---------- */
  window.__ffChart=null; window.__ffThemeBound=false;

  function buildChart(series){
    function whenReady(cb){ if(window.Chart) cb(); else setTimeout(()=>whenReady(cb),60); }
    whenReady(function(){
      const C=getColors();
      const labels=series.map(p=>parseTs(p.ts).toLocaleString([], {year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit'}));
      const keep=series.map(p=>p.keep_using);
      const avoid=series.map(p=>p.avoid_water);
      const ctx=document.getElementById('ffChart'); if(!ctx) return;
      if(window.__ffChart){ window.__ffChart.destroy(); window.__ffChart=null; }

      const dsKeep={ label:'Keep Using', data:keep, borderColor:C.keepUsing, backgroundColor:C.keepUsing, pointRadius:c=>c.dataIndex===keep.length-1?5:2, tension:0.25, order:2 };
      const dsAvoid={ label:'Avoid Water', data:avoid, borderColor:C.avoidWater, backgroundColor:C.avoidWater, pointRadius:c=>c.dataIndex===avoid.length-1?5:2, tension:0.25, order:2 };

      const lastPointGlow={ id:'lastPointGlow', afterDatasetsDraw(chart){ const {ctx}=chart;
        [0,1].forEach(di=>{ if(!chart.isDatasetVisible(di)) return; const meta=chart.getDatasetMeta(di); const pt=meta.data[meta.data.length-1]; if(!pt) return;
          const color=di===0?C.keepUsing:C.avoidWater; ctx.save(); ctx.beginPath(); ctx.fillStyle=color; ctx.globalAlpha=.18; ctx.arc(pt.x,pt.y,14,0,Math.PI*2); ctx.fill(); ctx.restore(); });
      }};

      window.__ffChart=new Chart(ctx,{ type:'line', data:{ labels, datasets:[dsKeep, dsAvoid] }, options:{
        responsive:true, maintainAspectRatio:false, resizeDelay:150, animation:{duration:200},
        interaction:{mode:'nearest', intersect:false},
        plugins:{ legend:{display:false}, tooltip:{ callbacks:{
          title:(items)=>items[0]?items[0].label:'', label:(item)=>`${item.dataset.label} — Score: ${fmt(item.parsed.y)} (${scoreInfo(item.parsed.y).label})`,
          afterLabel:(item)=>' '+scoreInfo(item.parsed.y).tip } } },
        scales:{ y:{min:0,max:100,grid:{color:C.grid},ticks:{color:C.axis}}, x:{grid:{color:C.grid},ticks:{color:C.axis,maxRotation:0,autoSkip:true,maxTicksLimit:6}} }
      }, plugins:[lastPointGlow]});

      const btnKeep=document.getElementById('btnKeepUsing');
      const btnAvoid=document.getElementById('btnAvoidWater');
      function setPressed(btn,on){ btn && btn.setAttribute('aria-pressed', on?'true':'false'); }
      setPressed(btnKeep,true); setPressed(btnAvoid,true);
      if(btnKeep && !btnKeep.dataset.bound){ btnKeep.addEventListener('click',()=>{ const ch=window.__ffChart; if(!ch) return; ch.isKeep=!ch.isKeep; const on=ch.isKeep!==false; ch.setDatasetVisibility(0,on); setPressed(btnKeep,on); ch.update(); }); btnKeep.dataset.bound='1'; }
      if(btnAvoid && !btnAvoid.dataset.bound){ btnAvoid.addEventListener('click',()=>{ const ch=window.__ffChart; if(!ch) return; ch.isAvoid=!ch.isAvoid; const on=ch.isAvoid!==false; ch.setDatasetVisibility(1,on); setPressed(btnAvoid,on); ch.update(); }); btnAvoid.dataset.bound='1'; }

      if(!window.__ffThemeBound){
        window.addEventListener('themechange',()=>{ const ch=window.__ffChart; if(!ch) return; const C2=getColors();
          ch.options.scales.x.grid.color=C2.grid; ch.options.scales.y.grid.color=C2.grid;
          ch.options.scales.x.ticks.color=C2.axis; ch.options.scales.y.ticks.color=C2.axis;
          dsKeep.borderColor=dsKeep.backgroundColor=C2.keepUsing; dsAvoid.borderColor=dsAvoid.backgroundColor=C2.avoidWater; ch.update('none'); });
        window.__ffThemeBound=true;
      }
    });
  }

  /* ---------- Loading overlay with 3s auto-hide ---------- */
  const LOTTIE_JSON = "{% static 'Loading Lottie animation.json' %}";
  let lottieInstance = null;
  let __loadingTimer = null;

  function restoreSubmitButton(){
    const form = document.getElementById('forecast-form');
    const btn = form ? form.querySelector('button[type="submit"]') : null;
    if(btn){ btn.disabled = false; btn.removeAttribute('aria-disabled'); btn.innerText='Get forecast'; }
  }

  function hideLoadingOverlay(){
    const overlay = document.getElementById('loading-overlay');
    overlay.hidden = true;
    overlay.setAttribute('aria-hidden','true');
    if(lottieInstance){ try{ lottieInstance.stop(); }catch(e){} }
    if(__loadingTimer){ clearTimeout(__loadingTimer); __loadingTimer=null; }
    restoreSubmitButton();
  }

  function showLoadingOverlay(){
    const overlay = document.getElementById('loading-overlay');
    overlay.hidden = false;
    overlay.setAttribute('aria-hidden','false');

    const box = document.getElementById('lottie-box');
    function startLottie(){
      try{
        if(lottieInstance){ lottieInstance.play(); return; }
        if(!window.lottie) return;
        lottieInstance = lottie.loadAnimation({
          container: box, renderer:'svg', loop:true, autoplay:true, path: LOTTIE_JSON
        });
      }catch(e){}
    }
    startLottie();
    if(!lottieInstance && !window.lottie){
      let tries=0;
      const tm=setInterval(()=>{ tries++; startLottie(); if(lottieInstance || tries>20) clearInterval(tm); }, 100);
    }
    if(__loadingTimer){ clearTimeout(__loadingTimer); }
    __loadingTimer = setTimeout(hideLoadingOverlay, 3000);
  }

  /* ---------- Form bind + validation (SweetAlert2) ---------- */
  (function bindForm(){
    const form = document.getElementById('forecast-form');
    if(!form) return;

    function getSiteValue(){
      const sel = document.getElementById('site_id');
      if(!sel) return '';
      if(sel.tagName.toLowerCase()==='select'){
        return sel.value || '';
      }
      return (sel.value||'').trim();
    }
    function highlightAndScroll(){
      form.classList.add('attn');
      setTimeout(()=>form.classList.remove('attn'), 1800);
      const OFFSET = 120;
      const top = form.getBoundingClientRect().top + window.pageYOffset - OFFSET;
      window.scrollTo({ top, behavior:'smooth' });
      form.querySelector('#site_id')?.focus({preventScroll:true});
    }

    form.addEventListener('submit', function(e){
      const siteVal = getSiteValue();
      if(!siteVal){
        e.preventDefault();
        if(window.Swal){
          Swal.fire({
            title: 'Select a Site ID',
            text: 'Please choose a Site ID before requesting a forecast.',
            icon: 'warning',
            confirmButtonText: 'OK',
            confirmButtonColor: '#1E6FFF'
          }).then(highlightAndScroll);
        }else{
          alert('Please choose a Site ID before requesting a forecast.');
          highlightAndScroll();
        }
        return;
      }

      /* valid -> keep original behavior */
      const base = (form.getAttribute('action') || location.pathname).split('#')[0];
      form.setAttribute('action', base + '#safety');
      const btn = form.querySelector('button[type="submit"]');
      if(btn){ btn.disabled = true; btn.setAttribute('aria-disabled','true'); btn.innerText = 'Loading…'; }
      showLoadingOverlay();
    });

    /* Clear attention ring once user changes the field */
    const site = document.getElementById('site_id');
    if(site){
      site.addEventListener('change', ()=>form.classList.remove('attn'));
      site.addEventListener('input',  ()=>form.classList.remove('attn'));
    }

    window.addEventListener('pageshow', hideLoadingOverlay);
  })();

  /* ---------- GSAP droplets ---------- */
  (function initGSAPDrops(){
    function whenGSAP(cb){ if(window.gsap) cb(); else setTimeout(()=>whenGSAP(cb), 50); }
    whenGSAP(function(){
      const svgs = document.querySelectorAll('.gsap-drop .drop-svg');
      svgs.forEach((svg, i)=>{
        const grad = svg.querySelector('#dropGrad');
        const glow = svg.querySelector('#dropGlow');
        const blob = svg.querySelector('.drop-blob');
        const wrap = svg.querySelector('.drop-wrap');
        if(grad && blob){ const id='dropGrad-'+i; grad.id=id; blob.setAttribute('fill', `url(#${id})`); }
        if(glow && wrap){ const id='dropGlow-'+i; glow.id=id; wrap.setAttribute('filter', `url(#${id})`); }
      });

      gsap.utils.toArray('.gsap-drop .drop-wrap').forEach((el, idx)=>{
        gsap.to(el, { y:-2, duration:0.8 + (idx%3)*0.15, yoyo:true, repeat:-1, ease:'sine.inOut' });
      });
      gsap.utils.toArray('.gsap-drop .drop-blob').forEach((el, idx)=>{
        gsap.to(el, { transformOrigin:'50% 80%', scaleY:1.65, scaleX:0.92, duration:1.15 + (idx%3)*0.12, yoyo:true, repeat:-1, ease:'sine.inOut' });
      });
      gsap.utils.toArray('.gsap-drop radialGradient').forEach((g, idx)=>{
        gsap.to(g, { attr:{ cy:'55%' }, duration:1.6 + (idx%3)*0.1, yoyo:true, repeat:-1, ease:'sine.inOut' });
      });
    });
  })();

  /* ---------- Water UI (values coloring only) ---------- */
  function waterData(){
    const el=document.getElementById('ff-result');
    const d=el?JSON.parse(el.textContent||'{}'):{};
    return {
      ph:  d?.predictions?.pH ?? null,
      ec:  d?.predictions?.EC_uS_cm ?? null,
      dox: d?.predictions_raw?.DO_mg_L ?? null,
      orp: d?.predictions_raw?.redox_mV ?? null
    };
  }
  function waterBadge(metric, v){
    if(metric==='ph'){
      if(v>=6.5 && v<=8.5) return ['ok','Within typical range (6.5–8.5)'];
      if(v<6.0 || v>8.5)  return ['bad','Outside safe range'];
      return ['warn','Slightly off neutral'];
    }
    if(metric==='ec'){
      if(v<1500) return ['ok','Low salinity'];
      if(v<5000) return ['warn','Moderate salts'];
      return ['bad','Very high salts'];
    }
    if(metric==='do'){
      if(v>5) return ['ok','Well-oxygenated'];
      if(v>=3) return ['warn','Borderline'];
      return ['bad','Low oxygen'];
    }
    if(v>=200 && v<=600) return ['ok','Typical treated water'];
    if(v<0) return ['bad','Reducing (possible contamination)'];
    return ['warn','Atypical'];
  }
  function waterExplain(metric, v){
    if(metric==='ph'){ return [
      'Skin: slightly alkaline water can feel drying after long exposure.',
      'Drinking: values in 6.5–8.5 are generally fine.',
      'Very low/high pH may indicate corrosion or residual soaps.'
    ];}
    if(metric==='ec'){ return [
      'Higher EC = more salts/minerals dissolved.',
      'Drinking: very high EC can burden kidneys; avoid if > 5,000 µS/cm.',
      'Skin: salty water can worsen dryness/itch, especially with wounds.'
    ];}
    if(metric==='do'){ return [
      'Low dissolved oxygen often indicates organic load or stagnation.',
      'Not directly harmful when drinking, but signals poorer quality.',
      'For bathing, low-DO waters may host more bacteria—be cautious.'
    ];}
    return [
      '200–600 mV is common for safe, oxidizing conditions.',
      'Near 0 or negative can mean low oxygen and potential bacterial growth.',
      'May cause smell/film; sensitive skin can feel less “fresh”.'
    ];
  }
  function waterFormat(metric, v){
    if(v==null || isNaN(v)) return '—';
    if(metric==='ph') return Number(v).toFixed(2);
    if(metric==='ec') return String(Math.round(Number(v)));
    if(metric==='do') return Number(v).toFixed(2);
    if(metric==='orp') return String(Math.round(Number(v)));
    return String(v);
  }
  function paintValue(el, status){
    if(!el) return;
    el.classList.remove('grad-red','grad-yellow','grad-green');
    el.classList.add(status==='ok' ? 'grad-green' : (status==='warn' ? 'grad-yellow' : 'grad-red'));
  }
  function initWaterUI(){
    const vals=waterData();
    const $=id=>document.getElementById(id);
    if(!$('water-val-ph')) return;

    $('water-val-ph').textContent  = waterFormat('ph',  vals.ph);
    $('water-val-ec').textContent  = waterFormat('ec',  vals.ec);
    $('water-val-do').textContent  = waterFormat('do',  vals.dox);
    $('water-val-orp').textContent = waterFormat('orp', vals.orp);

    paintValue($('water-val-ph'),  waterBadge('ph',  Number(vals.ph ))[0]);
    paintValue($('water-val-ec'),  waterBadge('ec',  Number(vals.ec ))[0]);
    paintValue($('water-val-do'),  waterBadge('do',  Number(vals.dox))[0]);
    paintValue($('water-val-orp'), waterBadge('orp', Number(vals.orp))[0]);

    const tiles=document.querySelectorAll('.water-tile');
    const title=$('water-panel-title');
    const measured=$('water-panel-measured');
    const badge=$('water-panel-badge');
    const list=$('water-panel-list');

    function select(metric){
      tiles.forEach(t=>t.classList.toggle('is-active', t.dataset.waterMetric===metric));
      const value = metric==='ph'?vals.ph : metric==='ec'?vals.ec : metric==='do'?vals.dox : vals.orp;
      const b=waterBadge(metric, Number(value));
      const bullets=waterExplain(metric, Number(value));
      title.textContent = { ph:'pH (acid/alkaline)', ec:'EC (electrical conductivity)', do:'DO (dissolved oxygen)', orp:'Redox (oxidation–reduction potential)' }[metric];
      measured.textContent = `Measured ~ ${waterFormat(metric==='do'?'do':metric, value)}${metric==='ec'?' µS/cm':metric==='do'?' mg/L':metric==='orp'?' mV':''}`;
      badge.innerHTML = `<span class="water-badge ${b[0]}">${b[1]}</span>`;
      list.innerHTML = bullets.map(x=>`<li>${x}</li>`).join('');
    }
    tiles.forEach(t=> t.addEventListener('click', ()=>select(t.dataset.waterMetric)));
    select('ph');
  }

  /* ---------- Page init ---------- */
  window.pageInit=function(){
    try{
      const resultScript=document.getElementById('ff-result');
      const data=resultScript?JSON.parse(resultScript.textContent||"{}"):null;

      if(data && data.quality){
        let score=Number(data.quality.score||0); if(!isFinite(score)) score=0; score=Math.max(0,Math.min(100,score));
        const ptr=document.getElementById('ff-pointer');
        const lbl=document.getElementById('ff-pointer-label');
        const glow=document.getElementById('ff-glow');
        if(ptr) ptr.style.left=score+'%';
        if(glow) glow.style.left=score+'%';
        if(lbl){
          const info=scoreInfo(score);
          lbl.textContent=String(data.quality.category || info.cat);
          const C=getColors();
          const col=info.cat==='good'?C.haloGood:info.cat==='fair'?C.haloFair:C.haloPoor;
          if(glow) glow.style.setProperty('--glow', col);
        }
        const el=document.getElementById('kpi-score');
        if(el){
          el.textContent = '0.00';
          const target=Number(score.toFixed(2)); let t0=null;
          function step(ts){ if(!t0) t0=ts; const p=Math.min(1,(ts-t0)/1000); el.textContent=(target*p).toFixed(2); if(p<1) requestAnimationFrame(step); }
          requestAnimationFrame(step);
        }
      }

      let series = (data && Array.isArray(data.forecast_48h) && data.forecast_48h.length)
        ? data.forecast_48h.map(p=>({ ts:p.ts||p.timestamp||p.time||p.date, keep_using:p.do_nothing??p.doNothing??p.base??p.keep_using, avoid_water:p.take_action??p.takeAction??p.action??p.avoid_water }))
        : synthForecast48h(data && data.quality ? data.quality.score : 65);
      series = ensureTimestamps(series);
      buildChart(series);

      initWaterUI();

      if (location.hash === '#safety'){
        const target = document.getElementById('safety');
        if (target){
          const OFFSET = 220;
          setTimeout(()=>{
            const top = target.getBoundingClientRect().top + window.pageYOffset - OFFSET;
            window.scrollTo({ top, behavior:'smooth' });
            target.focus({preventScroll:true});
          }, 80);
        }
      }
    }catch(e){}
  };

  (function ensureInit(){
    function run(){ if(typeof window.pageInit==='function') window.pageInit(); }
    if(document.readyState==='complete' || document.readyState==='interactive') { setTimeout(run,0); }
    else { window.addEventListener('DOMContentLoaded', run); }
    window.addEventListener('pageshow', run);
  })();
</script>
{% endblock %}
