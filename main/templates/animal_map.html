{% extends "base.html" %}
{% load static %}

{% block title %}Animal Map | Water & Sanitation{% endblock %}

{% block head_extras %}
<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"/>

<style>
  :root { --am-card-bg:#fff; --am-text:#111; --am-muted:#555; --am-border:#ddd; }
  :root[data-theme="dark"] { --am-card-bg:#0f172a; --am-text:#e5e7eb; --am-muted:#94a3b8; --am-border:#334155; }

  .am-shell{max-width:1200px;margin:0 auto;padding:0 14px;}
  .am-section{margin-bottom:30px;}
  .am-card{
    background:var(--am-card-bg); color:var(--am-text);
    border:1px solid var(--am-border); border-radius:14px;
    padding:18px; box-shadow:0 2px 10px rgba(0,0,0,.08);
  }
  .am-card h2{margin:0 0 8px;font-size:1.3rem;}
  .am-muted{color:var(--am-muted);}

  .am-split{display:grid;grid-template-columns:minmax(0,1fr) 340px;gap:14px;}
  @media(max-width:1000px){.am-split{grid-template-columns:1fr}}

  .am-map{width:100%;height:500px;border-radius:12px;background:#eef;}
  .am-aside{
    border:1px solid var(--am-border); border-radius:12px; padding:10px;
    background:var(--am-card-bg); overflow:auto; max-height:520px; position:sticky; top:12px;
  }
  .am-aside h3{font-size:1rem;margin:0 0 8px;}
  .am-gallery{display:flex;flex-direction:column;gap:10px;}

  .am-figure{
    cursor:pointer; display:flex; align-items:center; gap:12px;
    padding:8px; border-radius:8px; border:1px solid transparent; color:var(--am-text);
    background:transparent;
  }
  .am-figure:hover{background:rgba(0,0,0,0.05); border-color:var(--am-border);}
  :root[data-theme="dark"] .am-figure:hover{background:rgba(255,255,255,0.05);}
  .am-figure img{display:block; max-width:140px; height:auto; object-fit:contain}

  .am-toolbar{display:flex;flex-wrap:wrap;gap:8px;margin:10px 0;align-items:center;}
  .am-select{
    border:1px solid var(--am-border); border-radius:8px;
    padding:8px 10px; min-width:220px; background:var(--am-card-bg); color:var(--am-text);
  }
  .am-btn{
    border:1px solid var(--am-border); background:var(--am-card-bg);
    padding:8px 10px; border-radius:8px; cursor:pointer; color:var(--am-text);
  }
  .am-btn:hover{filter:brightness(1.05);}
  .am-count{margin-left:auto; color:var(--am-muted); font-size:.9rem;}

  .am-quest{
    display:flex; align-items:center; gap:10px;
    padding:6px 10px; border:1px dashed var(--am-border);
    border-radius:10px; background:var(--am-card-bg);
  }
  .am-quest .am-bar{ width:160px; height:10px; background:#e5e7eb; border-radius:6px; overflow:hidden;}
  :root[data-theme="dark"] .am-quest .am-bar{ background:#1f2937; }
  .am-quest .am-bar > i{ display:block; height:100%; width:0%; background:#34d399; }

  .am-popup{ max-width:300px; }
  .am-popup img{ width:100%; height:auto; border-radius:12px; margin-bottom:8px; }
  .am-popup h4{ margin:0 0 6px; font-size:1.2rem; line-height:1.3; }
  .am-popup p{ margin:2px 0; font-size:1rem; line-height:1.25; }
  .am-popup p.small{ font-size:.95rem; opacity:.9; }

  .am-toast{
    position:fixed; left:50%; top:16px; transform:translateX(-50%);
    background:#111; color:#fff; padding:10px 14px; border-radius:10px;
    z-index:9999; opacity:.95; box-shadow:0 4px 12px rgba(0,0,0,.25);
  }

  /* Popup-open short glow */
  .am-glow{ filter: drop-shadow(0 0 6px #22d3ee); animation: amPulse 1.2s ease-in-out 1; }
  @keyframes amPulse{ 0%{transform:scale(1);opacity:1}50%{transform:scale(1.08);opacity:.9}100%{transform:scale(1);opacity:1}}

  /* ---- NEW: sparkle + gentle bounce (margin-top animation, so it won't fight Leaflet's transform) ---- */
  .leaflet-marker-icon.am-sparkle{
    filter: drop-shadow(0 0 8px rgba(34,211,238,.95)) drop-shadow(0 0 14px rgba(59,130,246,.55));
    animation: amBounce 1.1s ease-in-out 1;
  }
  @keyframes amBounce{
    0%,100%{ margin-top:0; }
    35%{ margin-top:-6px; }
    70%{ margin-top:-2px; }
  }
</style>
{% endblock %}

{% block content %}
<section class="am-shell am-section">
  <div class="am-card">
    <h2>Animal Sightings Map</h2>
    <p class="am-muted">Look! Find animals near the water.</p>

    <div class="am-toolbar">
      <select id="am-select" class="am-select" aria-label="Choose animal">
        <option value="">Choose animal…</option>
      </select>

      <button id="am-reload" class="am-btn" type="button">Reload</button>
      <button id="am-clear-view" class="am-btn" type="button" title="Reset view">Clear View</button>
      <button id="am-reset-score" class="am-btn" type="button" title="Reset your score">Reset Score</button>

      <div id="am-quest" class="am-quest" aria-live="polite">
        ⭐ Found <b id="am-found">0</b> species —
        Score <b id="am-score">0</b>/100
        <div class="am-bar"><i id="am-bar"></i></div>
        <span id="am-milestone" class="am-muted" style="font-size:.9rem;">Score milestones: 25 / 50 / 75 / 100</span>
      </div>

      <span id="am-count" class="am-count" aria-live="polite"></span>
    </div>

    <div class="am-split">
      <div>
        <div id="am-map" class="am-map" role="region" aria-label="Animal sightings map"></div>
        <p id="am-empty" class="am-muted" style="text-align:center;display:none;">No animals found.</p>
        <p id="am-loading" class="am-muted" style="text-align:center;">Loading…</p>
      </div>
      <aside class="am-aside">
        <h3>All Animals <span id="am-gallery-count" class="am-muted"></span></h3>
        <div id="am-gallery" class="am-gallery"></div>
      </aside>
    </div>
  </div>
</section>
{% endblock %}

{% block page_scripts %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
<script>
/* -------------------------- DOM refs -------------------------- */
const $ = (id) => document.getElementById(id);
const els = {
  map: $("am-map"),
  select: $("am-select"),
  reload: $("am-reload"),
  clearView: $("am-clear-view"),
  resetScore: $("am-reset-score"),
  empty: $("am-empty"),
  loading: $("am-loading"),
  count: $("am-count"),
  gallery: $("am-gallery"),
  gcount: $("am-gallery-count"),
  found: $("am-found"),
  score: $("am-score"),
  bar: $("am-bar"),
};

/* -------------------------- Map & state -------------------------- */
let leafletMap, clusterLayer, allItems = [], galleryAll = [];
let totalSpecies = 35;
const speciesFirstMarker = new Map();
let defaultCenter = [-37.8,145], defaultZoom = 7;

/* Temp layers */
let lineUpLayer = null;

/* -------------------------- Persistence -------------------------- */
const LS_DISC    = "am_discovered_v2";
const LS_SCORE_M = "am_score_milestones_v1";
let discovered = new Set(JSON.parse(localStorage.getItem(LS_DISC) || "[]"));
let scoreMilestonesDone = new Set(JSON.parse(localStorage.getItem(LS_SCORE_M) || "[]"));
function saveProgress(){
  localStorage.setItem(LS_DISC, JSON.stringify([...discovered]));
  localStorage.setItem(LS_SCORE_M, JSON.stringify([...scoreMilestonesDone]));
}

/* -------------------------- Score helpers -------------------------- */
function computeScore(){ if(!totalSpecies) return 0; return Math.round(Math.min(100,(discovered.size/totalSpecies)*100)); }
function updateQuestUI(){ els.found.textContent = discovered.size; const s=computeScore(); els.score.textContent=s; els.bar.style.width=s+"%"; }
const SCORE_MILESTONES=[25,50,75,100];
function checkScoreMilestones(){
  const s = computeScore();
  SCORE_MILESTONES.forEach(m=>{
    if(s>=m && !scoreMilestonesDone.has(m)){
      scoreMilestonesDone.add(m);
      Swal.fire({title:(m===100)?"Amazing! 100/100!":`Great job — ${m} points!`,
                 text:(m===100)?"You found them all. You're a Water Hero!":"Keep going! Can you reach the next badge?",
                 icon:"success",confirmButtonText:"OK",draggable:true});
    }
  });
  saveProgress();
}

/* -------------------------- Kid copy -------------------------- */
const ONE_LINERS={ "bottlenose dolphin":"I leap high!", "eastern blue groper":"Big blue pal",
"eastern fiddler ray":"Striped ray", "eastern king prawn":"Swift swimmer", "eastern rock lobster":"Spiky pal",
"giant cuttlefish":"Colour magic!", "green turtle":"Gentle diver", "grey morwong":"Calm swimmer",
"leatherback turtle":"Ocean giant", "loggerhead turtle":"Strong shell", "luderick":"Sea grazer",
"mosaic leatherjacket":"Funny jacket", "old wife":"Two spines!", "onespot puller":"One spot hero",
"pacific ridley turtle":"Little rider", "red morwong":"Red stripes", "red velvetfish":"Velvet fins",
"rock blackfish":"Rock shadow", "rock cale":"Rock grazer", "scissortail sergeant":"Snip-tail!",
"sergeant baker":"Long swimmer", "short boarfish":"Short snout", "silver drummer":"Silver flash",
"snapper":"Pink spiky", "southern fiddler ray":"Spotty ray", "southern maori wrasse":"Curvy lines",
"southern right whale":"Gentle giant", "spotted grubfish":"Dotty friend", "tiger shark":"Big stripes",
"warty prowfish":"Bumpy body", "western blue groper":"Big blue pal", "whiskered prowfish":"Whisker fins",
"whitebarred boxfish":"Boxy body", "white-ear":"White ear dot", "yellow-bellied seasnake":"Yellow belly" };
const HABITATS={ "bottlenose dolphin":"bays and open seas","southern right whale":"cold southern waters",
"tiger shark":"coastal and offshore seas","green turtle":"bays and seagrass beds","leatherback turtle":"open ocean",
"loggerhead turtle":"bays and reefs","pacific ridley turtle":"warm currents and bays","eastern fiddler ray":"sandy bays",
"southern fiddler ray":"sandy bays","giant cuttlefish":"reefs and seagrass","eastern rock lobster":"rocky reefs",
"eastern king prawn":"estuaries and sandy bottoms","eastern blue groper":"rocky reefs","western blue groper":"rocky reefs",
"grey morwong":"reefs","red morwong":"reefs","rock blackfish":"reefs","rock cale":"reefs and weed beds",
"luderick":"estuaries and seagrass","mosaic leatherjacket":"reefs and weed beds","old wife":"reefs","onespot puller":"reefs",
"red velvetfish":"reefs","scissortail sergeant":"reefs","sergeant baker":"sandy reefs","short boarfish":"reefs",
"silver drummer":"surf reefs","snapper":"bays and reefs","southern maori wrasse":"reefs","spotted grubfish":"sandy bottoms",
"warty prowfish":"weed reefs","whiskered prowfish":"weed reefs","whitebarred boxfish":"reefs and seagrass",
"white-ear":"rocky reefs","yellow-bellied seasnake":"offshore waters" };
const normName=(n)=> (n||"").toString().trim().toLowerCase();
function popupHtml(it){
  const name = it.common_name || "Unknown";
  const key  = normName(name);
  const line = ONE_LINERS[key] || "I love clean seas.";
  const home = HABITATS[key]   || "bays and reefs";
  const photo = it.photo_url || it.icon_url || "";
  return `<div class="am-popup">${photo?`<img src="${photo}" alt="${name}" loading="lazy"/>`:""}
      <h4>${name}</h4><p><strong>${line}</strong></p><p class="small">I live in <em>${home}</em>.</p></div>`;
}

/* -------------------------- Clusters (SPIDERFY enabled) -------------------------- */
const CLUSTER_OPTS = {
  showCoverageOnHover:false,
  zoomToBoundsOnClick:false,
  spiderfyOnEveryClick:true,
  spiderfyOnMaxZoom:true,
  spiderfyDistanceMultiplier:1.4,
  spiderLegPolylineOptions:{weight:1.5,opacity:0.9,color:'#22d3ee'},
  maxClusterRadius:70, chunkedLoading:true, removeOutsideVisibleBounds:true
};

function initMap(meta){
  if(!leafletMap){
    const center=(meta&&meta.victoria_coords)||defaultCenter;
    const z=(meta&&meta.default_zoom)||defaultZoom;
    defaultCenter=center.slice?center.slice():center; defaultZoom=z;
    leafletMap=L.map("am-map",{doubleClickZoom:false}).setView(defaultCenter,defaultZoom);
    L.tileLayer((meta&&meta.tile_url)||"https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
                {attribution:(meta&&meta.tile_attribution)||"© OpenStreetMap"}).addTo(leafletMap);
    leafletMap.on("zoomstart", clearTempViews);
    leafletMap.on("movestart", clearTempViews);
  }
  if(clusterLayer){ clusterLayer.clearLayers(); if(leafletMap.hasLayer(clusterLayer)) leafletMap.removeLayer(clusterLayer); }
  clusterLayer=L.markerClusterGroup(CLUSTER_OPTS).addTo(leafletMap);
}

/* -------------------------- Discovery on popup -------------------------- */
function attachDiscoveryOnPopup(marker,name){
  marker.on("popupopen", ()=>{
    const el=marker._icon||(marker.getElement&&marker.getElement());
    if(el){ el.classList.add("am-glow"); setTimeout(()=>el.classList.remove("am-glow"),1200); }
    const cname=(name||"").trim();
    if(cname && !discovered.has(cname)){
      discovered.add(cname); saveProgress(); updateQuestUI(); checkScoreMilestones();
      const t=document.createElement("div"); t.className="am-toast"; t.textContent=`+1 Found: ${cname}`;
      document.body.appendChild(t); setTimeout(()=>t.remove(),1200);
    }
  });
}

/* -------------------------- Markers (cluster layer) -------------------------- */
function renderMarkers(items){
  clusterLayer.clearLayers(); speciesFirstMarker.clear();
  const seenFirst=new Set(); const markers=[];
  items.forEach(it=>{
    const lat=Number(it.latitude), lon=Number(it.longitude);
    if(Number.isNaN(lat)||Number.isNaN(lon)) return;
    const opts = it.icon_url ? {icon:L.icon({iconUrl:it.icon_url, iconSize:[40,40]})} : undefined;
    const m=L.marker([lat,lon],opts).bindPopup(popupHtml(it),{maxWidth:320,keepInView:true,autoPan:true});
    attachDiscoveryOnPopup(m, it.common_name);
    const sp=(it.common_name||"").trim();
    if(sp && !seenFirst.has(sp)){ seenFirst.add(sp); speciesFirstMarker.set(sp,m); }
    markers.push(m);
  });
  if(markers.length){ clusterLayer.addLayers(markers); els.empty.style.display="none"; }
  else { els.empty.style.display="block"; }
  els.count.textContent = markers.length + " found";
}

/* -------------------------- Line-Up (per species) + sparkle/bounce -------------------------- */
const LINE_UP_SPACING=0.003, LINE_UP_LAT_SHIFT=0.0;
function clearLineUp(){ if(!leafletMap) return; if(lineUpLayer && leafletMap.hasLayer(lineUpLayer)) leafletMap.removeLayer(lineUpLayer); lineUpLayer=null; if(clusterLayer && !leafletMap.hasLayer(clusterLayer)) leafletMap.addLayer(clusterLayer); }

/* Make icons bigger & animate */
function sparkleMarkers(markers){
  setTimeout(()=>{
    markers.forEach(m=>{
      const el = m._icon || (m.getElement && m.getElement());
      if(el){ el.classList.add("am-sparkle"); setTimeout(()=>el.classList.remove("am-sparkle"),1200); }
    });
  },30);
}

function lineUpSpecies(name){
  const matches=allItems.filter(it=>it.common_name===name);
  if(!matches.length) return;

  clearLineUp();
  if(leafletMap.hasLayer(clusterLayer)) leafletMap.removeLayer(clusterLayer);

  const lats=[], lons=[];
  matches.forEach(it=>{
    const la=Number(it.latitude), lo=Number(it.longitude);
    if(!Number.isNaN(la)&&!Number.isNaN(lo)){ lats.push(la); lons.push(lo); }
  });
  const avgLat=lats.reduce((a,b)=>a+b,0)/lats.length || defaultCenter[0];
  const avgLon=lons.reduce((a,b)=>a+b,0)/lons.length || defaultCenter[1];

  const n=matches.length;
  const start=avgLon-((n-1)*LINE_UP_SPACING/2);
  const tempMarkers=[];
  matches.forEach((it,i)=>{
    const lat=avgLat + (i-(n-1)/2)*LINE_UP_LAT_SHIFT;
    const lon=start + i*LINE_UP_SPACING;

    // HIGHLIGHT: use bigger icon for lineup (looks "放大")
    const opts = it.icon_url
      ? { icon:L.icon({iconUrl:it.icon_url, iconSize:[60,60]}) }  // bigger than normal
      : undefined;

    const m=L.marker([lat,lon],opts).bindPopup(popupHtml(it),{maxWidth:320,keepInView:true});
    attachDiscoveryOnPopup(m, it.common_name);
    tempMarkers.push(m);
  });

  lineUpLayer=L.layerGroup(tempMarkers).addTo(leafletMap);
  sparkleMarkers(tempMarkers); // glow + gentle bounce

  const bounds=lineUpLayer.getBounds();
  leafletMap.fitBounds(bounds,{padding:[30,30]});
  setTimeout(()=>{ tempMarkers[0] && tempMarkers[0].openPopup(); },250);
}

/* -------------------------- Gallery & Select -------------------------- */
function buildGallery(payload){
  const raw=Array.isArray(payload.gallery)?payload.gallery:[];
  if(raw.length) return raw;
  const seen=new Set(), list=[];
  (payload.items||[]).forEach(it=>{
    const name=it.common_name||"Unknown";
    const key=name+"||"+(it.icon_url||"");
    if(seen.has(key)) return; seen.add(key);
    list.push({common_name:name, icon_url:it.icon_url||"", photo_url:it.photo_url||""});
  });
  return list;
}
function renderGallery(gallery){
  galleryAll=Array.isArray(gallery)?gallery:[];
  galleryAll.sort((a,b)=>(a.common_name||"").localeCompare(b.common_name||"",undefined,{sensitivity:"base"}));
  els.gallery.innerHTML=""; els.select.innerHTML='<option value="">Choose animal…</option>';
  galleryAll.forEach(g=>{
    const opt=document.createElement("option"); opt.value=g.common_name; opt.textContent=g.common_name; els.select.appendChild(opt);
    const row=document.createElement("button"); row.type="button"; row.className="am-figure";
    row.innerHTML=`<img src="${g.icon_url || g.photo_url}" alt="${g.common_name}" loading="lazy"/><div><strong>${g.common_name}</strong></div>`;
    row.onclick=()=> lineUpSpecies(g.common_name);
    els.gallery.appendChild(row);
  });
  totalSpecies = galleryAll.length || totalSpecies;
  $("am-gallery-count").textContent = totalSpecies ? `(${totalSpecies})` : "";
  updateQuestUI();
}

/* -------------------------- Data loading -------------------------- */
async function loadData(){
  els.loading.style.display="block"; els.empty.style.display="none";
  try{
    const res=await fetch("{% url 'animal_map_data' %}");
    const payload=await res.json();
    allItems=Array.isArray(payload.items)?payload.items:[];
    initMap(payload.meta||{}); clearTempViews(); renderMarkers(allItems);
    const gallery=buildGallery(payload); renderGallery(gallery); updateQuestUI();
  }catch(e){ console.error("animal_map_data failed:",e); els.empty.style.display="block"; }
  els.loading.style.display="none";
}

/* -------------------------- Events -------------------------- */
function clearTempViews(){ clearLineUp(); }
function bindEvents(){
  els.select.onchange=()=>{ const name=els.select.value; if(!name) return; lineUpSpecies(name); };
  els.clearView.onclick=()=>{ if(leafletMap) leafletMap.closePopup(); clearTempViews(); if(leafletMap) leafletMap.setView(defaultCenter,defaultZoom); };
  els.reload.onclick=()=> loadData();
  els.resetScore.onclick=async ()=>{
    const r=await Swal.fire({title:"Reset your score?",text:"This will clear your discovered animals.",icon:"warning",
                             showCancelButton:true,confirmButtonText:"Yes, reset",cancelButtonText:"No",draggable:true});
    if(r.isConfirmed){ discovered=new Set(); scoreMilestonesDone=new Set(); saveProgress(); updateQuestUI();
      Swal.fire({title:"All set!",text:"Score is back to 0. Have fun!",icon:"success",draggable:true}); }
  };
}

/* -------------------------- Boot -------------------------- */
window.pageInit=function(){ bindEvents(); updateQuestUI(); loadData(); };
document.addEventListener("DOMContentLoaded", window.pageInit);
</script>
{% endblock %}
